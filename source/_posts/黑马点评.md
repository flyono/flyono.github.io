---
title: é»‘é©¬ç‚¹è¯„
cover: https://th.bing.com/th/id/OIG.uUIFy_Hz_gxZ0Xkb.itY?pid=ImgGn
date: 2023å¹´5æœˆ23æ—¥22:11:20
type: "categories"
---

# é»‘é©¬ç‚¹è¯„

## 1.çŸ­ä¿¡ç™»å½•

---

### ğŸ‘Œæ•°æ®åº“æ„å»º

å¯¼å…¥å‡†å¤‡å¥½çš„ [hmdp.sql](hmdp.sql) æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹

| è¡¨å             | æè¿°                       |
| :--------------- | :------------------------- |
| tb_user          | ç”¨æˆ·è¡¨                     |
| tb_user_info     | ç”¨æˆ·è¯¦æƒ…è¡¨                 |
| tb_shop          | å•†æˆ·ä¿¡æ¯è¡¨                 |
| tb_shop_type     | å•†æˆ·ç±»å‹è¡¨                 |
| tb_blog          | ç”¨æˆ·æ—¥è®°è¡¨ï¼ˆè¾¾äººæ¢åº—æ—¥è®°ï¼‰ |
| tb follow        | ç”¨æˆ·å…³æ³¨è¡¨                 |
| tb voucher       | ä¼˜æƒ åˆ¸è¡¨                   |
| tb_voucher order | ä¼˜æƒ åˆ¸çš„è®¢å•è¡¨             |

---

### ğŸ‘Œæ•´ä½“æ¶æ„

![image-20230414214832837](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230414214832837.png)

---

### ğŸ‘Œå¯¼å…¥åç«¯é¡¹ç›®

ä¿®æ”¹ç›¸åº”é…ç½®åï¼Œå¯åŠ¨é¡¹ç›®æµè§ˆå™¨è®¿é—®http://localhost:8081/shop-type/list å‡ºç°æ•°æ®åˆ™æ²¡æœ‰é—®é¢˜

---

### ğŸ‘Œå¯¼å…¥å‰ç«¯é¡¹ç›®

æä¾›çš„èµ„æ–™ä¸­`nginx`ç›®å½•éƒ¨ç½²æˆ‘ä»¬éœ€è¦çš„å‰ç«¯é¡µé¢

**è¿è¡Œå‰ç«¯é¡¹ç›®**

åœ¨`nginx`æ‰€åœ¨ç›®å½•ä¸‹æ‰“å¼€ä¸€ä¸ªCMDçª—å£ï¼Œè¾“å…¥å‘½ä»¤ï¼š

```shell
start nginx.exe
```

æµè§ˆå™¨æ‰“å¼€æ‰‹æœºç«¯å¼€å‘è€…å·¥å…·

![image-20230414221615537](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230414221615537.png)

---

### ğŸ‘ŒåŸºäºSessionå®ç°ç™»å½•

---

#### å‘é€éªŒè¯ç åŠŸèƒ½

**æµç¨‹å›¾**

```mermaid
%% å‘é€çŸ­ä¿¡éªŒè¯ç 
graph LR
A((å¼€å§‹)) --> B[æäº¤æ‰‹æœºå·];
B --> C{æ ¡éªŒæ‰‹æœºå·} --> |ä¸ç¬¦åˆ|B
C --> |ç¬¦åˆ|D[ç”ŸæˆéªŒè¯ç ] --> E[ä¿å­˜éªŒè¯ç åˆ°Session] --> F[å‘é€éªŒè¯ç ] --> G((ç»“æŸ))
```

```java
@Override
public Result sendCode(String phone, HttpSession session) {
    //1,æ ¡éªŒæ‰‹æœºå·
    if (RegexUtils.isPhoneInvalid(phone)) {
        //2,å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
        return Result.fail("æ‰‹æœºå·æ ¼å¼é”™è¯¯");
    }
    //3,ç¬¦åˆï¼Œç”ŸæˆéªŒè¯ç 
    String code = RandomUtil.randomNumbers(6);
    //4,ä¿å­˜éªŒè¯ç åˆ°session
    session.setAttribute("code",code);
    //5.å‘é€éªŒè¯ç 
    log.debug("å‘é€çŸ­ä¿¡éªŒè¯ç æˆåŠŸï¼ŒéªŒè¯ç ï¼š{}",code);
    return Result.ok(code);
}
```

---

#### çŸ­ä¿¡éªŒè¯ç ç™»å½•å’Œæ³¨å†ŒåŠŸèƒ½

**æµç¨‹å›¾**

```mermaid
%% å‘é€çŸ­ä¿¡éªŒè¯ç 
graph LR
A((å¼€å§‹)) --> B[æäº¤æ‰‹æœºå·å’ŒéªŒè¯ç ];
B --> C{æ ¡éªŒéªŒè¯ç } --> |ä¸ä¸€è‡´|B
C --> |ä¸€è‡´|D[æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·] --> E[ç”¨æˆ·æ˜¯å¦å­˜åœ¨] --> |ä¸å­˜åœ¨|F[åˆ›å»ºæ–°ç”¨æˆ·] --> G[ä¿å­˜ç”¨æˆ·åˆ°æ•°æ®åº“] --> H
E --> |å­˜åœ¨|H[ä¿å­˜ç”¨æˆ·åˆ°Session] --> I((ç»“æŸ))
```

---

```java
@Override
public Result login(LoginFormDTO loginForm, HttpSession session) {
    //1.æ ¡éªŒæ‰‹æœºå·
    String phone = loginForm.getPhone();
    if (session.getAttribute(phone) == null) {
        //2,å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
        return Result.fail("æ‰‹æœºå·æ ¼å¼é”™è¯¯");
    }
    //2.æ ¡éªŒéªŒè¯ç 
    String cacheCode = loginForm.getCode();
    if (cacheCode == null || !session.getAttribute(phone).equals(cacheCode)) {
        //3.ä¸ä¸€è‡´ï¼ŒæŠ¥é”™
        return Result.fail("éªŒè¯ç é”™è¯¯");
    }
    //4.ä¸€è‡´ï¼Œæ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·
    User user = this.query().eq("phone", phone).one();
    //5.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    if (user == null) {
        //6.ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·å¹¶ä¿å­˜
        user = saveUserWithPhone(phone);
    }
    //7.ä¿å­˜ç”¨æˆ·ä¿¡æ¯å­™sessionä¸­
    session.setAttribute("user",user);

    return Result.ok();
}
// ä¿å­˜ç”¨æˆ·æ–¹æ³•
private User saveUserWithPhone(String phone) {
    //1.åˆ›å»ºç”¨æˆ·
    User user = new User();
    user.setPhone(phone);
    user.setNickName(USER_NICK_NAME_PREFIX+RandomUtil.randomString(10));
    //2.ä¿å­˜ç”¨æˆ·
    this.save(user);
    return user;
}
```

---

#### ç™»å½•éªŒè¯ / éšè—ç”¨æˆ·æ•æ„Ÿä¿¡æ¯

**æµç¨‹å›¾**

```mermaid
graph LR
A((å¼€å§‹)) --> B[è¯·æ±‚å¹¶æºå¸¦cookie] --> C[ä»sessionè·å–ç”¨æˆ·] --> D{åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨} --> |å­˜åœ¨|E[ä¿å­˜ç”¨æˆ·åˆ°ThreadLocal]
D --> |ä¸å­˜åœ¨|F[æ‹¦æˆª] --> G((ç»“æŸ))
```

---

```java
/**
 * ç™»å½•æ‹¦æˆªå™¨
 */
public class LoginInterceptor implements HandlerInterceptor {

/**
 * å‰ç½®æ‹¦æˆªå™¨
 */
@Override
public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
    //1.è·å–session
    HttpSession session = request.getSession();
    //2.è·å–sessionä¸­çš„ç”¨æˆ·
    Object user = session.getAttribute("user");
    //3.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    if (user == null) {
        //4.ä¸å­˜åœ¨ï¼Œæ‹¦æˆª 401 çŠ¶æ€ç  æœªæˆæƒ
        response.setStatus(401);
        return false;
    }
    //5.å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°ThreadLocal
    UserHolder.saveUser((UserDTO) user);
    //6.æ”¾è¡Œ
    return true;
}
```

```java
package com.hmdp.utils;

import com.hmdp.dto.UserDTO;
import com.hmdp.entity.User;

/**
 *  ThreadLocalç±»
 */
public class UserHolder {
    private static final ThreadLocal<UserDTO> tl = new ThreadLocal<>();

    public static void saveUser(UserDTO user){
        tl.set(user);
    }

    public static UserDTO getUser(){
        return tl.get();
    }

    public static void removeUser(){
        tl.remove();
    }
}
\
```

> **ThreadLocal**
>
> `ThreadLocal` æ˜¯ Java ä¸­çš„ä¸€ä¸ªç±»ï¼Œå®ƒæä¾›äº†çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚è¿™äº›å˜é‡ä¸å®ƒä»¬çš„æ™®é€šå‰¯æœ¬ä¸åŒï¼Œå› ä¸ºæ¯ä¸ªè®¿é—®å®ƒä»¬ï¼ˆé€šè¿‡ get æˆ– set æ–¹æ³•ï¼‰çš„çº¿ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹åˆå§‹åŒ–çš„å˜é‡å‰¯æœ¬ 1ã€‚
>
> ç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³è±¡ `ThreadLocal` å°†æ•°æ®å­˜å‚¨åœ¨ä¸€ä¸ªä»¥çº¿ç¨‹ä¸ºé”®çš„æ˜ å°„ä¸­ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬åœ¨ `threadLocalValue` ä¸Šè°ƒç”¨ get æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬å°†è·å¾—è¯·æ±‚çº¿ç¨‹çš„ Integer å€¼
> ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æƒ³è¦æ‹¥æœ‰ä¸€ä¸ªä¸ç‰¹å®šçº¿ç¨‹æ†ç»‘çš„ Integer å€¼ï¼š
>
> ```java
> ThreadLocal<Integer> threadLocalValue = new ThreadLocal<>();
> ```
>
> æ¥ä¸‹æ¥ï¼Œå½“æˆ‘ä»¬æƒ³è¦ä»çº¿ç¨‹ä¸­ä½¿ç”¨è¿™ä¸ªå€¼æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨ get æˆ– set æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š
>
> ```java
> threadLocalValue.set(1);
> Integer result = threadLocalValue.get();
> ```

> # **è®°å¾—ç»™é…ç½®ç±»åŠ ä¸Šæ³¨è§£**

---

#### é›†ç¾¤çš„sessionå…±äº«é—®é¢˜

`sessionå…±äº«é—®é¢˜`ï¼šå¤šå°Tomcatå¹¶ä¸å…±äº«sessionå­˜å‚¨ç©ºé—´ï¼Œå½“è¯·æ±‚åˆ‡æ¢åˆ°ä¸åŒtomcatæœåŠ¡æ—¶å¯¼è‡´æ•°æ®ä¸¢å¤±çš„é—®é¢˜ã€‚

---

### ğŸ‘ŒåŸºäºRediså®ç°å…±äº«sessionç™»å½•

#### å‘é€éªŒè¯ç 

```mermaid
%% å‘é€çŸ­ä¿¡éªŒè¯ç 
graph LR
A((å¼€å§‹)) --> B[æäº¤æ‰‹æœºå·];
B --> C{æ ¡éªŒæ‰‹æœºå·} --> |ä¸ç¬¦åˆ|B
C --> |ç¬¦åˆ|D[ç”ŸæˆéªŒè¯ç ] --> E[ä¿å­˜éªŒè¯ç åˆ°Redis] --> F[å‘é€éªŒè¯ç ] --> G((ç»“æŸ))
```

```java
@Resource
private StringRedisTemplate stringRedisTemplate;

@Override
public Result sendCode(String phone, HttpSession session) {
    //1,æ ¡éªŒæ‰‹æœºå·
    if (RegexUtils.isPhoneInvalid(phone)) {
        //2,å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
        return Result.fail("æ‰‹æœºå·æ ¼å¼é”™è¯¯");
    }
    //3,ç¬¦åˆï¼Œç”ŸæˆéªŒè¯ç 
    String code = RandomUtil.randomNumbers(6);
    //4,ä¿å­˜éªŒè¯ç åˆ°Redis //set key value ex 120  ç§’ä¸ºå•ä½
    stringRedisTemplate.opsForValue().set(LOGIN_CODE_KEY + phone,code,LOGIN_CODE_TTL, TimeUnit.MINUTES);
    session.setAttribute("code",code);
    //5.å‘é€éªŒè¯ç 
    log.debug("å‘é€çŸ­ä¿¡éªŒè¯ç æˆåŠŸï¼ŒéªŒè¯ç ï¼š{}",code);
    return Result.ok(code);
}
```



---

#### çŸ­ä¿¡éªŒè¯ç ç™»å½•å’Œæ³¨å†ŒåŠŸèƒ½

```mermaid
%% å‘é€çŸ­ä¿¡éªŒè¯ç 
graph LR
A((å¼€å§‹)) --> B[æäº¤æ‰‹æœºå·å’ŒéªŒè¯ç ];
B --> C{æ ¡éªŒéªŒè¯ç } --> |ä¸ä¸€è‡´|B
C --> |ä¸€è‡´|D[æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·] --> E[ç”¨æˆ·æ˜¯å¦å­˜åœ¨] --> |ä¸å­˜åœ¨|F[åˆ›å»ºæ–°ç”¨æˆ·] --> G[ä¿å­˜ç”¨æˆ·åˆ°æ•°æ®åº“] --> H
E --> |å­˜åœ¨|H[ä¿å­˜ç”¨æˆ·åˆ°Redis] --> I[è¿”å›tokenåˆ°å®¢æˆ·ç«¯] --> J((ç»“æŸ))
```

```java
@Override
public Result login(LoginFormDTO loginForm, HttpSession session) {
    //1.æ ¡éªŒæ‰‹æœºå·
    String phone = loginForm.getPhone();
    if (RegexUtils.isPhoneInvalid(phone)) {
        //2,å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
        return Result.fail("æ‰‹æœºå·æ ¼å¼é”™è¯¯");
    }
    //2.ä»Redisè·å–æ ¡éªŒéªŒè¯ç 
    String cacheCode = stringRedisTemplate.opsForValue().get(LOGIN_CODE_KEY + phone);
    String code = loginForm.getCode();
    if (cacheCode == null || !cacheCode.equals(code)) {
        //3.ä¸ä¸€è‡´ï¼ŒæŠ¥é”™
        return Result.fail("éªŒè¯ç é”™è¯¯");
    }
    //4.ä¸€è‡´ï¼Œæ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·
    User user = this.query().eq("phone", phone).one();
    //5.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    if (user == null) {
        //6.ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·å¹¶ä¿å­˜
        user = saveUserWithPhone(phone);
    }
    // 7.ä¿å­˜ç”¨æˆ·ä¿¡æ¯Redisä¸­
    // 7.1 éšæœºç”ŸæˆTokenä½œä¸ºç™»å½•ä»¤ç‰Œ
    String token = UUID.randomUUID().toString(true);
    // 7.2 å°†Userå¯¹è±¡è½¬ä¸ºHashå­˜å‚¨
    UserDTO userDTO = BeanUtil.copyProperties(user, UserDTO.class);
    Map<String, Object> userMap = BeanUtil.beanToMap(userDTO);
    // 7.3 å­˜å‚¨
    stringRedisTemplate.opsForHash().putAll(LOGIN_USER_KEY + token, userMap);
    // 7.4 è®¾ç½®è¿‡æœŸæ—¶é—´
    stringRedisTemplate.expire(LOGIN_USER_KEY + token, CACHE_SHOP_TTL, TimeUnit.MINUTES);
    // 8 è¿”å›Token
    return Result.ok(token);
}
```

---

#### ç™»å½•éªŒè¯

```mermaid
graph LR
A((å¼€å§‹)) --> B[è¯·æ±‚å¹¶æºå¸¦Token] --> C[ä»Redisè·å–ç”¨æˆ·] --> D{åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨} --> |å­˜åœ¨|E[ä¿å­˜ç”¨æˆ·åˆ°ThreadLocal]
D --> |ä¸å­˜åœ¨|F[æ‹¦æˆª] --> G((ç»“æŸ))
```

```java
/**
 * å‰ç½®æ‹¦æˆªå™¨
 */
@Override
public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
    //1.è·å–è¯·æ±‚å¤´ä¸­çš„Token
    String token = request.getHeader("authorization");
    if (StrUtil.isBlank(token)) {
        response.setStatus(401);
        return false;
    }
    //2.è·å–Redisä¸­çš„ç”¨æˆ·
    Map<Object, Object> userMap = stringRedisTemplate.opsForHash().entries(RedisConstants.LOGIN_USER_KEY + token);
    //3.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    if (userMap.isEmpty()) {
        //4.ä¸å­˜åœ¨ï¼Œæ‹¦æˆª 401 çŠ¶æ€ç  æœªæˆæƒ
        response.setStatus(401);
        return false;
    }
    // 5.å°†æŸ¥è¯¢çš„Hashæ•°æ®è½¬ä¸ºUserDTOå¯¹è±¡
    UserDTO userDTO = BeanUtil.fillBeanWithMap(userMap, new UserDTO(), false);
    // 6.å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°ThreadLocal
    UserHolder.saveUser(userDTO);
    // 7.åˆ·æ–°Tokenæœ‰æ•ˆæœŸ
    stringRedisTemplate.expire(LOGIN_USER_KEY + token, CACHE_SHOP_TTL, TimeUnit.MINUTES);
    // 8.æ”¾è¡Œ
    return true;
}
```

> ## Resultç±»ä¸­ä¸è¦åœ¨æ·»åŠ è¿”å›Msgæ„é€ æ–¹æ³•

---

#### ç™»å½•æ‹¦æˆªå™¨çš„ä¼˜åŒ–

![image-20230415154649051](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230415154649051.png)

---

## 2.å•†æˆ·æŸ¥è¯¢ç¼“å­˜

### ğŸ’¥ä»€ä¹ˆæ˜¯ç¼“å­˜

`ç¼“å­˜:`å°±æ˜¯æ•°æ®äº¤æ¢çš„ç¼“å†²åŒºï¼ˆç§°ä½œCache),æ˜¯å­˜è´®æ•°æ®çš„ä¸´æ—¶åœ°æ–¹ï¼Œä¸€èˆ¬è¯»å†™æ€§èƒ½è¾ƒé«˜ã€‚

![image-20230415162809894](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230415162809894.png)

---

### ğŸ‘Œæ·»åŠ Redisç¼“å­˜

**æµç¨‹å›¾**

![image-20230415163741591](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230415163741591.png)

```java
@Override
public Result queryById(Long id) {
    // 1.ä»RedisæŸ¥è¯¢å•†é“ºä¿¡æ¯
    String shopJson = stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);
    // 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨
    if (StrUtil.isNotBlank(shopJson)){
        // 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›
        Shop shop = JSONUtil.toBean(shopJson, Shop.class);
        return Result.ok(shop);
    }
    // 4.ä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“
    Shop shop = this.getById(id);
    // 5.è¿”å›é”™è¯¯
    if (shop == null) {
        return Result.fail("åº—é“ºä¸å­˜åœ¨");
    }
    // 6.å­˜åœ¨ï¼Œå†™å…¥Redis
    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(shop));
    // 7.è¿”å›
    return Result.ok(shop);
}
```

---

#### ç»ƒä¹ :ç»™åº—é“ºç±»å‹æŸ¥è¯¢ä¸šåŠ¡æ·»åŠ ç¼“å­˜

```java
@Resource
private StringRedisTemplate stringRedisTemplate;

@Override
public Result queryTypeList() {
    // 1.ä»Redisä¸­æŸ¥è¯¢æ•°æ®
    List<String> jsonShopTypes = stringRedisTemplate.opsForList().range(CACHE_TYPES_KEY, 0, -1);
    // 2.æœ‰æ•°æ®ç›´æ¥è¿”å›
    if (!CollectionUtil.isEmpty(jsonShopTypes)) {
        //ç¼“å­˜å‘½ä¸­ JSONåŒ–Listè¿”å›
        List<ShopType> shopList = jsonShopTypes.stream()
                .map(item -> JSONUtil.toBean(item, ShopType.class))
                .sorted(Comparator.comparing(ShopType::getSort))
                .collect(Collectors.toList());
        return Result.ok(shopList);
    }
    // 3.shopList
    List<ShopType> shopList = this.query().orderByAsc("sort").list();
    // 4.æ•°æ®åº“æ— æ•°æ®è¿”å›
    if (CollectionUtil.isEmpty(shopList)) {
        //Collections.emptyList().toString() è¿”å›ä¸€ä¸ªå¯åºåˆ—åŒ–çš„ç©ºé›†åˆ
//            stringRedisTemplate.opsForValue()
//                    .set(CACHE_TYPES_KEY, Collections.emptyList().toString(), CACHE_NULL_TTL, TimeUnit.MINUTES);
        return Result.fail("æ— åº—é“ºç±»å‹");
    }
    // 5.æœ‰æ•°æ®å†™å…¥Redisä¸­å†è¿”å›
    List<String> shopTypeCache = shopList.stream()
            .sorted(Comparator.comparing(ShopType::getSort))
            .map(JSONUtil::toJsonStr)
            .collect(Collectors.toList());
    stringRedisTemplate.opsForList().rightPushAll(CACHE_TYPES_KEY,shopTypeCache);
    stringRedisTemplate.expire(CACHE_TYPES_KEY,CACHE_NULL_TTL,TimeUnit.MINUTES);

    return Result.ok(shopList);
}
```

---

### ğŸ’¥ç¼“å­˜æ›´æ–°ç­–ç•¥

| ç§ç±»     |                           å†…å­˜æ·˜æ±°                           |                           è¶…æ—¶å‰”é™¤                           |                     ä¸»åŠ¨æ›´æ–°                      |
| -------- | :----------------------------------------------------------: | :----------------------------------------------------------: | :-----------------------------------------------: |
| è¯´æ˜     | ä¸ç”¨è‡ªå·±ç»´æŠ¤ï¼Œåˆ©ç”¨`Redis`çš„å†…å­˜æ·˜æ±°æœºåˆ¶ï¼Œ<br>å½“å†…å­˜ä¸è¶³æ—¶è‡ªåŠ¨æ·˜æ±°éƒ¨åˆ†æ•°æ®ã€‚ä¸‹æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ç¼“å­˜ã€‚ | ç»™ç¼“å­˜æ•°æ®æ·»åŠ TTLæ—¶é—´ï¼Œåˆ°æœŸåè‡ª<br/>åŠ¨åˆ é™¤ç¼“å­˜ã€‚ä¸‹æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ç¼“å­˜ã€‚ | ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œåœ¨ä¿®æ”¹æ•°æ®åº“çš„<br/>åŒæ—¶ï¼Œæ›´æ–°ç¼“å­˜ã€‚ |
| ä¸€è‡´æ€§   |                              å·®                              |                             ä¸€èˆ¬                             |                        å¥½                         |
| ç»´æŠ¤æˆæœ¬ |                              æ—                               |                              ä½                              |                        é«˜                         |

> ä¸šåŠ¡åœºæ™¯ï¼š
>
> * ä½ä¸€è‡´æ€§éœ€æ±‚ï¼šä½¿ç”¨å†…å­˜æ·˜æ±°æœºåˆ¶ã€‚ä¾‹å¦‚åº—é“ºç±»å‹çš„æŸ¥è¯¢ç¼“å­˜
> * é«˜ä¸€è‡´æ€§éœ€æ±‚ï¼šä¸»åŠ¨æ›´æ–°ï¼Œå¹¶ä»¥è¶…æ—¶å‰”é™¤ä½œä¸ºå…œåº•æ–¹æ¡ˆã€‚ä¾‹å¦‚åº—é“ºè¯¦æƒ…æŸ¥è¯¢çš„ç¼“å­˜

---

**ä¸»åŠ¨æ›´æ–°ç­–ç•¥**

ğŸ’¥**ä¸‰ç§è§£å†³æ–¹æ¡ˆ**

![image-20230415230911993](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230415230911993.png)

ğŸ’¥æ“ä½œç¼“å­˜å’Œæ•°æ®åº“æ—¶æœ‰ä¸‰ä¸ªé—®é¢˜éœ€è¦è€ƒè™‘ï¼š

1. åˆ é™¤ç¼“å­˜è¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ

* æ›´æ–°ç¼“å­˜ï¼šæ¯æ¬¡æ›´æ–°æ•°æ®åº“éƒ½æ›´æ–°ç¼“å­˜ï¼Œæ— æ•ˆå†™æ“ä½œè¾ƒå¤šã€‚âŒ
* åˆ é™¤ç¼“å­˜ï¼šæ›´æ–°æ•°æ®åº“æ—¶è®©ç¼“å­˜å¤±æ•ˆï¼ŒæŸ¥è¯¢æ—¶å†æ›´æ–°ç¼“å­˜ã€‚âœ”

2. å¦‚ä½•ä¿è¯ç¼“å­˜ä¸æ•°æ®åº“çš„æ“ä½œçš„åŒæ—¶æˆåŠŸæˆ–å¤±è´¥ï¼Ÿ

* å•ä½“ç³»ç»Ÿï¼Œå°†ç¼“å­˜ä¸æ•°æ®åº“æ“ä½œæ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡
* åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåˆ©ç”¨TCCç­‰åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ

---

3. å…ˆæ“ä½œç¼“å­˜è¿˜æ˜¯å…ˆæ“ä½œæ•°æ®åº“ï¼Ÿ

* å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ“ä½œæ•°æ®åº“
* å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜

![image-20230415232106714](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230415232106714.png)

> ä¸¤ç§æ–¹æ¡ˆå‡ºç°ä¸ä¸€è‡´æ€§çš„å®‰å…¨é—®é¢˜
>
> `æ–¹æ¡ˆäºŒ`å‘ç”Ÿæ¦‚ç‡ä½äº`æ–¹æ¡ˆä¸€`

---

#### æ€»ç»“

> ç¼“å­˜æ›´æ–°ç­–ç•¥çš„æœ€ä½³å®è·µæ–¹æ¡ˆï¼š
> 1.ä½ä¸€è‡´æ€§éœ€æ±‚ï¼šä½¿ç”¨`Redis`è‡ªå¸¦çš„å†…å­˜æ·˜æ±°æœºåˆ¶
> 2.é«˜ä¸€è‡´æ€§éœ€æ±‚ï¼šä¸»åŠ¨æ›´æ–°ï¼Œå¹¶ä»¥è¶…æ—¶å‰”é™¤ä½œä¸ºå…œåº•æ–¹æ¡ˆ
>
> #### 	â—†è¯»æ“ä½œï¼š
>
> ##### 			ç¼“å­˜å‘½ä¸­åˆ™ç›´æ¥è¿”å›
>
> ##### 			ç¼“å­˜æœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶å†™å…¥ç¼“å­˜ï¼Œè®¾å®šè¶…æ—¶æ—¶é—´
>
> #### â—†å†™æ“ä½œï¼š
>
> ##### 			å…ˆå†™æ•°æ®åº“ï¼Œç„¶åå†åˆ é™¤ç¼“å­˜
>
> ##### 			è¦ç¡®ä¿æ•°æ®åº“ä¸ç¼“å­˜æ“ä½œçš„åŸå­æ€§

---

#### æ¡ˆä¾‹

**ç»™æŸ¥è¯¢å•†é“ºçš„ç¼“å­˜æ·»åŠ è¶…æ—¶å‰”é™¤å’Œä¸»åŠ¨æ›´æ–°çš„ç­–ç•¥**
ä¿®æ”¹`ShopController`ä¸­çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ»¡è¶³ä¸‹é¢çš„éœ€æ±‚ï¼š
	â‘ æ ¹æ®`id`æŸ¥è¯¢åº—é“ºæ—¶ï¼Œå¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå°†æ•°æ®åº“ç»“æœå†™å…¥ç¼“å­˜ï¼Œå¹¶è®¾ç½®è¶…æ—¶æ—¶é—´

```java
// 6.å­˜åœ¨ï¼Œå†™å…¥Redisæ·»åŠ è¿‡æœŸæ—¶é—´
stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(shop),CACHE_SHOP_TTL, TimeUnit.MINUTES);
```

â€‹	â‘¡æ ¹æ®`id`ä¿®æ”¹åº—é“ºæ—¶ï¼Œå…ˆä¿®æ”¹æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜

```java
@Override
@Transactional
public Result update(Shop shop) {
    Long id = shop.getId();
    if (id == null) {
        return Result.fail("åº—é“ºidä¸èƒ½ä¸ºç©º");
    }
    // 1.æ›´æ–°æ•°æ®åº“
    this.updateById(shop);
    // 2.åˆ é™¤ç¼“å­˜
    stringRedisTemplate.delete(CACHE_SHOP_KEY + id);
    return Result.ok();
}
```

---

### ğŸ‘Œç¼“å­˜ç©¿é€

`ç¼“å­˜ç©¿é€`æ˜¯æŒ‡å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œè¿™æ ·ç¼“å­˜æ°¸è¿œä¸ä¼šç”Ÿæ•ˆï¼Œè¿™äº›è¯·æ±‚éƒ½ä¼šæ‰“åˆ°æ•°æ®åº“ã€‚

> å¦‚æœåˆ«æœ‰ç”¨å¿ƒçš„è®¿é—®ä¸€ä¸ªç¼“å­˜ä¸­ä¸å­˜åœ¨çš„æ•°æ®ï¼Œåˆ™ä¼šç›´æ¥è¯·æ±‚æ•°æ®åº“ï¼Œå¤§é‡è¯·æ±‚ä¸‹å¯èƒ½ä¼šå¯¼è‡´æ•°æ®åº“å´©æºƒ

**è§£å†³æ–¹æ³•ï¼š**

* ç¼“å­˜ç©ºå¯¹è±¡

```java
å½“ç¬¬ä¸€æ¬¡è®¿é—®ç¼“å­˜ä¸å­˜åœ¨çš„æ•°æ®åï¼Œç¼“å­˜ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œè¿™æ ·ä¸‹ä¸€æ¬¡è®¿é—®æ—¶åˆ™è¿”å›ç¼“å­˜ä¸­çš„ç©ºå¯¹è±¡
    
ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œç»´æŠ¤æ–¹ä¾¿
ç¼ºç‚¹ï¼š
	1.é¢å¤–çš„å†…å­˜æ¶ˆè€—
	2.å¯èƒ½é€ æˆçŸ­æœŸçš„ä¸ä¸€è‡´
```

<img src="https://cdn.jsdelivr.net/gh/flyono/Chart-bed@main/img/image-20230415235521184.png" alt="image-20230415235521184" style="zoom: 50%;" />

* å¸ƒéš†è¿‡æ»¤å™¨

```java
å½“ä¸€ä¸ªå…ƒç´ è¢«åŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨ä¸­çš„æ—¶å€™ï¼Œä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼šä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­çš„å“ˆå¸Œå‡½æ•°å¯¹å…ƒç´ å€¼è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°å“ˆå¸Œå€¼ï¼ˆæœ‰å‡ ä¸ªå“ˆå¸Œå‡½æ•°å¾—åˆ°å‡ ä¸ªå“ˆå¸Œå€¼ï¼‰ã€‚æ ¹æ®å¾—åˆ°çš„å“ˆå¸Œå€¼ï¼Œåœ¨ä½æ•°ç»„ä¸­æŠŠå¯¹åº”ä¸‹æ ‡çš„å€¼ç½®ä¸º1ã€‚

å½“æˆ‘ä»¬éœ€è¦åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨çš„æ—¶å€™ï¼Œä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼šå¯¹ç»™å®šå…ƒç´ å†æ¬¡è¿›è¡Œç›¸åŒçš„å“ˆå¸Œè®¡ç®—ï¼›å¾—åˆ°å€¼ä¹‹ååˆ¤æ–­ä½æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ æ˜¯å¦éƒ½ä¸º 1ï¼Œå¦‚æœå€¼éƒ½ä¸º 1ï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªå€¼åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ªå€¼ä¸ä¸º 1ï¼Œè¯´æ˜è¯¥å…ƒç´ ä¸åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚

ä¼˜ç‚¹ï¼šå†…å­˜å ç”¨è¾ƒå°‘ï¼Œæ²¡æœ‰å¤šä½™Key
ç¼ºç‚¹ï¼š
    1.å®ç°å¤æ‚
    2.å­˜åœ¨è¯¯åˆ¤å¯èƒ½
```

---

**æµç¨‹**

![image-20230416000225717](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230416000225717.png)

ç¼“å­˜ç©ºå¯¹è±¡å®ç°

```java
@Override
public Result queryById(Long id) {
    // 1.ä»RedisæŸ¥è¯¢å•†é“ºä¿¡æ¯
    String shopJson = stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);
    // 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨
    if (StrUtil.isNotBlank(shopJson)){
        // 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›
        Shop shop = JSONUtil.toBean(shopJson, Shop.class);
        return Result.ok(shop);
    }
    if (shopJson != null){
        return Result.fail("åº—é“ºä¸å­˜åœ¨");
    }
    // 4.ä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“
    Shop shop = this.getById(id);
    // 5.è¿”å›é”™è¯¯
    if (shop == null) {
        //å°†ç©ºå€¼å†™å…¥Redis
        stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, "",CACHE_NULL_TTL, TimeUnit.MINUTES);
        return Result.fail("åº—é“ºä¸å­˜åœ¨");
    }
    // 6.å­˜åœ¨ï¼Œå†™å…¥Redis
    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(shop),CACHE_SHOP_TTL, TimeUnit.MINUTES);
    // 7.è¿”å›
    return Result.ok(shop);
}
```

---

#### æ€»ç»“

ç¼“å­˜ç©¿é€äº§ç”Ÿçš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ

* ç”¨æˆ·è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œä¸æ–­å‘èµ·è¿™æ ·çš„è¯·æ±‚ï¼Œç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§å‹åŠ›

ç¼“å­˜ç©¿é€çš„è§£å†³æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ

* ç¼“å­˜nullå€¼
* å¸ƒéš†è¿‡æ»¤
* å¢å¼º`id`çš„å¤æ‚åº¦ï¼Œé¿å…è¢«çŒœæµ‹`id`è§„å¾‹
* åšå¥½æ•°æ®çš„åŸºç¡€æ ¼å¼æ ¡éªŒ
* åŠ å¼ºç”¨æˆ·æƒé™æ ¡éªŒ
* åšå¥½çƒ­ç‚¹å‚æ•°çš„é™æµ

---

### ğŸ‘Œç¼“å­˜é›ªå´©

`ç¼“å­˜é›ªå´©`æ˜¯æŒ‡åœ¨åŒä¸€æ—¶æ®µå¤§é‡çš„ç¼“å­˜keyåŒæ—¶å¤±æ•ˆæˆ–è€…`Redis`æœåŠ¡å®•æœºï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚åˆ°è¾¾æ•°æ®åº“ï¼Œå¸¦æ¥å·¨å¤§å‹åŠ›ã€‚

> **è§£å†³æ–¹æ¡ˆï¼š**
>
> * ç»™ä¸åŒçš„Keyçš„TTLæ·»åŠ éšæœºå€¼
> * åˆ©ç”¨`Redis`é›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§
> * ç»™ç¼“å­˜ä¸šåŠ¡æ·»åŠ é™çº§é™æµç­–ç•¥
> * ç»™ä¸šåŠ¡æ·»åŠ å¤šçº§ç¼“å­˜

---

### ğŸ‘Œç¼“å­˜å‡»ç©¿

`ç¼“å­˜å‡»ç©¿`é—®é¢˜ä¹Ÿå«`çƒ­ç‚¹Key`é—®é¢˜ï¼Œå°±æ˜¯ä¸€ä¸ªè¢«`é«˜å¹¶å‘è®¿é—®`å¹¶ä¸”`ç¼“å­˜é‡å»ºä¸šåŠ¡è¾ƒå¤æ‚`çš„keyçªç„¶å¤±æ•ˆäº†ï¼Œæ— æ•°çš„è¯·æ±‚è®¿é—®ä¼š
åœ¨ç¬é—´ç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„å†²å‡»ã€‚

> **å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š**
>
> * äº’æ–¥é”
>
> <img src="https://cdn.jsdelivr.net/gh/flyono/Chart-bed@main/img/image-20230416160758527.png" alt="image-20230416160758527" style="zoom:50%;" />
>
> * é€»è¾‘è¿‡æœŸ
>
> <img src="https://cdn.jsdelivr.net/gh/flyono/Chart-bed@main/img/image-20230416161656406.png" alt="image-20230416161656406" style="zoom:50%;" />

**ä¼˜ç¼ºç‚¹åˆ†æï¼š**

| è§£å†³æ–¹æ¡ˆ |                     ä¼˜ç‚¹                     |                    ç¼ºç‚¹                    |
| :------: | :------------------------------------------: | :----------------------------------------: |
|  äº’æ–¥é”  | æ²¡æœ‰é¢å¤–çš„å†…å­˜æ¶ˆè€—<br>ä¿è¯ä¸€è‡´æ€§<br>å®ç°ç®€å• | çº¿ç¨‹éœ€è¦ç­‰å¾…ï¼Œæ€§èƒ½å—å½±å“<br>å¯èƒ½æœ‰æ­»é”é£é™© |
| é€»è¾‘è¿‡æœŸ |            çº¿ç¨‹æ— éœ€ç­‰å¾…ï¼Œæ€§èƒ½è¾ƒå¥½            | ä¸ä¿è¯ä¸€è‡´æ€§<br>æœ‰é¢å¤–å†…å­˜æ¶ˆè€—<br>å®ç°å¤æ‚ |

---

#### æ¡ˆä¾‹

**åŸºäºäº’æ–¥é”æ–¹å¼è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜**
éœ€æ±‚ï¼šä¿®æ”¹æ ¹æ®idæŸ¥è¯¢å•†é“ºçš„ä¸šåŠ¡ï¼ŒåŸºäº`äº’æ–¥é”æ–¹å¼`æ¥è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜

**æµç¨‹å›¾**

```mermaid
graph TB
A((å¼€å§‹)) --> B[æäº¤åº—é“ºid] --> C[ä»Redisä¸­æŸ¥è¯¢å•†é“ºç¼“å­˜] --> D{{åˆ¤æ–­ç¼“å­˜æ˜¯å¦å‘½ä¸­}} --> |å‘½ä¸­|E[è¿”å›æ•°æ®] -->Z((ç»“æŸ))
D --> |æœªå‘½ä¸­|F[å°è¯•è·å–äº’æ–¥é”] --> G{{åˆ¤æ–­æ˜¯å¦è·å–é”}} --> |æ˜¯|H[æ ¹æ®idæŸ¥è¯¢æ•°æ®åº“] --> I[å°†åº—é“ºæ•°æ®å†™å…¥Redis]-->J[é‡Šæ”¾äº’æ–¥é”] --> E
G --> |å¦|K[ä¼‘çœ ä¸€æ®µæ—¶é—´] --> C
```

---

```java
/**
* çº¿ç¨‹æ± 
*/
private static final ExecutorService CACHE_REBUILD_EXECUTOR = Executors.newFixedThreadPool(10);

/**
* åŸºäºäº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿
* @param id åº—é“ºid
* @return
*/
public Shop queryWithMutex(Long id) {
    // 1.ä»RedisæŸ¥è¯¢å•†é“ºä¿¡æ¯
    String shopJson = stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);
    // 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨(å‘½ä¸­)
    if (StrUtil.isNotBlank(shopJson)) {
        // 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›
        return JSONUtil.toBean(shopJson, Shop.class);
    }
    if (shopJson != null) {
        return null;
    }
    // 4.å®ç°ç¼“å­˜é‡å»º
    // 4.1 è·å–äº’æ–¥é”
    String lockKey = LOCK_SHOP_KEY + id;
    Shop shop = null;
    try {
        boolean isLock = tryLock(lockKey);
        // 4.2 åˆ¤æ–­æ˜¯å¦è·å–æˆåŠŸ
        if (!isLock) {
            // 4.3 å¤±è´¥ï¼Œä¼‘çœ å¹¶é‡è¯•
            Thread.sleep(50);
            return queryWithMutex(id);
        }
        // 4.4 æˆåŠŸï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“
        shop = this.getById(id);
        // æ¨¡æ‹Ÿé‡å»ºå»¶è¿Ÿ
        Thread.sleep(200);
        // 5.è¿”å›é”™è¯¯
        if (shop == null) {
            //å°†ç©ºå€¼å†™å…¥Redis
            stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, "", CACHE_NULL_TTL, TimeUnit.MINUTES);
            return null;
        }
        // 6.å­˜åœ¨ï¼Œå†™å…¥Redis
        stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(shop), CACHE_SHOP_TTL, TimeUnit.MINUTES);
    } catch(InterruptedException e){
        throw new RuntimeException(e);
    } finally {
        // 7.é‡Šæ”¾äº’æ–¥é”
        unlock(lockKey);
    }
    // 8.è¿”å›
    return shop;
}
/**
 * è·å–é”
 *
 * @param key é”®
 * @return
 */
private boolean tryLock(String key) {
    Boolean flag = stringRedisTemplate.opsForValue().setIfAbsent(key, "1", 10, TimeUnit.SECONDS);
    return BooleanUtil.isTrue(flag);
}

/**
 * é‡Šæ”¾é”
 *
 * @param key é”®
 */
private void unlock(String key) {
    stringRedisTemplate.delete(key);
}
```

---

**åŸºäºé€»è¾‘è¿‡æœŸæ–¹å¼è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜**
éœ€æ±‚ï¼šä¿®æ”¹æ ¹æ®idæŸ¥è¯¢å•†é“ºçš„ä¸šåŠ¡ï¼ŒåŸºäº`é€»è¾‘è¿‡æœŸæ–¹å¼`æ¥è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜

**æµç¨‹å›¾**

```mermaid
graph TB

A((å¼€å§‹)) --> B[æäº¤åº—é“ºid] --> C[ä»Redisä¸­æŸ¥è¯¢åº—é“ºid] --> D{{åˆ¤æ–­ç¼“å­˜æ˜¯å¦å‘½ä¸­}} -->  |æœªå‘½ä¸­|F[è¿”å›ç©º] --> G((ç»“æŸ))
D --> |å‘½ä¸­|E{{åˆ¤æ–­ç¼“å­˜æ˜¯å¦è¿‡æœŸ}}
E --> |æœªè¿‡æœŸ|H[è¿”å›åº—é“ºä¿¡æ¯] --> G
E --> |è¿‡æœŸ|I[å°è¯•è·å–äº’æ–¥é”] --> J{{åˆ¤æ–­æ˜¯å¦è·å–é”}} 
J --> |å¦|H
J --> |æ˜¯|K[å¼€å¯ç‹¬ç«‹çº¿ç¨‹æ‰§è¡Œç¼“å­˜é‡å»º] -.-> database[æ ¹æ®idæŸ¥è¯¢æ•°æ®åº“] --> write[å°†å•†é“ºæ•°æ®å†™å…¥Redis,å¹¶è®¾ç½®è¾‘è¿‡æœŸæ—¶é—´]
```

---

```java
private static final ExecutorService CACHE_REBUILD_EXECUTOR = Executors.newFixedThreadPool(10);

/**
 * åŸºäºé€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿
 * éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœæ•°æ®ä¸€å¼€å§‹æœªå­˜åœ¨äºRedisä¸­ï¼Œåˆ™ä¼šè¿”å›æ— åº—é“ºæ•°æ®ï¼Œæ‰€æœ‰éœ€è¦æ‰§è¡Œå‰ç¼“å­˜é¢„çƒ­
 * @param id
 * @return
 */
public Shop queryWithLogicalExpire(Long id) {
    // 1.ä»RedisæŸ¥è¯¢å•†é“ºä¿¡æ¯
    String shopJson = stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);
    // 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨
    if (StrUtil.isBlank(shopJson)) {
        // 3.æœªå‘½ä¸­ï¼Œç›´æ¥è¿”å›
        return null;
    }
    // 4.å‘½ä¸­ï¼Œéœ€è¦å…ˆå°†jsonååºåˆ—åŒ–ä¸ºå¯¹è±¡
    RedisData redisData = JSONUtil.toBean(shopJson, RedisData.class);
    Shop shop = JSONUtil.toBean((JSONObject) redisData.getData(), Shop.class);
    LocalDateTime expireTime = redisData.getExpireTime();
    // 5.åˆ¤æ–­ç¼“å­˜æ˜¯å¦è¿‡æœŸ
    if (expireTime.isAfter(LocalDateTime.now())) {
        // 5.1æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›åº—é“ºä¿¡æ¯
        return shop;
    }
    // 5.2å·²è¿‡æœŸï¼Œéœ€è¦ç¼“å­˜é‡å»º
    // 6.ç¼“å­˜é‡å»º
    // 6.1 è·å–äº’æ–¥é”
    String lockKey = LOCK_SHOP_KEY + id;
    boolean isLock = tryLock(lockKey);
    // 6.2 åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ
    if (isLock) {
        // 6.3 æˆåŠŸ,å¼€å¯ç‹¬ç«‹çº¿ç¨‹ï¼Œå®ç°ç¼“å­˜é‡å»º
        CACHE_REBUILD_EXECUTOR.submit(() -> {
            try {
                //ç¼“å­˜é‡å»º
                this.saveShop2Redis(id, 20L);
            } catch (Exception e) {
                throw new RuntimeException(e);
            } finally {
                unlock(lockKey);
            }
        });
    }
    // 6.4 å¤±è´¥ï¼Œè¿”å›è¿‡æœŸåº—é“ºä¿¡æ¯

    return shop;
}
```

---

### ğŸ‘Œç¼“å­˜å·¥å…·å°è£…

> åŸºäº`StringRedisTemplate`å°è£…ä¸€ä¸ªç¼“å­˜å·¥å…·ç±»ï¼Œæ»¡è¶³ä¸‹åˆ—éœ€æ±‚ï¼š
> æ–¹æ³•1ï¼šå°†ä»»æ„)avaå¯¹è±¡åºåˆ—åŒ–ä¸ºJSONå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®TTLè¿‡æœŸæ—¶é—´
> æ–¹æ³•2ï¼šå°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºJSONå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œç”¨äºå¤„ç†ç¼“å­˜å‡»ç©¿é—®é¢˜
> æ–¹æ³•3ï¼šæ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œåˆ©ç”¨ç¼“å­˜ç©ºå€¼çš„æ–¹å¼è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜
> æ–¹æ³•4ï¼šæ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œéœ€è¦åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜

```java
package com.hmdp.utils;

import cn.hutool.core.util.BooleanUtil;
import cn.hutool.core.util.StrUtil;
import cn.hutool.json.JSONObject;
import cn.hutool.json.JSONUtil;
import com.hmdp.entity.Shop;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.TimeUnit;
import java.util.function.Function;

import static com.hmdp.utils.RedisConstants.*;

/**
 * Rediså·¥å…·ç±»
 */
@Slf4j
@Component
public class CacheClient {
    private final StringRedisTemplate stringRedisTemplate;

    public CacheClient(StringRedisTemplate stringRedisTemplate) {
        this.stringRedisTemplate = stringRedisTemplate;
    }

    public void set(String key, Object value, Long time, TimeUnit unit){
        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, unit);
    }

    public void setWithLogicExpire(String key, Object value, Long time, TimeUnit unit){
        // è®¾ç½®é€»è¾‘è¿‡æœŸ
        RedisData redisData = new RedisData();
        redisData.setData(value);
        redisData.setExpireTime(LocalDateTime.now().plusSeconds(unit.toSeconds(time)));
        // å†™å…¥Redis
        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));
    }

    /**
     * ç¼“å­˜ç©¿é€
     * @param keyPrefix keyå‰ç¼€
     * @param id æŸ¥è¯¢id
     * @param type ç±»å‹
     * @param dbFallback æ•°æ®åº“æŸ¥è¯¢å‡½æ•°
     * @param time è¿‡æœŸæ—¶é—´
     * @param unit æ—¶é—´å•ä½
     * @return
     * @param <R> æ³›å‹ 1
     * @param <ID> æ³›å‹ 2
     */
    public <R, ID> R queryWithPassThrough(
            String keyPrefix, ID id, Class<R> type, Function<ID, R> dbFallback, Long time, TimeUnit unit) {
        String key = keyPrefix + id;
        // 1.ä»RedisæŸ¥è¯¢å•†é“ºä¿¡æ¯
        String json = stringRedisTemplate.opsForValue().get(key);
        // 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        if (StrUtil.isNotBlank(json)) {
            // 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›
            return JSONUtil.toBean(json, type);
        }
        if (json != null) {
            return null;
        }
        // 4.ä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“
        R r = dbFallback.apply(id);
        // 5.è¿”å›é”™è¯¯
        if (r == null) {
            //å°†ç©ºå€¼å†™å…¥Redis
            stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, "", CACHE_NULL_TTL, TimeUnit.MINUTES);
            return null;
        }
        // 6.å­˜åœ¨ï¼Œå†™å…¥Redis
        this.set(key, r, time, unit);
        // 7.è¿”å›
        return r;
    }

    /**
     * çº¿ç¨‹æ± 
     */
    private static final ExecutorService CACHE_REBUILD_EXECUTOR = Executors.newFixedThreadPool(10);
    public <R, ID> R queryWithLogicalExpire(
            String keyPrefix, ID id, Class<R> type, Function<ID, R> dbFallback, Long time, TimeUnit unit) {
        String key = keyPrefix + id;
        // 1.ä»RedisæŸ¥è¯¢å•†é“ºä¿¡æ¯
        String json = stringRedisTemplate.opsForValue().get(key);
        // 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        if (StrUtil.isBlank(json)) {
            // 3.æœªå‘½ä¸­ï¼Œç›´æ¥è¿”å›
            return null;
        }
        // 4.å‘½ä¸­ï¼Œéœ€è¦å…ˆå°†jsonååºåˆ—åŒ–ä¸ºå¯¹è±¡
        RedisData redisData = JSONUtil.toBean(json, RedisData.class);
        R r = JSONUtil.toBean((JSONObject) redisData.getData(), type);
        LocalDateTime expireTime = redisData.getExpireTime();
        // 5.åˆ¤æ–­ç¼“å­˜æ˜¯å¦è¿‡æœŸ
        if (expireTime.isAfter(LocalDateTime.now())) {
            // 5.1æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›åº—é“ºä¿¡æ¯
            return r;
        }
        // 5.2å·²è¿‡æœŸï¼Œéœ€è¦ç¼“å­˜é‡å»º
        // 6.ç¼“å­˜é‡å»º
        // 6.1 è·å–äº’æ–¥é”
        String lockKey = LOCK_SHOP_KEY + id;
        boolean isLock = tryLock(lockKey);
        // 6.2 åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ
        if (isLock) {
            // 6.3 æˆåŠŸ,å¼€å¯ç‹¬ç«‹çº¿ç¨‹ï¼Œå®ç°ç¼“å­˜é‡å»º
            CACHE_REBUILD_EXECUTOR.submit(() -> {
                try {
                    //ç¼“å­˜é‡å»º
                    //æŸ¥è¯¢æ•°æ®åº“
                    R r1 = dbFallback.apply(id);
                    //å†™å…¥Redis
                    this.setWithLogicExpire(key, r1, time, unit);
                } catch (Exception e) {
                    throw new RuntimeException(e);
                } finally {
                    unlock(lockKey);
                }
            });
        }
        // 6.4 å¤±è´¥ï¼Œè¿”å›è¿‡æœŸåº—é“ºä¿¡æ¯
        return r;
    }
    /**
     * è·å–é”
     *
     * @param key é”®
     * @return
     */
    private boolean tryLock(String key) {
        Boolean flag = stringRedisTemplate.opsForValue().setIfAbsent(key, "1", 10, TimeUnit.SECONDS);
        return BooleanUtil.isTrue(flag);
    }

    /**
     * é‡Šæ”¾é”
     *
     * @param key é”®
     */
    private void unlock(String key) {
        stringRedisTemplate.delete(key);
    }
}
```

---

## 3.ä¼˜æƒ åˆ¸ç§’æ€

### ğŸ‘Œå…¨å±€å”¯ä¸€ID

æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼š

è¿™å°±å¯¼è‡´äº†å½“ç”¨æˆ·æŠ¢è´­æ—¶ï¼Œå°±ä¼šç”Ÿæˆè®¢å•å¹¶ä¿å­˜åˆ°`tb_voucher_order`è¿™å¼ è¡¨ä¸­ï¼Œè€Œè®¢å•è¡¨å¦‚æœä½¿ç”¨æ•°æ®åº“è‡ªå¢IDå°±å­˜åœ¨ä¸€äº›é—®é¢˜ï¼š

* idçš„è§„å¾‹æ€§å¤ªæ˜æ˜¾
* å—å•è¡¨æ•°æ®é‡çš„é™åˆ¶

`å…¨å±€IDç”Ÿæˆå™¨`ï¼Œæ˜¯ä¸€ç§åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ç”¨æ¥ç”Ÿæˆå…¨å±€å”¯ä¸€Dçš„å·¥å…·ï¼Œä¸€èˆ¬è¦æ»¡è¶³ä¸‹åˆ—ç‰¹æ€§ï¼š

> 1. å”¯ä¸€æ€§
> 2. é€’å¢æ€§
> 3. é«˜å¯ç”¨
> 4. é«˜æ€§èƒ½
> 5. å®‰å…¨æ€§

å¦‚ä½•è®¾è®¡ï¼Ÿ

![image-20230416214703660](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230416214703660.png)

IDçš„ç»„æˆéƒ¨åˆ†ï¼š

* ç¬¦å·ä½ï¼š`1 bit`, æ°¸è¿œä¸º0
* æ—¶é—´æˆ³ï¼š`31 bit`, ä»¥ç§’ä¸ºå•ä½ï¼Œå¯ä»¥ä½¿ç”¨69å¹´
* åºåˆ—å·ï¼š`32 bit`, ç§’å†…çš„è®¡æ•°å™¨ï¼Œæ”¯æŒæ¯ç§’äº§ç”Ÿ2^32ä¸ªä¸åŒID

```java
package com.hmdp.utils;

import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.time.ZoneOffset;
import java.time.format.DateTimeFormatter;

/**
 * å…¨å±€IDç”Ÿæˆå™¨
 */
@Component
public class RedisIdWorker {
    /**
     * å¼€å§‹æ—¶é—´æˆ³
     */
    private static final long BEGIN_TIMESTAMP = 1640995200L;

    /**
     * åºåˆ—å·çš„ä½æ•°
     */
    public static final int COUNT_BITS = 32;
    private RedisTemplate RedisTemplate;

    public RedisIdWorker(StringRedisTemplate stringRedisTemplate) {
        this.RedisTemplate = stringRedisTemplate;
    }

    /**
     * è·å–ID
     * @param keyPrefix ä¸šåŠ¡å‰ç¼€
     * @return
     */
    public long nextId(String keyPrefix){
        // 1.ç”Ÿæˆæ—¶é—´æˆ³
        LocalDateTime now = LocalDateTime.now();
        long nowSecond = now.toEpochSecond(ZoneOffset.UTC);
        long timestamp = nowSecond - BEGIN_TIMESTAMP;
        // 2.ç”Ÿæˆåºåˆ—å·
        // 2.1 è·å–å½“å‰æ—¥æœŸï¼Œç²¾ç¡®åˆ°å¤©
        String date = now.format(DateTimeFormatter.ofPattern("yyyy:MM:dd"));
        Long count = RedisTemplate.opsForValue().increment("icr" + keyPrefix + ":" + date);
        // 3.æ‹¼æ¥è¿”å›
        return timestamp << COUNT_BITS | count;
    }

    /*
    //è·å–æ—¥æœŸå¯¹åº”çš„ç§’æ•°
    LocalDateTime time = LocalDateTime.of(2022, 1, 1, 0, 0, 0);
    long second = time.toEpochSecond(ZoneOffset.UTC);
    System.out.println(second);
    */
}
```

---

å…¨å±€å”¯ä¸€IDç”Ÿæˆç­–ç•¥

* UUID
* `Redis`è‡ªå¢
* snowflakeç®—æ³•
* æ•°æ®åº“è‡ªå¢

`Redis`è‡ªå¢ç­–ç•¥

* æ¯å¤©ä¸€ä¸ªkey,æ–¹ä¾¿ç»Ÿè®¡è®¢å•é‡
* IDæ„é€ æ˜¯ æ—¶é—´æˆ³+è®¡æ•°å™¨

---

### ğŸ‘Œå®ç°ä¼˜æƒ åˆ¸ç§’æ€ä¸‹å•

**ä¸‹å•æ—¶éœ€è¦åˆ¤æ–­ä¸¤ç‚¹ï¼š**

* ç§’æ€æ˜¯å¦å¼€å§‹æˆ–ç»“æŸï¼Œå¦‚æœå°šæœªå¼€å§‹æˆ–å·²ç»ç»“æŸåˆ™æ— æ³•ä¸‹å•
* åº“å­˜æ˜¯å¦å……è¶³ï¼Œä¸è¶³åˆ™æ— æ³•ä¸‹å•

```mermaid
graph LR
strat((å¼€å§‹)) --> A[æäº¤ä¼˜æƒ åˆ¸id] --> B[æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯] --> C{{åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å¯}}
C --> |å¦|R[è¿”å›å¼‚å¸¸ç»“æœ] --> last((ç»“æŸ))
C --> |æ˜¯|D{{åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³}}
D --> |å¦|R
D --> |æ˜¯|E[æ‰£å‡åº“å­˜] --> create[åˆ›å»ºè®¢å•] --> re[è¿”å›è®¢å•id] --> last
```

---

```java
@Resource
private ISeckillVoucherService seckillVoucherService;

@Resource
private RedisIdWorker redisIdWorker;
@Override
@Transactional
public Result seckillVoucher(Long voucherId) {
    // 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸
    SeckillVoucher voucher = seckillVoucherService.getById(voucherId);
    // 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å¯
    if (voucher.getBeginTime().isAfter(LocalDateTime.now())) {
        //å°šæœªå¼€å§‹
        return Result.fail("ç§’æ€å°šæœªå¼€å§‹");
    }
    // 3.åˆ¤æ–­ç§’æ€æ˜¯å¦ç»“æŸ
    if (voucher.getEndTime().isBefore(LocalDateTime.now())) {
        //å·²ç»ç»“æŸ
        return Result.fail("ç§’æ€å·²ç»ç»“æŸ");
    }
    // 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³
    if (voucher.getStock() < 1) {
        //åº“å­˜ä¸è¶³
        return Result.fail("åº“å­˜ä¸è¶³");
    }
    // 5.æ‰£å‡åº“å­˜
    boolean success = seckillVoucherService.update().setSql("stock = stock - 1").eq("voucher_id", voucherId).update();
    if (!success){
        // æ‰£å‡å¤±è´¥
        return Result.fail("åº“å­˜ä¸è¶³");
    }
    // 6.åˆ›å»ºè®¢å•
    VoucherOrder voucherOrder = new VoucherOrder();
    // 6.1 è®¢å•id
    long orderId = redisIdWorker.nextId("order");
    voucherOrder.setId(orderId);
    // 6.2 ç”¨æˆ·id
    Long userId = UserHolder.getUser().getId();
    voucherOrder.setUserId(userId);
    // 6.3 ä»£é‡‘åˆ¸id
    voucherOrder.setVoucherId(voucherId);
    this.save(voucherOrder);
    // 7.è¿”å›è®¢å•id
    return Result.ok(orderId);
}
```

---

### ğŸ‘Œè¶…å–é—®é¢˜

`è¶…å–é—®é¢˜`æ˜¯å…¸å‹çš„å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé’ˆå¯¹è¿™ä¸€é—®é¢˜çš„å¸¸è§è§£å†³æ–¹æ¡ˆå°±æ˜¯åŠ é”ï¼š

![image-20230417131236265](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230417131236265.png)

**ä¹è§‚é”å¸¸ç”¨çš„ä¸¤ç§æ–¹å¼ï¼š**

* ç‰ˆæœ¬å·æ³•

> æ·»åŠ `version`å­—æ®µ,ä¿®æ”¹æ—¶æºå¸¦`version`å¹¶åˆ¤æ–­ç‰ˆæœ¬å·æ˜¯å¦æ”¹å˜

* CASæ³•ï¼ˆ`CompareAndSet`ï¼‰

  > ä¿®æ”¹æ—¶ç›´æ¥æºå¸¦`stock`å¹¶åˆ¤æ–­æ•°é‡æ˜¯å¦æ­£ç¡®
  >
  > ```java
  > // 5.æ‰£å‡åº“å­˜æ—¶å†åˆ¤æ–­ä¸€æ¬¡åº“å­˜æ˜¯å¦å……è¶³
  > boolean success = seckillVoucherService.update()
  >         .setSql("stock = stock - 1")
  >         .eq("voucher_id", voucherId)
  >         .gt("stock",0)
  >         .update();
  > ```

---

1. æ‚²è§‚é”ï¼šæ·»åŠ åŒæ­¥é”ï¼Œè®©çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œ
   * ä¼˜ç‚¹ï¼šç®€å•ç²—æš´
   * ç¼ºç‚¹ï¼šæ€§èƒ½ä¸€èˆ¬
2. ä¹è§‚é”ï¼šä¸åŠ é”ï¼Œåœ¨æ›´æ–°æ—¶åˆ¤æ–­æ˜¯å¦æœ‰å…¶å®ƒçº¿ç¨‹åœ¨ä¿®æ”¹
   * ä¼˜ç‚¹ï¼šæ€§èƒ½å¥½
   * ç¼ºç‚¹ï¼šå­˜åœ¨æˆåŠŸç‡ä½çš„é—®é¢˜

---

### ğŸ‘Œä¸€äººä¸€å•

éœ€æ±‚ï¼šä¿®æ”¹ç§’æ€ä¸šåŠ¡ï¼Œè¦æ±‚åŒä¸€ä¸ªä¼˜æƒ åˆ¸ï¼Œä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€å•

```mermaid
graph LR
strat((å¼€å§‹)) --> submit(æäº¤ä¼˜æƒ åˆ¸id) --> query(æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯) --> åˆ¤æ–­1{{åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å¯}}

åˆ¤æ–­1 --> |æ˜¯|åˆ¤æ–­2{{åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³}}
åˆ¤æ–­1 --> |å¦|return(è¿”å›å¼‚å¸¸ç»“æœ) --> last((ç»“æŸ))

åˆ¤æ–­2 --> |æ˜¯|query2(æ ¹æ®ä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idæŸ¥è¯¢è®¢å•) --> åˆ¤æ–­3(åˆ¤æ–­è®¢å•æ˜¯å¦å­˜åœ¨)
åˆ¤æ–­2 --> |å¦|return

åˆ¤æ–­3 --> |ä¸å­˜åœ¨|æ‰£å‡(æ‰£å‡åº“å­˜) --> create(åˆ›å»ºè®¢å•) --> a(è¿”å›è®¢å•id) --> last((ç»“æŸ))
åˆ¤æ–­3 --> |å­˜åœ¨|return

```

> çŸ¥è¯†ç‚¹éšè®°ï¼š`springæ¡†æ¶äº‹åŠ¡å¤±æ•ˆ`ã€`aopä»£ç†å¯¹è±¡`ã€`synchronizedé”å¯¹è±¡`ã€‚

```java
// 5.ä¸€äººä¸€å•
...
{   
    ...
	Long userId = UserHolder.getUser().getId();
    // å¯¹ç”¨æˆ·IDåŠ é”
	synchronized(userId.toString().intern()){
    	// è·å–ä»£ç†å¯¹è±¡ï¼ˆäº‹åŠ¡ï¼‰
	    IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();
    	return proxy.createVoucherOrder(voucherId);
	}
}

@Transactional
public Result createVoucherOrder(Long voucherId) {
    // 5.ä¸€äººä¸€å•
    Long userId = UserHolder.getUser().getId();
    // 5.1 æŸ¥è¯¢è®¢å•
    int count = query().eq("user_id", userId).eq("voucher_id", voucherId).count();
    // 5.2 åˆ¤æ–­æ˜¯å¦å­˜åœ¨
    if (count > 0) {
        // ç”¨æˆ·å·²è´­ä¹°
        return Result.fail("ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡");
    }
    // 6.æ‰£å‡åº“å­˜
    boolean success = seckillVoucherService.update()
            .setSql("stock = stock - 1")
            .eq("voucher_id", voucherId)
            .gt("stock", 0)
            .update();
    if (!success) {
        // æ‰£å‡å¤±è´¥
        return Result.fail("åº“å­˜ä¸è¶³");
    }
    // 7.åˆ›å»ºè®¢å•
    VoucherOrder voucherOrder = new VoucherOrder();
    // 7.1 è®¢å•id
    long orderId = redisIdWorker.nextId("order");
    voucherOrder.setId(orderId);
    // 7.2 ç”¨æˆ·id
    voucherOrder.setUserId(userId);
    // 7.3 ä»£é‡‘åˆ¸id
    voucherOrder.setVoucherId(voucherId);
    this.save(voucherOrder);
    // 8.è¿”å›è®¢å•id
    return Result.ok(orderId);
}
```

---

**ä¸€äººä¸€å•çš„å¹¶å‘å®‰å…¨é—®é¢˜**

é€šè¿‡åŠ é”å¯ä»¥è§£å†³åœ¨å•æœºæƒ…å†µä¸‹çš„ä¸€äººä¸€å•å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯åœ¨é›†ç¾¤æ¨¡å¼ä¸‹å°±ä¸è¡Œäº†

1. æˆ‘ä»¬å°†æœåŠ¡å¯åŠ¨ä¸¤ä»½ï¼Œç«¯å£åˆ†åˆ«ä¸º8081å’Œ8082ï¼š

![image-20230505213208486](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230505213208486.png)

2. ç„¶åä¿®æ”¹nginxçš„confç›®å½•ä¸‹çš„nginx.confæ–‡ä»¶ï¼Œé…ç½®åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡ï¼š

![image-20230505213238125](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230505213238125.png)

ç°åœ¨ï¼Œç”¨æˆ·è¯·æ±‚ä¼šåœ¨è¿™ä¸¤ä¸ªèŠ‚ç‚¹ä¸Šè´Ÿè½½å‡è¡¡ï¼Œå†æ¬¡æµ‹è¯•ä¸‹æ˜¯å¦å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

å›¾å½¢æ¼”ç¤ºï¼š

![image-20230505215636801](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230505215636801.png)

---

### ğŸ‘Œåˆ†å¸ƒå¼é”

**ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”**
**åˆ†å¸ƒå¼é”**ï¼šæ»¡è¶³åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–é›†ç¾¤æ¨¡å¼ä¸‹å¤šè¿›ç¨‹å¯è§å¹¶ä¸”äº’æ–¥çš„é”ã€‚

åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ˜¯å®ç°å¤šè¿›ç¨‹ä¹‹é—´äº’æ–¥ï¼Œè€Œæ»¡è¶³è¿™ä¸€ç‚¹çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œå¸¸è§çš„æœ‰ä¸‰ç§ï¼š

|        |           MySQL           |          `Redis`          |            Zookeeper             |
| :----: | :-----------------------: | :-----------------------: | :------------------------------: |
|  äº’æ–¥  | åˆ©ç”¨MySQLæœ¬èº«çš„äº’æ–¥é”æœºåˆ¶ | åˆ©ç”¨`setnx`è¿™æ ·çš„äº’æ–¥å‘½ä»¤ | åˆ©ç”¨èŠ‚ç‚¹çš„å”¯ä¸€æ€§å’Œæœ‰åºæ€§å®ç°äº’æ–¥ |
| é«˜å¯ç”¨ |            å¥½             |            å¥½             |                å¥½                |
| é«˜æ€§èƒ½ |           ä¸€èˆ¬            |            å¥½             |               ä¸€èˆ¬               |
| å®‰å…¨æ€§ |   æ–­å¼€è¿æ¥ï¼Œè‡ªåŠ¨é‡Šæ”¾é”    | åˆ©ç”¨é”è¶…æ—¶æ—¶é—´ï¼Œåˆ°æœŸé‡Šæ”¾  |    ä¸´æ—¶èŠ‚ç‚¹ï¼Œæ–­å¼€è¿æ¥è‡ªåŠ¨é‡Šæ”¾    |

---

**åŸºäº`Redis`çš„åˆ†å¸ƒå¼é”**

å®ç°åˆ†å¸ƒå¼é”æ—¶éœ€è¦å®ç°çš„ä¸¤ä¸ªåŸºæœ¬æ–¹æ³•ï¼š

* è·å–é”ï¼š

  * äº’æ–¥ï¼šç¡®ä¿åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”

    ```shell
    # æ·»åŠ é”ï¼Œåˆ©ç”¨setnxçš„äº’æ–¥ç‰¹æ€§
    SFTNX lock thread1
    ```

* é‡Šæ”¾é”ï¼š

  * æ‰‹åŠ¨é‡Šæ”¾

  * è¶…å¸‚é‡Šæ”¾ï¼šè·å–é”æ—¶æ·»åŠ ä¸€ä¸ªè¶…æ—¶æ—¶é—´
    ```shell
    # é‡Šæ”¾é”ï¼Œåˆ é™¤å³å¯
    DEL key
    
    #æ·»åŠ é”ï¼ŒNXæ˜¯äº’æ–¥ã€EXæ˜¯è®¾ç½®è¶…æ—¶æ—¶é—´
    SET lock thread1 EX 10 NX
    ```

---

æµç¨‹å›¾

```mermaid
%%{init: {'theme':'neutral'}}%%
flowchart LR
strat((å¼€å§‹)) --> get(å°è¯•è·å–é”) --> åˆ¤æ–­{åˆ¤æ–­ç»“æœ} --> |nil|fail(è·å–é”å¤±è´¥)
	subgraph è·å–é”
	 success(è·å–é”æˆåŠŸ) --> to(æ‰§è¡Œä¸šåŠ¡) 
	end
	åˆ¤æ–­ --> |ok|è·å–é” --> |ä¸šåŠ¡è¶…æ—¶æˆ–æœåŠ¡å®•æœºæ—¶|è‡ªåŠ¨(è‡ªåŠ¨é‡Šæ”¾é”)
	to --> é‡Šæ”¾é”(é‡Šæ”¾é”)
```

---

**æ¡ˆä¾‹ åŸºäº`Redis`å®ç°åˆ†å¸ƒå¼é”åˆçº§ç‰ˆæœ¬**
éœ€æ±‚ï¼šå®šä¹‰ä¸€ä¸ªç±»ï¼Œå®ç°ä¸‹é¢æ¥å£ï¼Œåˆ©ç”¨`Redis`å®ç°åˆ†å¸ƒå¼é”åŠŸèƒ½ã€‚

```java
public interface ILock
    /**
    * å°è¯•è·å–é”
    * @param timeoutSecé”æŒæœ‰çš„è¶…æ—¶æ—¶é—´ï¼Œè¿‡æœŸåè‡ªåŠ¨é‡Šæ”¾
    * @return trueä»£è¡¨è·å–é”æˆåŠŸï¼›falseä»£è¡¨è·å–é”å¤±è´¥
    â˜…*/
    boolean tryLock(long timeoutSec);
    /**
    * é‡Šæ”¾é”
    **/
    void unlock();
}
```

```java
package com.hmdp.utils;

import org.springframework.data.redis.core.StringRedisTemplate;

import javax.annotation.Resource;
import java.util.concurrent.TimeUnit;

public class SimpleRedisLock implements ILock {

    private String name;
    private StringRedisTemplate stringRedisTemplate;

    public static final String KEY_PREFIX = "lock:";

    public SimpleRedisLock(String name, StringRedisTemplate stringRedisTemplate) {
        this.name = name;
        this.stringRedisTemplate = stringRedisTemplate;
    }

    @Override
    public boolean tryLock(long timeoutSec) {
        //è·å–çº¿ç¨‹ID
        long threadId = Thread.currentThread().getId();
        //è·å–é”
        Boolean success = stringRedisTemplate.opsForValue()
                .setIfAbsent(KEY_PREFIX + name, threadId + "", timeoutSec, TimeUnit.SECONDS);
        return Boolean.TRUE.equals(success);
    }

    @Override
    public void unlock() {
        stringRedisTemplate.delete(KEY_PREFIX + name);
    }
}
```

```java
// 5.ä¸€äººä¸€å•
Long userId = UserHolder.getUser().getId();
// åˆ›å»ºé”å¯¹è±¡
SimpleRedisLock lock = new SimpleRedisLock("order:" + userId, stringRedisTemplate);
// è·å–é”
boolean isLock = lock.tryLock(1200);
// åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ
if (!isLock){
    // è·å–é”å¤±è´¥,è¿”å›é”™è¯¯æˆ–é‡è¯•
    return Result.fail("ä¸å…è®¸é‡å¤ä¸‹å•");
}

try {
    // è·å–ä»£ç†å¯¹è±¡ï¼ˆäº‹åŠ¡ï¼‰
    IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();
    return proxy.createVoucherOrder(voucherId);
} finally {
    //é‡Šæ”¾é”
    lock.unlock();
}
```

---

**è¯¯åˆ é—®é¢˜**

![image-20230506200307582](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230506200307582.png)

<img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230506200343946.png" alt="image-20230506200343946" style="zoom:50%;" />

---

**æ¡ˆä¾‹ æ”¹è¿›`Redis`çš„åˆ†å¸ƒå¼é”**
éœ€æ±‚ï¼šä¿®æ”¹ä¹‹å‰çš„åˆ†å¸ƒå¼é”å®ç°ï¼Œæ»¡è¶³ï¼š

1. åœ¨è·å–é”æ—¶å­˜å…¥çº¿ç¨‹æ ‡ç¤ºï¼ˆå¯ä»¥ç”¨UUIDè¡¨ç¤ºï¼‰
2. åœ¨é‡Šæ”¾é”æ—¶å…ˆè·å–é”ä¸­çš„çº¿ç¨‹æ ‡ç¤ºï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡è¯†ä¸€è‡´
   * å¦‚æœä¸€è‡´åˆ™é‡Šæ”¾é”
   * å¦‚æœä¸ä¸€è‡´åˆ™ä¸é‡Šæ”¾é”

```java
package com.hmdp.utils;

import cn.hutool.core.lang.UUID;
import org.springframework.data.redis.core.StringRedisTemplate;

import javax.annotation.Resource;
import java.util.concurrent.TimeUnit;

public class SimpleRedisLock implements ILock {

    private String name;
    private StringRedisTemplate stringRedisTemplate;

    public static final String KEY_PREFIX = "lock:";
    public static final String ID_PREFIX = UUID.randomUUID().toString(true) + "-";

    public SimpleRedisLock(String name, StringRedisTemplate stringRedisTemplate) {
        this.name = name;
        this.stringRedisTemplate = stringRedisTemplate;
    }

    @Override
    public boolean tryLock(long timeoutSec) {
        //è·å–çº¿ç¨‹ID
        String threadId = ID_PREFIX +  Thread.currentThread().getId();
        //è·å–é”
        Boolean success = stringRedisTemplate.opsForValue()
                .setIfAbsent(KEY_PREFIX + name, threadId, timeoutSec, TimeUnit.SECONDS);
        return Boolean.TRUE.equals(success);
    }

    @Override
    public void unlock() {
        // è·å–çº¿ç¨‹æ ‡è¯†
        String threadId = ID_PREFIX + Thread.currentThread().getId();
        // è·å–é”ä¸­çš„æ ‡è¯†
        String id = stringRedisTemplate.opsForValue().get(KEY_PREFIX + name);
        // åˆ¤æ–­æ ‡è¯†æ˜¯å¦ä¸€è‡´
        if (threadId.equals(id)){
            // é‡Šæ”¾é”
            stringRedisTemplate.delete(KEY_PREFIX + name);
        }
    }
}
```

---

**åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜**

<img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230506202100754.png" alt="image-20230506202100754" style="zoom:50%;" />

```
å½“é‡Šæ”¾é”æ—¶è¿›ç¨‹é˜»å¡ï¼Œå¦‚æœæ­¤æ—¶é”è¶…æ—¶ä¼šè¢«Redisé‡Šæ”¾ï¼Œæ­¤æ—¶å†æ¥ä¸€ä¸ªçº¿ç¨‹2å»è·å–é”æˆåŠŸï¼Œå½“é˜»å¡è¿›ç¨‹ä¸åœ¨é˜»å¡åä¼šç›´æ¥é‡Šæ”¾çº¿ç¨‹2è·å–çš„é”
```

ä½¿ç”¨`Redis`çš„Luaè„šæœ¬è§£å†³
`Redis`:æä¾›äº†Luaè„šæœ¬åŠŸèƒ½ï¼Œåœ¨ä¸€ä¸ªè„šæœ¬ä¸­ç¼–å†™å¤šæ¡`Redis`å‘½ä»¤ï¼Œç¡®ä¿å¤šæ¡å‘½ä»¤æ‰§è¡Œæ—¶çš„åŸå­æ€§ã€‚Luaæ˜¯ä¸€ç§ç¼–
ç¨‹è¯­è¨€ï¼Œå®ƒçš„åŸºæœ¬è¯­æ³•å¤§å®¶å¯ä»¥å‚è€ƒç½‘ç«™ï¼šhttps://Www.runoob.com/lua/lua-tutorial.html

å†™å¥½è„šæœ¬ä»¥åï¼Œéœ€è¦ç”¨`Redis`å‘½ä»¤æ¥è°ƒç”¨è„šæœ¬ï¼Œè°ƒç”¨è„šæœ¬çš„å¸¸è§å‘½ä»¤å¦‚ä¸‹ï¼š

```shell
EVAL script numkeys key [key ...] arg [arg ...]
# è°ƒç”¨è„šæœ¬
EVAL "return redis.call('set', 'name', 'jack')" 0
```

---

é‡Šæ”¾é”çš„ä¸šåŠ¡æµç¨‹æ˜¯è¿™æ ·çš„ï¼š

1.è·å–é”ä¸­çš„çº¿ç¨‹æ ‡ç¤º
2.åˆ¤æ–­æ˜¯å¦ä¸æŒ‡å®šçš„æ ‡ç¤ºï¼ˆå½“å‰çº¿ç¨‹æ ‡ç¤º)ä¸€è‡´
3.å¦‚æœä¸€è‡´åˆ™é‡Šæ”¾é”ï¼ˆåˆ é™¤ï¼‰
4.å¦‚æœä¸ä¸€è‡´åˆ™ä»€ä¹ˆéƒ½ä¸åš

```lua
-- è¿™é‡Œçš„KEYSã€Œ1]å°±æ˜¯é”çš„key,è¿™é‡Œçš„ARGV[17
-- å°±æ˜¯å½“å‰çº¿ç¨‹æ ‡ç¤º
-- è·å–é”ä¸­çš„æ ‡è¯†ï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡è¯†ä¸€è‡´
if (redis.call('GET',KEYS[1]) == ARGV[1]) then
	-- ä¸€è‡´ï¼Œåˆ™åˆ é™¤é”
	return redis.call('DEL',KEYS[1])
end
-- ä¸ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿”å›
return 0
```

---

**æ¡ˆä¾‹ å†æ¬¡æ”¹è¿›`Redis`çš„åˆ†å¸ƒå¼é”**

éœ€æ±‚ï¼šåŸºäºLuaè„šæœ¬å®ç°åˆ†å¸ƒå¼é”çš„é‡Šæ”¾é”é€»è¾‘

æç¤ºï¼š`RedisTemplate`è°ƒç”¨Luaè„šæœ¬çš„APIå¦‚ä¸‹ï¼š

```java
@Overried
public <T> T execute(RedisScript<T> script, List<K> keys, Object... args){
    return scriptExecutor.execute(script, keys, args);
}
```

```lua
-- luaè„šæœ¬
if (redis.call('GET',KEYS[1]) == ARGV[1]) then
    -- ä¸€è‡´ï¼Œåˆ™åˆ é™¤é”
    return redis.call('DEL',KEYS[1])
end
-- ä¸ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿”å›
return 0
```

```java
package com.hmdp.utils;

import cn.hutool.core.lang.UUID;
import org.springframework.core.io.ClassPathResource;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.data.redis.core.script.DefaultRedisScript;
import org.springframework.data.redis.core.script.RedisScript;

import javax.annotation.Resource;
import java.util.Collections;
import java.util.concurrent.TimeUnit;

public class SimpleRedisLock implements ILock {

    private String name;
    private StringRedisTemplate stringRedisTemplate;

    public static final String KEY_PREFIX = "lock:";
    public static final String ID_PREFIX = UUID.randomUUID().toString(true) + "-";

    public static final DefaultRedisScript<Long> UNLOCK_SCRIPT;
    static {
        UNLOCK_SCRIPT = new DefaultRedisScript<>();
        UNLOCK_SCRIPT.setLocation(new ClassPathResource("unlock.lua"));
        UNLOCK_SCRIPT.setResultType(Long.class);
    }
    public SimpleRedisLock(String name, StringRedisTemplate stringRedisTemplate) {
        this.name = name;
        this.stringRedisTemplate = stringRedisTemplate;
    }

    @Override
    public boolean tryLock(long timeoutSec) {
        //è·å–çº¿ç¨‹ID
        String threadId = ID_PREFIX +  Thread.currentThread().getId();
        //è·å–é”
        Boolean success = stringRedisTemplate.opsForValue()
                .setIfAbsent(KEY_PREFIX + name, threadId, timeoutSec, TimeUnit.SECONDS);
        return Boolean.TRUE.equals(success);
    }

    @Override
    public void unlock(){
        //è°ƒç”¨luaè„šæœ¬
        stringRedisTemplate.execute(
                UNLOCK_SCRIPT,
                Collections.singletonList(KEY_PREFIX + name),
                ID_PREFIX +  Thread.currentThread().getId()
                );
    }

   /* @Override
    public void unlock() {
        // è·å–çº¿ç¨‹æ ‡è¯†
        String threadId = ID_PREFIX + Thread.currentThread().getId();
        // è·å–é”ä¸­çš„æ ‡è¯†
        String id = stringRedisTemplate.opsForValue().get(KEY_PREFIX + name);
        // åˆ¤æ–­æ ‡è¯†æ˜¯å¦ä¸€è‡´
        if (threadId.equals(id)){
            // é‡Šæ”¾é”
            stringRedisTemplate.delete(KEY_PREFIX + name);
        }
    }*/

}
```

---

**æ€»ç»“**

åŸºäº`Redis`çš„åˆ†å¸ƒå¼é”å®ç°æ€è·¯ï¼š

* åˆ©ç”¨`set nx ex`è·å–é”ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä¿å­˜çº¿ç¨‹æ ‡ç¤º
* é‡Šæ”¾é”æ—¶å…ˆåˆ¤æ–­çº¿ç¨‹æ ‡ç¤ºæ˜¯å¦ä¸è‡ªå·±ä¸€è‡´ï¼Œä¸€è‡´åˆ™åˆ é™¤é”

ç‰¹æ€§ï¼š

* åˆ©ç”¨`set nx`æ»¡è¶³äº’æ–¥æ€§
* åˆ©ç”¨`set ex`ä¿è¯æ•…éšœæ—¶é”ä¾ç„¶èƒ½é‡Šæ”¾ï¼Œé¿å…æ­»é”ï¼Œæé«˜å®‰å…¨æ€§
* åˆ©ç”¨`Redis`é›†ç¾¤ä¿è¯é«˜å¯ç”¨å’Œé«˜å¹¶å‘ç‰¹æ€§

---

**åŸºäº`Redis`çš„åˆ†å¸ƒå¼é”ä¼˜åŒ–**

åŸºäº`set nx`å®ç°çš„åˆ†å¸ƒå¼é”å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š

1. ä¸å¯é‡å…¥
   * åŒä¸€ä¸ªçº¿ç¨‹æ— æ³•å¤šæ¬¡è·å–åŒä¸€æŠŠé”
2. ä¸å¯é‡è¯•
   * è·å–é”åªå°è¯•ä¸€æ¬¡å°±è¿”å›`false`,æ²¡æœ‰é‡è¯•æœºåˆ¶
3. è¶…æ—¶é‡Šæ”¾
   * é”è¶…æ—¶é‡Šæ”¾è™½ç„¶å¯ä»¥é¿å…æ­»é”ï¼Œä½†å¦‚æœæ˜¯ä¸šåŠ¡æ‰§è¡Œè€—æ—¶è¾ƒé•¿ï¼Œä¹Ÿä¼šå¯¼è‡´é”é‡Šæ”¾ï¼Œå­˜åœ¨å®‰å…¨éšæ‚£
4. ä¸»ä»ä¸€è‡´æ€§
   * å¦‚æœ`Redis`æä¾›äº†ä¸»ä»é›†ç¾¤ï¼Œä¸»ä»åŒæ­¥å­˜åœ¨å»¶è¿Ÿï¼Œå½“ä¸»å®•æœºæ—¶ï¼Œå¦‚æœä»å¹¶åŒæ­¥ä¸»ä¸­çš„é”æ•°æ®ï¼Œåˆ™ä¼šå‡ºç°é”å®ç°

#### **`Redisson`**

`Redisson`æ˜¯ä¸€ä¸ªåœ¨`Redis`çš„åŸºç¡€ä¸Šå®ç°çš„avaé©»å†…å­˜æ•°æ®ç½‘æ ¼(In-Memory Data Grid)ã€‚å®ƒä¸ä»…æä¾›äº†ä¸€ç³»åˆ—çš„åˆ†å¸ƒå¼
çš„`java`å¸¸ç”¨å¯¹è±¡ï¼Œè¿˜æä¾›äº†è®¸å¤šåˆ†å¸ƒå¼æœåŠ¡ï¼Œå…¶ä¸­å°±åŒ…å«äº†å„ç§åˆ†å¸ƒå¼é”çš„å®ç°ã€‚

<img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230506222548035.png" alt="image-20230506222548035" style="zoom:50%;" />

å®˜ç½‘åœ°å€ï¼šhttps://redisson.org
GitHubåœ°å€ï¼šhttps://github.com/redisson/redisson

---

**`Redission` å…¥é—¨**

1. å¼•å…¥ä¾èµ–

```xml
<dependency>
    <groupId>org.redisson</groupId>
    <artifactId>redisson</artifactId>
    <version>3.13.6</version>
</dependency>
```

2. é…ç½®`Redission`

```java
@Configuration
public class RedisConfig{
    @Bean
    public Redissonclientredissonclient(){
        //é…ç½®ç±»
        Config config new Config();
        //æ·»åŠ redis.åœ°å€ï¼Œè¿™é‡Œæ·»åŠ äº†å•ç‚¹çš„åœ°å€ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨config.useclusterServers()æ·»åŠ é›†ç¾¤åœ°å€
        config.usesingleServer().setAddress("redis://192.168.150.101:6379").setPassowrd("123321");
        //åˆ›å»ºå®¢æˆ·ç«¯
        return Redisson.create(config);
	}
}
```

3. ä½¿ç”¨`Redission`çš„åˆ†å¸ƒå¼é”

```java
@Resource
private Redissonclient redissonclient;
@Test
void testRedisson()throws InterruptedException{
    // è·å–é”ï¼ˆå¯é‡å…¥ï¼‰ï¼ŒæŒ‡å®šé”çš„åç§°
    RLock lock = redissonclient.getLock("anyLock");
    // å°è¯•è·å–é”ï¼Œå‚æ•°åˆ†åˆ«æ˜¯ï¼šè·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆæœŸé—´ä¼šé‡è¯•ï¼‰ï¼Œé”è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ï¼Œæ—¶é—´å•ä½
    boolean isLock lock.tryLock(1,10,TimeUnit.SECONDS);
    //åˆ¤æ–­é‡Šæ”¾è·å–æˆåŠŸ
    if(isLock){
    	try{
            System.out.println("æ‰§è¡Œä¸šåŠ¡")ï¼›
    	}finally{
             // é‡Šæ”¾é”
    		lock.unlock();
        }
    }
}
```

---

**`Redisson`å¯é‡å…¥é”åŸç†**

<img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230507140113175.png" alt="image-20230507140113175" style="zoom:50%;" />

<img src="C:/Users/luoyifei/AppData/Roaming/Typora/typora-user-images/image-20230507140054993.png" alt="image-20230507140054993" style="zoom:50%;" />

---

**é”é‡è¯•å’Œ`WacthDog`æœºåˆ¶**

**è·å–é” \ é‡Šæ”¾é”æµç¨‹ï¼š**

![image-20230508211058785](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230508211058785.png)

---

**æ€»ç»“ï¼š**

**`Redisson`åˆ†å¸ƒå¼é”åŸç†ï¼š**

* **å¯é‡å…¥**ï¼šåˆ©ç”¨Hashç»“æ„è®°å½•çº¿ç¨‹idå’Œé‡å…¥æ¬¡æ•°
* **å¯é‡è¯•**ï¼šåˆ©ç”¨ä¿¡å·é‡å’Œ`PubSub`åŠŸèƒ½å®ç°ç­‰å¾…ã€å”¤é†’ï¼Œè·å–é”å¤±è´¥çš„é‡è¯•æœºåˆ¶
* **è¶…æ—¶ç»­çº¦**ï¼šåˆ©ç”¨`WatchDog`æœºåˆ¶ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆ`releaseTime`/3ï¼‰,é‡ç½®è¶…æ—¶æ—¶é—´

---

**`Redisson`åˆ†å¸ƒå¼é”ä¸»ä»ä¸€è‡´æ€§é—®é¢˜:**

`Redisson`é€šè¿‡`multiLock`æ¥è§£å†³ä¸»ä»ä¸€è‡´æ€§é—®é¢˜ï¼š

![image-20230508214228870](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230508214228870.png)

---

**æ€»ç»“**

1. ä¸å¯é‡å…¥é”`Redis`åˆ†å¸ƒå¼é”:

* åŸç†ï¼šåˆ©ç”¨`setnx`çš„äº’æ–¥æ€§ï¼›åˆ©ç”¨exé¿å…æ­»é”ï¼›é‡Šæ”¾é”æ—¶åˆ¤æ–­çº¿ç¨‹æ ‡è¯†ï¼›
* ç¼ºé™·ï¼šä¸å¯é‡å…¥ã€æ— æ³•é‡è¯•ã€é”è¶…æ—¶å¤±æ•ˆ

2. å¯é‡å…¥çš„`Redis`åˆ†å¸ƒå¼é”:

* åŸç†ï¼šåˆ©ç”¨Hashç»“æ„ï¼Œè®°å½•çº¿ç¨‹æ ‡è¯†å’Œé‡å…¥æ¬¡æ•°ï¼›åˆ©ç”¨`watchDog`æœºåˆ¶å»¶ç»­é”è¿‡æœŸæ—¶é—´ï¼›åˆ©ç”¨ä¿¡å·é‡æ§åˆ¶é”é‡è¯•ç­‰å¾…
* ç¼ºé™·ï¼š`redis`å®•æœºå¼•èµ·é”å¤±æ•ˆé—®é¢˜

3. `Redisson`çš„`multiLock`:

* åŸç†ï¼šå¤šä¸ªç‹¬ç«‹çš„`Redis`èŠ‚ç‚¹ï¼Œå¿…é¡»åœ¨æ‰€æœ‰èŠ‚ç‚¹éƒ½è·å–é‡å…¥é”ï¼Œæ‰ç®—è·å–æˆåŠŸ
* ç¼ºé™·ï¼šè¿ç»´æˆæœ¬é«˜ã€å®ç°å¤æ‚

---

### ğŸ‘Œ`Redis`ç§’æ€ä¼˜åŒ–

![image-20230508220925274](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230508220925274.png)

![image-20230508221651369](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230508221651369.png)

---

**æ¡ˆä¾‹ æ”¹è¿›ç§’æ€ä¸šåŠ¡ï¼Œæé«˜å¹¶å‘æ€§èƒ½**
	éœ€æ±‚ï¼š
		â‘  æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œå°†ä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°`Redis`ä¸­

```java
@Override
@Transactional
public void addSeckillVoucher(Voucher voucher) {
    // ä¿å­˜ä¼˜æƒ åˆ¸
    save(voucher);
    // ä¿å­˜ç§’æ€ä¿¡æ¯
    SeckillVoucher seckillVoucher = new SeckillVoucher();
    seckillVoucher.setVoucherId(voucher.getId());
    seckillVoucher.setStock(voucher.getStock());
    seckillVoucher.setBeginTime(voucher.getBeginTime());
    seckillVoucher.setEndTime(voucher.getEndTime());
    seckillVoucherService.save(seckillVoucher);
    // ä¿å­˜ç§’æ€åº“å­˜åˆ°Rediså½“ä¸­
    stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString());
}
```

â€‹		â‘¡ åŸºäºLuaè„šæœ¬ï¼Œåˆ¤æ–­ç§’æ€åº“å­˜ã€ä¸€äººä¸€å•ï¼Œå†³å®šç”¨æˆ·æ˜¯å¦æŠ¢è´­æˆåŠŸ

```lua
-- 1.å‚æ•°åˆ—è¡¨
-- 1.1 ä¼˜æƒ åˆ¸ID
local voucherId = ARGV[1]
-- 1.2 ç”¨æˆ·ID
local userId = ARGV[2]

-- 2.æ•°æ®KEY
-- 2.1 åº“å­˜Key
local stockKey = 'seckill:stock:' .. voucherId
-- 2.2 è®¢å•Key
local orderKey = 'seckill:order:' .. voucherId


-- 3.è„šæœ¬ä¸šåŠ¡
-- 3.1 åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ get stockKey
if(tonumber(redis.call('get', stockKey)) <= 0) then
    -- 3.2 åº“å­˜ä¸è¶³
    return 1
end
-- 3.2åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å• SISMEMBER orderKey userId
if ((redis.call('sismember', orderKey, userId)) == 1) then
    -- 3.3 å­˜åœ¨ï¼Œå³é‡å¤ä¸‹å•
    return 2
end

-- 3.4 æ‰£åº“å­˜
redis.call('incrby', stockKey, -1)

-- 3.5 ä¸‹å•
redis.call('sadd', orderKey, userId)

return 0
```

```java
 @Override
public Result seckillVoucher(Long voucherId) {
    Long userId = UserHolder.getUser().getId();
    // 1.æ‰§è¡Œluaè„šæœ¬
    Long result = stringRedisTemplate.execute(
            SECKILL_SCRIPT,
            Collections.emptyList(),
            voucherId.toString(),
            userId.toString()
    );
    // 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0
    int r = result.intValue();
    if (r != 0){
        // 2.1 ä¸ä¸º0,ä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼
        return Result.fail(r == 1 ? "åº“å­˜ä¸è¶³" : "ä¸èƒ½é‡å¤ä¸‹å•");
    }
    // 2.2 ä¸º0,æœ‰è´­ä¹°èµ„æ ¼,æŠŠä¸‹å•ä¿¡æ¯ä¿å­˜åˆ°é˜»å¡é˜Ÿåˆ—
    long orderId = redisIdWorker.nextId("order");
    // TODO ä¿å­˜åˆ°é˜»å¡é˜Ÿåˆ—

    // 3.è¿”å›è®¢å•id
    return Result.ok(orderId);
}
```

â€‹		â‘¢ å¦‚æœæŠ¢è´­æˆåŠŸï¼Œå°†ä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idå°è£…åå­˜å…¥é˜»å¡é˜Ÿåˆ—

â€‹		â‘£ å¼€å¯çº¿ç¨‹ä»»åŠ¡ï¼Œä¸æ–­ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå®ç°å¼‚æ­¥ä¸‹å•åŠŸèƒ½

```java
// åˆ›å»ºé˜»å¡é˜Ÿåˆ—
private BlockingQueue<VoucherOrder> orderTasks = new ArrayBlockingQueue<>(1024 * 1024);
// åˆ›å»ºçº¿ç¨‹æ± 
private static final ExecutorService SECKILL_ORDER_EXECUTOR = Executors.newSingleThreadExecutor();
// è¯¥æ³¨è§£ä¼šå…¶æ ‡æ³¨æ–¹æ³•åœ¨è¯¥ç±»è¢«åˆå§‹åŒ–æ—¶æ‰§è¡Œ
@PostConstruct
private void init(){
    SECKILL_ORDER_EXECUTOR.submit(new VoucherOrderHandler());
}
// åˆ›å»ºçº¿ç¨‹ä»»åŠ¡
private class VoucherOrderHandler implements Runnable{

    @Override
    public void run() {
        while (true){
            // 1.è·å–é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯
            try {
                VoucherOrder voucherOrder = orderTasks.take();
                // 2.åˆ›å»ºè®¢å•
                handleVoucherOrder(voucherOrder);
            } catch (Exception e) {
                log.error("å¤„ç†è®¢å•å¼‚å¸¸", e);
            }
        }
    }
}

// å…¨é€‰çº¿ç¨‹æ˜¯å–ä¸åˆ°ç”¨æˆ·çš„
private void handleVoucherOrder(VoucherOrder voucherOrder) {    
    // Long userId = UserHolder.getUser().getId();
    // æ‰€ä»¥åªèƒ½ç”±voucherOrderè·å¾—
    Long userId = voucherOrder.getUserId();
    // åˆ›å»ºé”å¯¹è±¡
    RLock lock = redissonClient.getLock("lock:order:" + userId);
    // è·å–é”
    boolean isLock = lock.tryLock();
    // åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ
    if (!isLock){
        // è·å–é”å¤±è´¥,è¿”å›é”™è¯¯æˆ–é‡è¯•
        log.error("ä¸å…è®¸é‡å¤ä¸‹å•");
        return;
    }
    try {
        proxy.createVoucherOrder(voucherOrder);
    } finally {
        //é‡Šæ”¾é”
        lock.unlock();
    }
}

@Override
public Result seckillVoucher(Long voucherId) {
    Long userId = UserHolder.getUser().getId();
    // 1.æ‰§è¡Œluaè„šæœ¬
    Long result = stringRedisTemplate.execute(
            SECKILL_SCRIPT,
            Collections.emptyList(),
            voucherId.toString(),
            userId.toString()
    );
    // 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0
    int r = result.intValue();
    if (r != 0){
        // 2.1 ä¸ä¸º0,ä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼
        return Result.fail(r == 1 ? "åº“å­˜ä¸è¶³" : "ä¸èƒ½é‡å¤ä¸‹å•");
    }
    // 2.2 ä¸º0,æœ‰è´­ä¹°èµ„æ ¼,æŠŠä¸‹å•ä¿¡æ¯ä¿å­˜åˆ°é˜»å¡é˜Ÿåˆ—
    VoucherOrder voucherOrder = new VoucherOrder();
    // 2.3 è®¾ç½®è®¢å•ID
    long orderId = redisIdWorker.nextId("order");
    voucherOrder.setId(orderId);
    // 2.4 è®¾ç½®ç”¨æˆ·id
    voucherOrder.setUserId(userId);
    // 2.5 è®¾ç½®ä»£é‡‘åˆ¸id
    voucherOrder.setVoucherId(voucherId);
    // 2.6 æ”¾å…¥é˜»å¡é˜Ÿåˆ—
    orderTasks.add(voucherOrder);

    // 3.è·å–ä»£ç†å¯¹è±¡
    // è·å–ä»£ç†å¯¹è±¡ï¼ˆäº‹åŠ¡ï¼‰
    proxy = (IVoucherOrderService) AopContext.currentProxy();
    // 4.è¿”å›è®¢å•id
    return Result.ok(orderId);
}

@Transactional
public void createVoucherOrder(VoucherOrder voucherOrder) {
    // 5.ä¸€äººä¸€å•
    Long userId = voucherOrder.getId();
    // åˆ›å»ºé”å¯¹è±¡
    RLock redisLock = redissonClient.getLock("lock:order:" + userId);
    // å°è¯•è·å–é”
    boolean isLock = redisLock.tryLock();
    // åˆ¤æ–­
    if (!isLock){
        // è·å–é”å¤±è´¥ï¼Œç›´æ¥è¿”å›å¤±è´¥æˆ–é‡è¯•
       log.error("ä¸å…è®¸é‡å¤ä¸‹å•!");
    }
    try {
        // 5.1 æŸ¥è¯¢è®¢å•
        int count = query().eq("user_id", userId).eq("voucher_id", voucherOrder.getVoucherId()).count();
        // 5.2 åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        if (count > 0) {
            // ç”¨æˆ·å·²è´­ä¹°
            log.error("ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡");
        }
        // 6.æ‰£å‡åº“å­˜
        boolean success = seckillVoucherService.update()
                .setSql("stock = stock - 1")
                .eq("voucher_id", voucherOrder.getVoucherId())
                .gt("stock", 0)
                .update();
        if (!success) {
            // æ‰£å‡å¤±è´¥
            log.error("åº“å­˜ä¸è¶³");
        }
        this.save(voucherOrder);
    } finally {
        // é‡Šæ”¾é”
        redisLock.unlock();
    }
}
```

---

**æ€»ç»“**

> **ç§’æ€ä¸šåŠ¡çš„ä¼˜åŒ–æ€è·¯æ˜¯ä»€ä¹ˆï¼Ÿ**

â‘  å…ˆåˆ©ç”¨`Redis`å®Œæˆåº“å­˜ä½™é‡ï¼Œä¸€äººä¸€å•åˆ¤æ–­ï¼Œå®ŒæˆæŠ¢å•ä¸šåŠ¡

â‘¡ å†å°†ä¸‹å•ä¸šåŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œåˆ©ç”¨ç‹¬ç«‹çº¿ç¨‹å¼‚æ­¥ä¸‹å•

> **åŸºäºé˜»å¡é˜Ÿåˆ—çš„å¼‚æ­¥ç§’æ€å­˜åœ¨å“ªäº›é—®é¢˜?**

* å†…å­˜é™åˆ¶é—®é¢˜
* æ•°æ®å®‰å…¨é—®é¢˜

---

### ğŸ‘Œ`Redisi`æ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ç§’æ€

`æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queue)`,å­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚æœ€ç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹åŒ…æ‹¬3ä¸ªè§’è‰²ï¼š

* æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­˜å‚¨å’Œç®¡ç†æ¶ˆæ¯ï¼Œä¹Ÿè¢«ç§°ä¸º`æ¶ˆæ¯ä»£ç†ï¼ˆMessage Broker)`
* ç”Ÿäº§è€…ï¼šå‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—
* æ¶ˆè´¹è€…ï¼šä»æ¶ˆæ¯é˜Ÿåˆ—è·å–æ¶ˆæ¯å¹¶å¤„ç†æ¶ˆæ¯

```mermaid
graph LR
subgraph ç”Ÿäº§è€…
	åˆ¤æ–­ç§’æ€æ—¶é—´å’Œåº“å­˜ --> æ ¡éªŒä¸€äººä¸€å• --> å‘é€ä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idåˆ°æ¶ˆæ¯é˜Ÿåˆ—
end
ç”Ÿäº§è€… --> m[(Message Queue)] --> æ¶ˆè´¹è€…
subgraph æ¶ˆè´¹è€…
	æ¥æ”¶æ¶ˆæ¯å®Œæˆä¸‹å•
end

```

`Redis` ä¸­æä¾›äº†ä¸‰ç§ä¸åŒçš„æ–¹å¼æ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼š

* `List`ç»“æ„ï¼šåŸºäºListç»“æ„æ¨¡æ‹Ÿæ¶ˆæ¯é˜Ÿåˆ—
* `PubSub`ï¼šåŸºæœ¬çš„ç‚¹å¯¹ç‚¹æ¶ˆæ¯æ¨¡å‹
* Streamï¼šæ¯”è¾ƒå®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹

---

**åŸºäºListç»“æ„æ¨¡æ‹Ÿæ¶ˆæ¯é˜Ÿåˆ—**

æ¶ˆæ¯é˜Ÿåˆ—(Message Queue),å­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚è€Œ`Redis`çš„`list`æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¾ˆå®¹æ˜“æ¨¡æ‹Ÿå‡ºé˜Ÿåˆ—æ•ˆæœã€‚

é˜Ÿåˆ—æ˜¯å…¥å£å’Œå‡ºå£ä¸åœ¨ä¸€è¾¹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ï¼šLPUSHç»“åˆRPOPã€æˆ–è€…RPUSHç»“åˆLPOPæ¥å®ç°ã€‚

ä¸è¿‡è¦æ³¨æ„çš„æ˜¯ï¼Œå½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯æ—¶RPOPæˆ–LPOPæ“ä½œä¼šè¿”å›`null`,å¹¶ä¸åƒVMçš„é˜»å¡é˜Ÿåˆ—é‚£æ ·ä¼šé˜»å¡å¹¶ç­‰å¾…æ¶ˆæ¯
å› æ­¤è¿™é‡Œåº”è¯¥ä½¿ç”¨BRPOPæˆ–è€…BLPOPæ¥å®ç°é˜»å¡æ•ˆæœã€‚

---

**æ€»ç»“ï¼š**

åŸºäº`List`çš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ
ä¼˜ç‚¹ï¼š

* åˆ©ç”¨`Redis`å­˜å‚¨ï¼Œä¸å—é™äºVMå†…å­˜ä¸Šé™
* åŸºäº`Redis`çš„æŒä¹…åŒ–æœºåˆ¶ï¼Œæ•°æ®å®‰å…¨æ€§æœ‰ä¿è¯
* å¯ä»¥æ»¡è¶³æ¶ˆæ¯æœ‰åºæ€§

ç¼ºç‚¹ï¼š

* æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±
* åªæ”¯æŒå•æ¶ˆè´¹è€…

---

**åŸºäº`PubSub`çš„æ¶ˆæ¯é˜Ÿåˆ—**

`PubSub`ï¼ˆå‘å¸ƒè®¢é˜…)æ˜¯Redis2.0ç‰ˆæœ¬å¼•å…¥çš„æ¶ˆæ¯ä¼ é€’æ¨¡å‹ã€‚é¡¾åæ€ä¹‰ï¼Œæ¶ˆè´¹è€…å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ª`channel`,ç”Ÿäº§è€…å‘å¯¹åº”`channel`å‘é€æ¶ˆæ¯åï¼Œæ‰€æœ‰è®¢é˜…è€…éƒ½èƒ½æ”¶åˆ°ç›¸å…³æ¶ˆæ¯ã€‚

* `SUBSCRIBE channel [channel]`ï¼šè®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“
* `PUBLISH channel msg`ï¼šå‘ä¸€ä¸ªé¢‘é“å‘é€æ¶ˆæ¯
* `PSUBSCRIBE pattern [pattern]`ï¼šè®¢é˜…ä¸patternæ ¼å¼åŒ¹é…çš„æ‰€æœ‰é¢‘é“

---

**æ€»ç»“ï¼š**

åŸºäº`PubSub`çš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ
ä¼˜ç‚¹ï¼š

* é‡‡ç”¨å‘å¸ƒè®¢é˜…æ¨¡å‹ï¼Œæ”¯æŒå¤šç”Ÿäº§ã€å¤šæ¶ˆè´¹

ç¼ºç‚¹ï¼š

* ä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–
* æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±
* æ¶ˆæ¯å †ç§¯æœ‰ä¸Šé™ï¼Œè¶…å‡ºæ—¶æ•°æ®ä¸¢å¤±

---

**åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—**

`Stream`æ˜¯`Redis5.0`å¼•å…¥çš„ä¸€ç§æ–°æ•°æ®ç±»å‹ï¼Œå¯ä»¥å®ç°ä¸€ä¸ªåŠŸèƒ½éå¸¸å®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚

![image-20230509223217785](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230509223217785.png)

ä¾‹å¦‚ï¼š

![image-20230509223242364](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230509223242364.png)

è¯»å–æ¶ˆæ¯çš„æ–¹å¼ä¹‹ä¸€ï¼š`XREAD`

![image-20230509223757060](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230509223757060.png)

---

**æ€»ç»“**

STREAM:ç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADå‘½ä»¤ç‰¹ç‚¹

* æ¶ˆæ¯å¯å›æ½®
* ä¸€ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…è¯»å–
* å¯ä»¥é˜»å¡è¯»å–
* æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©

---

**åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„**

æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Group):å°†å¤šä¸ªæ¶ˆè´¹è€…åˆ’åˆ†åˆ°ä¸€ä¸ªç»„ä¸­ï¼Œç›‘å¬åŒä¸€ä¸ªé˜Ÿåˆ—ã€‚å…·å¤‡ä¸‹åˆ—ç‰¹ç‚¹ï¼š

1. æ¶ˆæ¯åˆ†æµ

> é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¼šåˆ†æµç»™ç»„å†…çš„ä¸åŒæ¶ˆè´¹è€…ï¼Œè€Œä¸æ˜¯é‡å¤æ¶ˆè´¹ï¼Œä»è€ŒåŠ å¿«æ¶ˆæ¯å¤„ç†çš„é€Ÿåº¦

2. æ¶ˆæ¯æ ‡è¯†

> æ¶ˆè´¹è€…ç»„ä¼šç»´æŠ¤ä¸€ä¸ªæ ‡ç¤ºè®°å½•æœ€åä¸€ä¸ªè¢«å¤„ç†çš„æ¶ˆæ¯ï¼Œå“ªæ€•æ¶ˆè´¹è€…å®•æœºé‡å¯ï¼Œè¿˜ä¼šä»æ ‡ç¤ºä¹‹åè¯»å–æ¶ˆæ¯ã€‚ç¡®ä¿æ¯ä¸€ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æ¶ˆè´¹

3. æ¶ˆæ¯ç¡®è®¤

> æ¶ˆè´¹è€…è·å–æ¶ˆæ¯åï¼Œæ¶ˆæ¯å¤„äº`pending`çŠ¶æ€ï¼Œå¹¶å­˜å…¥ä¸€ä¸ª`pending-list`ã€‚å½“å¤„ç†å®Œæˆåéœ€è¦é€šè¿‡`XACK`æ¥ç¡®è®¤æ¶ˆæ¯ï¼Œæ ‡è®°æ¶ˆæ¯ä¸ºå·²å¤„ç†ï¼Œæ‰ä¼šä»`pending-List`ç§»é™¤ã€‚

---

åˆ›å»ºæ¶ˆè´¹è€…ç»„ï¼š

```shell
XGROUP CREATE key groupName ID [MKSTREAM]
```

* `key`:é˜Ÿåˆ—åç§°
* `groupName`:æ¶ˆè´¹è€…ç»„åç§°
* `ID`:èµ·å§‹IDæ ‡ç¤ºï¼Œ`$`ä»£è¡¨é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªæ¶ˆæ¯ï¼Œ`0`åˆ™ä»£è¡¨é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ¶ˆæ¯
* `MKSTREAM`: é˜Ÿåˆ—ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—

å…¶ä»–å¸¸è§å‘½ä»¤ï¼š

```shell
#åˆ é™¤æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„
XGROUP DESTORY key groupName

#ç»™æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„æ·»åŠ æ¶ˆè´¹è€…
XGROUP CREATECONSUMER key groupname consumername

#åˆ é™¤æ¶ˆè´¹è€…ç»„ä¸­çš„æŒ‡å®šæ¶ˆè´¹è€…
XGROUP DELCONSUMER key groupname consumername
```

```shell
XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key ...] ID [ID ...]
```

* `group`:æ¶ˆè´¹ç»„åç§°
* `consumer`ï¼šæ¶ˆè´¹è€…åç§°ï¼Œå¦‚æœæ¶ˆè´¹è€…ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…
* `count`:æœ¬æ¬¡æŸ¥è¯¢çš„æœ€å¤§æ•°é‡
* `BLOCK milliseconds`:å½“æ²¡æœ‰æ¶ˆæ¯æ—¶æœ€é•¿ç­‰å¾…æ—¶é—´
* `NOACK`:æ— éœ€æ‰‹åŠ¨ACK,è·å–åˆ°æ¶ˆæ¯åè‡ªåŠ¨ç¡®è®¤
* STREAMS key:æŒ‡å®šé˜Ÿåˆ—åç§°
* ID:è·å–æ¶ˆæ¯çš„èµ·å§‹ID:
  * ">"ï¼šä»ä¸‹ä¸€ä¸ªæœªæ¶ˆè´¹çš„æ¶ˆæ¯å¼€å§‹
  * å…¶ä»–ï¼šæ ¹æ®æŒ‡å®šidä»`pending-list`ä¸­è·å–å·²æ¶ˆè´¹ä½†æœªç¡®è®¤çš„æ¶ˆæ¯ï¼Œä¾‹å¦‚0ï¼Œæ˜¯ä»pending-listä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯å¼€å§‹

---

**æ€»ç»“**

STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADGROUPå‘½ä»¤ç‰¹ç‚¹ï¼š

* æ¶ˆæ¯å¯å›æº¯
* å¯ä»¥å¤šæ¶ˆè´¹è€…äº‰æŠ¢æ¶ˆæ¯ï¼ŒåŠ å¿«æ¶ˆè´¹é€Ÿåº¦
* å¯ä»¥é˜»å¡è¯»å–
* æ²¡æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©
* æœ‰æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼Œä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡

|              |                   List                   |       PubSub       |                         Stream                         |
| :----------: | :--------------------------------------: | :----------------: | :----------------------------------------------------: |
|  æ¶ˆæ¯æŒä¹…åŒ–  |                   æ”¯æŒ                   |       ä¸æ”¯æŒ       |                          æ”¯æŒ                          |
|   é˜»å¡è¯»å–   |                   æ”¯æŒ                   |        æ”¯æŒ        |                          æ”¯æŒ                          |
| æ¶ˆæ¯å †ç§¯å¤„ç† | å—é™äºå†…å­˜ç©ºé—´ï¼Œå¯ä»¥åˆ©ç”¨å¤šæ¶ˆè´¹è€…åŠ å¿«å¤„ç† | å—é™äºæ¶ˆè´¹è€…ç¼“å†²åŒº | å—é™äºé˜Ÿåˆ—é•¿åº¦ï¼Œå¯ä»¥åˆ©ç”¨æ¶ˆè´¹è€…ç»„æé«˜æ¶ˆè´¹é€Ÿåº¦ï¼Œå‡å°‘å †ç§¯ |
| æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ |                  ä¸æ”¯æŒ                  |       ä¸æ”¯æŒ       |                          æ”¯æŒ                          |
|   æ¶ˆæ¯å›æº¯   |                  ä¸æ”¯æŒ                  |       ä¸æ”¯æŒ       |                          æ”¯æŒ                          |

---

**æ¡ˆä¾‹ åŸºäºRedisçš„Streamç»“æ„ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°å¼‚æ­¥ç§’æ€ä¸‹å•**
éœ€æ±‚ï¼š
â‘ åˆ›å»ºä¸€ä¸ªStreamç±»å‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåä¸º`stream.orders`

```shell
XGROUP CREATE stream.orders g1 0 MKSTREAM
```

â‘¡ä¿®æ”¹ä¹‹å‰çš„ç§’æ€ä¸‹å•Luaè„šæœ¬ï¼Œåœ¨è®¤å®šæœ‰æŠ¢è´­èµ„æ ¼åï¼Œç›´æ¥å‘`stream.orders`ä¸­æ·»åŠ æ¶ˆæ¯ï¼Œå†…å®¹åŒ…å«`voucherld`ã€`userld`ã€`orderld`

```lua
-- 1.å‚æ•°åˆ—è¡¨
-- 1.1 ä¼˜æƒ åˆ¸ID
local voucherId = ARGV[1]
-- 1.2 ç”¨æˆ·ID
local userId = ARGV[2]
-- 1.2 ç”¨æˆ·ID
local orderId = ARGV[3]

-- 2.æ•°æ®KEY
-- 2.1 åº“å­˜Key
local stockKey = 'seckill:stock:' .. voucherId
-- 2.2 è®¢å•Key
local orderKey = 'seckill:order:' .. voucherId


-- 3.è„šæœ¬ä¸šåŠ¡
-- 3.1 åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ get stockKey
if(tonumber(redis.call('get', stockKey)) <= 0) then
    -- 3.2 åº“å­˜ä¸è¶³
    return 1
end
-- 3.2åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å• SISMEMBER orderKey userId
if ((redis.call('sismember', orderKey, userId)) == 1) then
    -- 3.3 å­˜åœ¨ï¼Œå³é‡å¤ä¸‹å•
    return 2
end

-- 3.4 æ‰£åº“å­˜
redis.call('incrby', stockKey, -1)

-- 3.5 ä¸‹å•
redis.call('sadd', orderKey, userId)

--3.6 å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ— XADD stream.orders * k1 v1 k2 v2
redis.call('xadd', 'stream.orders', '*', 'userId', userId, 'voucherId', voucherId, 'id', orderId)
return 0
```

â‘¢é¡¹ç›®å¯åŠ¨æ—¶ï¼Œå¼€å¯ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡ï¼Œå°è¯•è·å–`stream.orders`ä¸­çš„æ¶ˆæ¯ï¼Œå®Œæˆä¸‹å•

```java
// åˆ›å»ºçº¿ç¨‹ä»»åŠ¡
private class VoucherOrderHandler implements Runnable{
    String queueName = "stream.orders";
    @Override
    public void run() {
        while (true){
            try {
                // 1.è·å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS stream.orders >
                List<MapRecord<String, Object, Object>> list = stringRedisTemplate.opsForStream().read(
                        Consumer.from("g1", "c1"),
                        StreamReadOptions.empty().count(1).block(Duration.ofSeconds(2)),
                        StreamOffset.create(queueName, ReadOffset.lastConsumed())
                );
                // 2.åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦è·å–æˆåŠŸ
                if (list == null || list.isEmpty()){
                    // 2.1 å¦‚æœå¤±è´¥ï¼Œè¯´æ˜æ²¡æœ‰æ¶ˆæ¯ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯
                    continue;
                }
                // 3.è§£ææ¶ˆæ¯ä¸­çš„è®¢å•ä¿¡æ¯
                MapRecord<String, Object, Object> record = list.get(0);
                Map<Object, Object> values = record.getValue();
                VoucherOrder voucherOrder = BeanUtil.fillBeanWithMap(values, new VoucherOrder(), true);
                // 3.è·å–æˆåŠŸï¼Œå¯ä»¥ä¸‹å•
                handleVoucherOrder(voucherOrder);
                // 4.ACKç¡®è®¤ SACK stream.orders g1 id
                stringRedisTemplate.opsForStream().acknowledge(queueName, "g1", record.getId());
            } catch (Exception e) {
                log.error("å¤„ç†è®¢å•å¼‚å¸¸", e);
                handlePendingList();
            }
        }
    }

    private void handlePendingList() {
        while (true){
            try {
                // 1.è·å–pending-listä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 STREAMS stream.orders 0
                List<MapRecord<String, Object, Object>> list = stringRedisTemplate.opsForStream().read(
                        Consumer.from("g1", "c1"),
                        StreamReadOptions.empty().count(1),
                        StreamOffset.create(queueName, ReadOffset.from("0"))
                );
                // 2.åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦è·å–æˆåŠŸ
                if (list == null || list.isEmpty()){
                    // 2.1 å¦‚æœå¤±è´¥ï¼Œè¯´æ˜pending-listä¸­æ²¡æœ‰æ¶ˆæ¯ï¼Œç»“æŸå¾ªç¯
                    break;
                }
                // 3.è§£ææ¶ˆæ¯ä¸­çš„è®¢å•ä¿¡æ¯
                MapRecord<String, Object, Object> record = list.get(0);
                Map<Object, Object> values = record.getValue();
                VoucherOrder voucherOrder = BeanUtil.fillBeanWithMap(values, new VoucherOrder(), true);
                // 3.è·å–æˆåŠŸï¼Œå¯ä»¥ä¸‹å•
                handleVoucherOrder(voucherOrder);
                // 4.ACKç¡®è®¤ SACK stream.orders g1 id
                stringRedisTemplate.opsForStream().acknowledge(queueName, "g1", record.getId());
            } catch (Exception e) {
                log.error("å¤„ç†pending-listè®¢å•å¼‚å¸¸", e);
                try {
                    Thread.sleep(20);
                } catch (InterruptedException ex) {
                    ex.printStackTrace();
                }
            }
        }
    }
}
@Override
public Result seckillVoucher(Long voucherId) {
    Long userId = UserHolder.getUser().getId();
    // è·å–è®¢å•ID
    long orderId = redisIdWorker.nextId("order");
    // 1.æ‰§è¡Œluaè„šæœ¬
    Long result = stringRedisTemplate.execute(
            SECKILL_SCRIPT,
            Collections.emptyList(),
            voucherId.toString(),
            userId.toString(),
            String.valueOf(orderId)
    );
    // 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0
    int r = result.intValue();
    if (r != 0){
        // 2.1 ä¸ä¸º0,ä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼
        return Result.fail(r == 1 ? "åº“å­˜ä¸è¶³" : "ä¸èƒ½é‡å¤ä¸‹å•");
    }
    // 3.è·å–ä»£ç†å¯¹è±¡
    // è·å–ä»£ç†å¯¹è±¡ï¼ˆäº‹åŠ¡ï¼‰
    proxy = (IVoucherOrderService) AopContext.currentProxy();
    // 4.è¿”å›è®¢å•id
    return Result.ok(orderId);
}
```

---

## 4.è¾¾äººæ¢åº—

### ğŸ‘Œå‘å¸ƒæ¢åº—ç…§ç‰‡

æ¢åº—ç¬”è®°ç±»ä¼¼ç‚¹è¯„ç½‘ç«™çš„è¯„ä»·ï¼Œå¾€å¾€æ˜¯å›¾æ–‡ç»“åˆã€‚å¯¹åº”çš„è¡¨æœ‰ä¸¤ä¸ªï¼š

* `tb_blog`:æ¢åº—ç¬”è®°è¡¨ï¼ŒåŒ…å«ç¬”è®°ä¸­çš„æ ‡é¢˜ã€æ–‡å­—ã€å›¾ç‰‡ç­‰
* `tb blog_comments`:å…¶ä»–ç”¨æˆ·å¯¹æ¢åº—ç¬”è®°çš„è¯„ä»·

---

**æ¡ˆä¾‹ å®ç°æŸ¥çœ‹å‘å¸ƒæ¢åº—ç¬”è®°çš„æ¥å£**
éœ€æ±‚ï¼šç‚¹å‡»é¦–é¡µçš„æ¢åº—ç¬”è®°ï¼Œä¼šè¿›å…¥è¯¦æƒ…é¡µé¢ï¼Œå®ç°è¯¥é¡µé¢çš„æŸ¥è¯¢æ¥å£ï¼š

---

### ğŸ‘Œç‚¹èµ

åœ¨é¦–é¡µçš„æ¢åº—ç¬”è®°æ’è¡Œæ¦œå’Œæ¢åº—å›¾æ–‡è¯¦æƒ…é¡µé¢éƒ½æœ‰ç‚¹èµçš„åŠŸèƒ½ï¼š

---

**æ¡ˆä¾‹ å®Œå–„ç‚¹èµåŠŸèƒ½**
éœ€æ±‚ï¼š

* åŒä¸€ä¸ªç”¨æˆ·åªèƒ½ç‚¹èµä¸€æ¬¡ï¼Œå†æ¬¡ç‚¹å‡»åˆ™å–æ¶ˆç‚¹èµ
* å¦‚æœå½“å‰ç”¨æˆ·å·²ç»ç‚¹èµï¼Œåˆ™ç‚¹èµæŒ‰é’®é«˜äº®æ˜¾ç¤ºï¼ˆå‰ç«¯å·²å®ç°ï¼Œåˆ¤æ–­å­—æ®µBlogç±»çš„`isLike`å±æ€§)

```java	
 @Override
public Result queryHotBlog(Integer current) {
    // æ ¹æ®ç”¨æˆ·æŸ¥è¯¢
    Page<Blog> page = query()
            .orderByDesc("liked")
            .page(new Page<>(current, SystemConstants.MAX_PAGE_SIZE));
    // è·å–å½“å‰é¡µæ•°æ®
    List<Blog> records = page.getRecords();
    // æŸ¥è¯¢ç”¨æˆ·
    records.forEach(blog -> {
        queryBlogUser(blog);
        isBlogLiked(blog);
    });
    return Result.ok(records);
}

@Override
public Result queryBlogById(Long id) {
    Blog blog = getById(id);
    if (blog == null) {
        return Result.fail("åšå®¢ä¸å­˜åœ¨");
    }
    queryBlogUser(blog);
    // æŸ¥è¯¢æ˜¯å¦è¢«ç‚¹èµ
    isBlogLiked(blog);
    return Result.ok(blog);
}

private void isBlogLiked(Blog blog) {
    Long userId = UserHolder.getUser().getId();
    if (userId > 0) {
        Boolean isMember = stringRedisTemplate.opsForSet().isMember(BLOG_LIKED_KEY + blog.getId(), userId.toString());
        blog.setIsLike(BooleanUtil.isTrue(isMember));
    }
}

@Override
public Result likeBlog(Long id) {
    Long userId = UserHolder.getUser().getId();
    Boolean isMember = stringRedisTemplate.opsForSet().isMember(BLOG_LIKED_KEY + id, userId.toString());
    if (BooleanUtil.isFalse(isMember)) {
        boolean isSuccess = update().setSql("liked = liked + 1").eq("id", id).update();
        if (isSuccess) {
            stringRedisTemplate.opsForSet().add(BLOG_LIKED_KEY + id, userId.toString());
        }
    } else {
        boolean isSuccess = update().setSql("liked = liked - 1").eq("id", id).update();
        if (isSuccess) {
            stringRedisTemplate.opsForSet().remove(BLOG_LIKED_KEY + id, userId.toString());
        }
    }
    return Result.ok();
}
```

---

### ğŸ‘Œç‚¹èµæ’è¡Œæ¦œ

åœ¨æ¢åº—ç¬”è®°çš„è¯¦æƒ…é¡µé¢ï¼Œåº”è¯¥æŠŠç»™è¯¥ç¬”è®°ç‚¹èµçš„äººæ˜¾ç¤ºå‡ºæ¥ï¼Œæ¯”å¦‚æœ€æ—©ç‚¹èµçš„TOP5,å½¢æˆç‚¹èµæ’è¡Œæ¦œï¼š

---

**æ¡ˆä¾‹ å®ç°æŸ¥è¯¢ç‚¹èµæ’è¡Œæ¦œçš„æ¥å£**
éœ€æ±‚ï¼šæŒ‰ç…§ç‚¹èµæ—¶é—´å…ˆåæ’åºï¼Œè¿”å›Top5çš„ç”¨æˆ·

![image-20230512205432498](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230512205432498.png)

```java
@Override
public Result likeBlog(Long id) {
    Long userId = UserHolder.getUser().getId();
    Double score = stringRedisTemplate.opsForZSet().score(BLOG_LIKED_KEY + id, userId.toString());
    if (score == null) {
        boolean isSuccess = update().setSql("liked = liked + 1").eq("id", id).update();
        // zadd key value score
        if (isSuccess) {
            // æ”¹ä¸ºZSETæ•°æ®ç±»å‹
            stringRedisTemplate.opsForZSet().add(BLOG_LIKED_KEY + id, userId.toString(), System.currentTimeMillis());
        }
    } else {
        boolean isSuccess = update().setSql("liked = liked - 1").eq("id", id).update();
        if (isSuccess) {
            stringRedisTemplate.opsForZSet().remove(BLOG_LIKED_KEY + id, userId.toString());
        }
    }
    return Result.ok();
}

@Override
public Result queryBlogLikes(Long id) {
    // zrang key 0 4
    Set<String> top5 = stringRedisTemplate.opsForZSet().range(BLOG_LIKED_KEY + id, 0, 4);
    // è§£æ
    if (top5 == null || top5.isEmpty()){
        return Result.ok(Collections.EMPTY_LIST);
    }
    List<Long> ids = top5.stream().map(Long::valueOf).collect(Collectors.toList());
    String idStr = StrUtil.join(",", ids);
    // æŸ¥è¯¢ç”¨æˆ·
    List<UserDTO> userDTOs = userService
            .query()
            .in("id", ids).last("ORDER BY FIELD(id,"+ idStr +")").list()
            .stream()
            .map(user -> BeanUtil.copyProperties(user, UserDTO.class))
            .collect(Collectors.toList());
    return Result.ok(userDTOs);
}
```

---

## 5.å¥½å‹å…³æ³¨

### ğŸ‘Œå…³æ³¨ä¸å–å…³

**æ¡ˆä¾‹ å®ç°å…³æ³¨å’Œå–å…³åŠŸèƒ½**
éœ€æ±‚ï¼šåŸºäºè¯¥è¡¨æ•°æ®ç»“æ„ï¼Œå®ç°ä¸¤ä¸ªæ¥å£ï¼š
â‘  å…³æ³¨å’Œå–å…³æ¥å£
â‘¡ åˆ¤æ–­æ˜¯å¦å…³æ³¨çš„æ¥å£

```java
package com.hmdp.service.impl;
import java.time.LocalDateTime;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.hmdp.dto.Result;
import com.hmdp.dto.UserDTO;
import com.hmdp.entity.Follow;
import com.hmdp.mapper.FollowMapper;
import com.hmdp.service.IFollowService;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.hmdp.utils.UserHolder;
import org.springframework.stereotype.Service;

/**
 * <p>
 *  æœåŠ¡å®ç°ç±»
 * </p>
 *
 * @author è™å“¥
 * @since 2021-12-22
 */
@Service
public class FollowServiceImpl extends ServiceImpl<FollowMapper, Follow> implements IFollowService {

    @Override
    public Result follow(Long followUserId, Boolean isFollow) {
        Long userId = UserHolder.getUser().getId();

        // åˆ¤æ–­isFollow
        if (isFollow) {
            Follow follow = new Follow();
            follow.setUserId(userId);
            follow.setFollowUserId(followUserId);
            save(follow);
        }else {
            remove(new QueryWrapper<Follow>()
                    .eq("user_id", userId)
                    .eq("follow_user_id",followUserId));
        }
        return Result.ok();
    }

    @Override
    public Result isFollow(Long followUserId) {
        Long userId = UserHolder.getUser().getId();
        //æŸ¥è¯¢æ˜¯å¦å…³æ³¨
        Integer count = query().eq("user_id", userId).eq("follow_user_id", followUserId).count();

        return Result.ok(count > 0);
    }
}
```

---

### ğŸ‘Œå…±åŒå…³æ³¨

**æ¡ˆä¾‹ ç°å…±åŒå…³æ³¨åŠŸèƒ½**
éœ€æ±‚ï¼šåˆ©ç”¨`Redis`ä¸­æ°å½“çš„æ•°æ®ç»“æ„ï¼Œå®ç°å…±åŒå…³æ³¨åŠŸèƒ½ã€‚åœ¨åšä¸»ä¸ªäººé¡µé¢å±•ç¤ºå‡ºå½“å‰ç”¨æˆ·ä¸åšä¸»çš„å…±åŒå¥½å‹ã€‚

```java
@Override
public Result followCommons(Long id) {
    // è·å–å½“å‰ç”¨æˆ·
    Long userId = UserHolder.getUser().getId();
    String key = "follow:" + userId;
    // æ±‚äº¤é›†
    String key2 = "follow:" + id;
    Set<String> intersect = stringRedisTemplate.opsForSet().intersect(key, key2);
    // è§£æ
    if (intersect == null || intersect.isEmpty()){
        // æ— äº¤é›†
        return Result.ok(Collections.emptyList());
    }
    List<Long> ids = intersect.stream().map(Long::valueOf).collect(Collectors.toList());
    // æŸ¥è¯¢
    List<UserDTO> users = userService.listByIds(ids).stream()
            .map(user -> BeanUtil.copyProperties(user, UserDTO.class)).collect(Collectors.toList());

    return Result.ok(users);
}
```

---

### ğŸ‘Œå…³æ³¨æ¨é€

å…³æ³¨æ¨é€ä¹Ÿå«åš`Feed`æµï¼Œç›´è¯‘ä¸ºæŠ•å–‚ã€‚ä¸ºç”¨æˆ·æŒç»­çš„æä¾›â€œæ²‰æµ¸å¼â€çš„ä½“éªŒï¼Œé€šè¿‡æ— é™ä¸‹æ‹‰åˆ·æ–°è·å–æ–°çš„ä¿¡æ¯ã€‚

![image-20230514192735016](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230514192735016.png)

![image-20230514192743075](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230514192743075.png)

`Feed æµ`çš„æ¨¡å¼

Feedæµäº§å“æœ‰ä¸¤ç§å¸¸è§æ¨¡å¼ï¼š
â— Timelineï¼šä¸åšå†…å®¹ç­›é€‰ï¼Œç®€å•çš„æŒ‰ç…§å†…å®¹å‘å¸ƒæ—¶é—´æ’åºï¼Œå¸¸ç”¨äºå¥½å‹æˆ–å…³æ³¨ã€‚ä¾‹å¦‚æœ‹å‹åœˆ

* ä¼˜ç‚¹ï¼šä¿¡æ¯å…¨é¢ï¼Œä¸ä¼šæœ‰ç¼ºå¤±ã€‚å¹¶ä¸”å®ç°ä¹Ÿç›¸å¯¹ç®€å•

* ç¼ºç‚¹ï¼šä¿¡æ¯å™ªéŸ³è¾ƒå¤šï¼Œç”¨æˆ·ä¸ä¸€å®šæ„Ÿå…´è¶£ï¼Œå†…å®¹è·å–æ•ˆç‡ä½

  * æ‹‰æ¨¡å¼ï¼šè¯»æ‰©æ•£
  * æ¨æ¨¡å¼ï¼šå†™æ‰©æ•£
  * æ¨æ‹‰ç»“åˆï¼š

  ![image-20230514194402346](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230514194402346.png)

â— æ™ºèƒ½æ’åºï¼šåˆ©ç”¨æ™ºèƒ½ç®—æ³•å±è”½æ‰è¿è§„çš„ã€ç”¨æˆ·ä¸æ„Ÿå…´è¶£çš„å†…å®¹ã€‚æ¨é€ç”¨æˆ·æ„Ÿå…´è¶£ä¿¡æ¯æ¥å¸å¼•ç”¨æˆ·

* ä¼˜ç‚¹ï¼šæŠ•å–‚ç”¨æˆ·æ„Ÿå…´è¶£ä¿¡æ¯ï¼Œç”¨æˆ·ç²˜åº¦å¾ˆé«˜ï¼Œå®¹æ˜“æ²‰è¿·
* ç¼ºç‚¹ï¼šå¦‚æœç®—æ³•ä¸ç²¾å‡†ï¼Œå¯èƒ½èµ·åˆ°åä½œç”¨

---

**æ¡ˆä¾‹ åŸºäºæ¨æ¨¡å¼å®ç°å…³æ³¨æ¨é€åŠŸèƒ½**
éœ€æ±‚ï¼š
â‘ ä¿®æ”¹æ–°å¢æ¢åº—ç¬”è®°çš„ä¸šåŠ¡ï¼Œåœ¨ä¿å­˜blogåˆ°æ•°æ®åº“çš„åŒæ—¶ï¼Œæ¨é€åˆ°ç²‰ä¸çš„æ”¶ä»¶ç®±

â‘¡æ”¶ä»¶ç®±æ»¡è¶³å¯ä»¥æ ¹æ®æ—¶é—´æˆ³æ’åºï¼Œå¿…é¡»ç”¨`Redis`çš„æ•°æ®ç»“æ„å®ç°

â‘¢æŸ¥è¯¢æ”¶ä»¶ç®±æ•°æ®æ—¶ï¼Œå¯ä»¥å®ç°åˆ†é¡µæŸ¥è¯¢

---

`Feedæµ`çš„åˆ†é¡µé—®é¢˜

`Feedæµ`ä¸­çš„æ•°æ®ä¼šä¸æ–­æ›´æ–°ï¼Œæ‰€ä»¥æ•°æ®çš„è§’æ ‡ä¹Ÿåœ¨å˜åŒ–ï¼Œå› æ­¤ä¸èƒ½é‡‡ç”¨ä¼ ç»Ÿçš„åˆ†é¡µæ¨¡å¼ã€‚

```java
@Override
public Result saveBlog(Blog blog) {
    // è·å–ç™»å½•ç”¨æˆ·
    UserDTO user = UserHolder.getUser();
    blog.setUserId(user.getId());
    // ä¿å­˜æ¢åº—åšæ–‡
    boolean isSuccess = save(blog);
    if (!isSuccess) {
        return Result.fail("æ–°å¢å¤±è´¥");
    }
    // æŸ¥è¯¢ç¬”è®°ä½œè€…çš„æ‰€æœ‰ç²‰ä¸
    List<Follow> follows = followService.query().eq("follow_user_id", user.getId()).list();
    // æ¨é€ç¬”è®°Idç»™æ‰€æœ‰ç²‰ä¸
    for (Follow follow : follows) {
        // è·å–ç²‰ä¸Id
        Long userId = follow.getUserId();
        // æ¨é€
        String key = "feed:" + userId;
        stringRedisTemplate.opsForZSet().add(key, blog.getId().toString(), System.currentTimeMillis());
    }
    // è¿”å›id
    return Result.ok(blog.getId());
}
```

---

**æ¡ˆä¾‹ å®ç°å…³æ³¨æ¨é€é¡µé¢çš„åˆ†é¡µæŸ¥è¯¢**
éœ€æ±‚ï¼šåœ¨ä¸ªäººä¸»é¡µçš„â€œå…³æ³¨â€å¡ç‰‡ä¸­ï¼ŒæŸ¥è¯¢å¹¶å±•ç¤ºæ¨é€çš„Blogä¿¡æ¯ï¼š

```java
@Override
public Result queryBlogOfFollow(Long max, Integer offset) {
    // 1.è·å–å½“å‰ç”¨æˆ·
    Long userId = UserHolder.getUser().getId();
    // 2.æŸ¥è¯¢æ”¶ä»¶ç®±
    String key = FEED_KEY + userId;
    Set<ZSetOperations.TypedTuple<String>> typedTuples = stringRedisTemplate.opsForZSet()
            .reverseRangeByScoreWithScores(key, 0, max, offset, 2);
    // éç©ºåˆ¤æ–­
    if (typedTuples == null || typedTuples.isEmpty()){
        return Result.ok();
    }
    // 3.è§£ææ•°æ®ï¼šblogIdã€score(æ—¶é—´æˆ³)ã€offset
    List<Long> ids = new ArrayList<>(typedTuples.size());
    long minTime = 0;
    int os = 1;
    for (ZSetOperations.TypedTuple<String> typedTuple : typedTuples) {
        // 3.1 è·å–id
        ids.add(Long.valueOf(typedTuple.getValue()));
        // 3.2 è·å–åˆ†æ•°(æ—¶é—´æˆ³)
        long time = typedTuple.getScore().longValue();
        if (time == minTime){
            os++;
        }else {
            minTime = time;
            os = 1;
        }
    }
    // 4.æ ¹æ®idæŸ¥è¯¢blog
    String idStr = StrUtil.join(",", ids);
    List<Blog> blogs = query().in("id", ids).last("ORDER BY FIELD(id, " + idStr + ")").list();
    for (Blog blog : blogs) {
        // 4.1æŸ¥è¯¢æœ‰å…³çš„ç”¨æˆ·
        queryBlogUser(blog);
        // 4.2æŸ¥è¯¢æ˜¯å¦è¢«ç‚¹èµ
        isBlogLiked(blog);
    }
    // 5.å°è£…è¿”å›
    ScrollResult r = new ScrollResult();
    r.setList(blogs);
    r.setOffset(os);
    r.setMinTime(minTime);
    return Result.ok(r);
}
```

---

## 6.é™„è¿‘çš„å•†æˆ·

### ğŸ‘Œ**GEOæ•°æ®ç±»å‹**å­¦ä¹ 

GEOå°±æ˜¯Geolocationçš„ç®€å†™å½¢å¼ï¼Œä»£è¡¨åœ°ç†åæ ‡ã€‚`Redis`åœ¨3.2ç‰ˆæœ¬ä¸­åŠ å…¥äº†å¯¹GE0çš„æ”¯æŒï¼Œå…è®¸å­˜å‚¨åœ°ç†åæ ‡ä¿¡æ¯ï¼Œå¸®
åŠ©æˆ‘ä»¬æ ¹æ®ç»çº¬åº¦æ¥æ£€ç´¢æ•°æ®ã€‚å¸¸è§çš„å‘½ä»¤æœ‰ï¼š

> GEOADD:æ·»åŠ ä¸€ä¸ªåœ°ç†ç©ºé—´ä¿¡æ¯ï¼ŒåŒ…å«ï¼šç»åº¦(longitude)ã€çº¬åº¦(latitude)ã€å€¼ï¼ˆmember)
>
> GEODIST:è®¡ç®—æŒ‡å®šçš„ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»å¹¶è¿”å›
>
> GEOHASH:å°†æŒ‡å®šmemberçš„åæ ‡è½¬ä¸ºhashå­—ç¬¦ä¸²å½¢å¼å¹¶è¿”å›
>
> GEOPOS:è¿”å›æŒ‡å®šmemberçš„åæ ‡
>
> GEORADIUS:æŒ‡å®šåœ†å¿ƒã€åŠå¾„ï¼Œæ‰¾åˆ°è¯¥åœ†å†…åŒ…å«çš„æ‰€æœ‰member,å¹¶æŒ‰ç…§ä¸åœ†å¿ƒä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚6.2ä»¥åå·²åºŸå¼ƒ
>
> GEOSEARCH:åœ¨æŒ‡å®šèŒƒå›´å†…æœç´¢member,å¹¶æŒ‰ç…§ä¸æŒ‡å®šç‚¹ä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚èŒƒå›´å¯ä»¥æ˜¯åœ†å½¢æˆ–çŸ©å½¢ã€‚6.2.æ–°åŠŸèƒ½
>
> GEOSEARCHSTORE:ä¸GEOSEARCHåŠŸèƒ½ä¸€è‡´ï¼Œä¸è¿‡å¯ä»¥æŠŠç»“æœå­˜å‚¨åˆ°ä¸€ä¸ªæŒ‡å®šçš„keyã€‚6.2.æ–°åŠŸèƒ½

---

**æ¡ˆä¾‹ ç»ƒä¹ `Redis`çš„GEOåŠŸèƒ½**
éœ€æ±‚ï¼š

1. æ·»åŠ ä¸‹é¢å‡ æ¡æ•°æ®ï¼š
   	-åŒ—äº¬å—ç«™(116.378248 39.865275)
   	-åŒ—äº¬ç«™ï¼ˆ116.42803 39.903738)
   	-åŒ—äº¬è¥¿ç«™ï¼ˆ116.322287 39.893729)

```shell
GEOADD g1 116.378248 39.865275 bjn 116.42803 39.903738 bjz 116.322287 39.893729 bjx
```

2. è®¡ç®—åŒ—äº¬è¥¿ç«™åˆ°åŒ—äº¬ç«™çš„è·ç¦»

```shell
 GEODIST g1 bjn bjz km
```

3. æœç´¢å¤©å®‰é—¨ï¼ˆ116.39790439.909005)é™„è¿‘10kmå†…çš„æ‰€æœ‰ç«è½¦ç«™ï¼Œå¹¶æŒ‰ç…§è·ç¦»å‡åºæ’åº

```java
GEOSEARCH g1 FROMLONLAT 116.397904 39.909005 BYRADIUS 10 km WITHDIST
```

---

### **ğŸ‘Œé™„è¿‘å•†æˆ·æœç´¢**

åœ¨é¦–é¡µä¸­ç‚¹å‡»æŸä¸ªé¢‘é“ï¼Œå³å¯çœ‹åˆ°é¢‘é“ä¸‹çš„å•†æˆ·ï¼š

```java
@Override
public Result queryShopByType(Integer typeId, Integer current, Double x, Double y) {
    // 1.åˆ¤æ–­æ˜¯å¦éœ€è¦æ ¹æ®åæ ‡æŸ¥è¯¢
    if (x == null || y == null){
        // æ ¹æ®ç±»å‹åˆ†é¡µæŸ¥è¯¢
        Page<Shop> page = query()
                .eq("type_id", typeId)
                .page(new Page<>(current, SystemConstants.DEFAULT_PAGE_SIZE));
        return Result.ok(page.getRecords());
    }
    // 2.è®¡ç®—åˆ†é¡µå‚æ•° Metrics.NEUTRAL
    int from = (current - 1) * SystemConstants.DEFAULT_PAGE_SIZE;
    int end = current * SystemConstants.DEFAULT_PAGE_SIZE;
    // 3.æŸ¥è¯¢Redis,æŒ‰ç…§è·ç¦»æ’åºï¼Œåˆ†é¡µï¼Œç»“æœï¼šshopIdã€distance
    String key = SHOP_GEO_KEY + typeId;
    GeoResults<RedisGeoCommands.GeoLocation<String>> results = stringRedisTemplate.opsForGeo()
            .radius(key
                    , new Circle(new Point(x, y), new Distance(5000))
                    , RedisGeoCommands.GeoRadiusCommandArgs.newGeoRadiusArgs().limit(end).includeCoordinates().includeDistance());
    // 4.è§£æå‡ºid
    if (results == null){
        return Result.ok(Collections.emptyList());
    }
    List<GeoResult<RedisGeoCommands.GeoLocation<String>>> content = results.getContent();
    if (content.size() <= from){
        // æ²¡æœ‰ä¸‹ä¸€é¡µ
        return Result.ok(Collections.emptyList());
    }
    // 4.1æˆªå–ä»fromåˆ°endçš„éƒ¨åˆ†
    List<Long> ids = new ArrayList<>(content.size());
    Map<String, Distance> distanceMap = new HashMap<>(content.size());
    content.stream().skip(from).forEach(result -> {
        // 4.2è·å–åº—é“ºid
        String shopIdStr = result.getContent().getName();
        ids.add(Long.valueOf(shopIdStr));
        // 4.3è·å–è·ç¦»
        Distance distance = result.getDistance();
        distanceMap.put(shopIdStr,distance);
    });
    // 5.æ ¹æ®idæŸ¥è¯¢Shop
    String idStr = StrUtil.join(",", ids);
    List<Shop> shops = query().in("id", ids).last("ORDER BY FIELD(id, " + idStr + ")").list();
    for (Shop shop : shops) {
        shop.setDistance(distanceMap.get(shop.getId().toString()).getValue());
    }
    // è¿”å›æ•°æ®
    return Result.ok(shops);
}
```

---

## 7.ç”¨æˆ·ç­¾åˆ°

### ğŸ‘ŒBitMap ç”¨æ³•

`Redis`ä¸­æ˜¯åˆ©ç”¨string:ç±»å‹æ•°æ®ç»“æ„å®ç°`BitMap`,å› æ­¤æœ€å¤§ä¸Šé™æ˜¯512M,è½¬æ¢ä¸ºbitåˆ™æ˜¯2^32ä¸ªbitä½ã€‚
`BitMap`çš„æ“ä½œå‘½ä»¤æœ‰ï¼š

> SETBIT:å‘æŒ‡å®šä½ç½®ï¼ˆoffset)å­˜å…¥ä¸€ä¸ª0æˆ–1
>
> GETBITï¼šè·å–æŒ‡å®šä½ç½®(offset)çš„bitå€¼
>
> BITCOUNT:ç»Ÿè®¡`BitMap`ä¸­å€¼ä¸º1çš„bitä½çš„æ•°é‡
>
> BITFIELD:æ“ä½œï¼ˆæŸ¥è¯¢ã€ä¿®æ”¹ã€è‡ªå¢)`BitMap`ä¸­bitæ•°ç»„ä¸­çš„æŒ‡å®šä½ç½®(offset)çš„å€¼
>
> BITFIELD RO:è·å–`BitMap`ä¸­bitæ•°ç»„ï¼Œå¹¶ä»¥åè¿›åˆ¶å½¢å¼è¿”å›
>
> BITOP:å°†å¤šä¸ª`BitMap`çš„ç»“æœåšä½è¿ç®—ï¼ˆä¸ã€æˆ–ã€å¼‚æˆ–ï¼‰
>
> BITPOS:æŸ¥æ‰¾`bit`æ•°ç»„ä¸­æŒ‡å®šèŒƒå›´å†…ç¬¬ä¸€ä¸ª0æˆ–1å‡ºç°çš„ä½ç½®

### ğŸ‘Œç­¾åˆ°åŠŸèƒ½

```java
@Override
public Result sign() {
    // 1.è·å–å½“å‰ç”¨æˆ·
    Long userId = UserHolder.getUser().getId();
    // 2.è·å–æ—¥æœŸ
    LocalDateTime now = LocalDateTime.now();
    // 3.æ‹¼æ¥key
    String keySuffix = now.format(DateTimeFormatter.ofPattern(":yyyyMM"));
    String key = USER_SIGN_KEY + userId + keySuffix;
    // 4.è·å–day
    int dayOfMonth = now.getDayOfMonth();
    // 5.å†™å…¥Redis
    stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - 1, true);
    return Result.ok();
}
```

### ğŸ‘Œç­¾åˆ°ç»Ÿè®¡

**é—®é¢˜1ï¼šä»€ä¹ˆå«åšè¿ç»­ç­¾åˆ°å¤©æ•°ï¼Ÿ**
ä»æœ€åä¸€æ¬¡ç­¾åˆ°å¼€å§‹**å‘å‰**ç»Ÿè®¡ï¼Œç›´åˆ°é‡åˆ°**ç¬¬ä¸€æ¬¡**æœªç­¾åˆ°ä¸ºæ­¢ï¼Œè®¡ç®—æ€»çš„ç­¾åˆ°æ¬¡æ•°ï¼Œå°±æ˜¯è¿ç»­ç­¾åˆ°å¤©æ•°ã€‚

**é—®é¢˜2ï¼šå¦‚ä½•å¾—åˆ°æœ¬æœˆåˆ°ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰ç­¾åˆ°æ•°æ®ï¼Ÿ**

```
BITFIELD key GET u[dayOfMonth ]0
```

**é—®é¢˜3ï¼šå¦‚ä½•ä»åå‘å‰éå†æ¯ä¸ªbitä½ï¼Ÿ**
ä¸1åšä¸è¿ç®—ï¼Œå°±èƒ½å¾—åˆ°æœ€åä¸€ä¸ªbitä½ã€‚
éšåå³ç§»1ä½ï¼Œä¸‹ä¸€ä¸ªbitä½å°±æˆä¸ºäº†æœ€åä¸€ä¸ªbitä½ã€‚

---

**æ¡ˆä¾‹ å®ç°ç­¾åˆ°ç»Ÿè®¡åŠŸèƒ½**
éœ€æ±‚ï¼šå®ç°ä¸‹é¢æ¥å£ï¼Œç»Ÿè®¡å½“å‰ç”¨æˆ·æˆªæ­¢å½“å‰æ—¶é—´åœ¨æœ¬æœˆçš„è¿ç»­ç­¾åˆ°å¤©æ•°

```java
@Override
public Result signCount() {
    // 1.è·å–å½“å‰ç”¨æˆ·
    Long userId = UserHolder.getUser().getId();
    // 2.è·å–æ—¥æœŸ
    LocalDateTime now = LocalDateTime.now();
    // 3.æ‹¼æ¥key
    String keySuffix = now.format(DateTimeFormatter.ofPattern(":yyyyMM"));
    String key = USER_SIGN_KEY + userId + keySuffix;
    // 4.è·å–day
    int dayOfMonth = now.getDayOfMonth();
    // 5.è·å–æˆªæ­¢åˆ°ä»Šå¤©çš„æ‰€æœ‰ç­¾åˆ°è®°å½•ï¼Œè¿”å›åè¿›åˆ¶æ•°å­—
    List<Long> result = stringRedisTemplate.opsForValue().bitField(key,
            BitFieldSubCommands.create()
                    .get(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth))
                    .valueAt(0)
    );
    if (result == null || result.isEmpty()) {
        return Result.ok();
    }
    Long num = result.get(0);
    if (num == null || num == 0){
        return Result.ok();
    }
    // 6.å¾ªç¯éå†
    int count = 0;
    while (true){
        // 6.1 ä¸1ä½œä¸è¿ç®—ï¼Œå¾—åˆ°æœ€åä¸€ä¸ªbitä½
        // 6.2 åˆ¤æ–­è¿™ä¸ªbitä½æ˜¯å¦ä¸º0
        if ((num & 1) == 0){
            // 6.3 å¦‚æœä¸º0ï¼Œè¯´æ˜æœªç­¾åˆ°ï¼Œç»“æŸ
            break;
        }else {
            // 6.4 ä¸ä¸º0ï¼Œè¯´æ˜å·²ç­¾åˆ°ï¼Œè®¡æ•°å™¨+1
            count++;
        }
        //æŠŠæ•°å­—å³ç§»ä¸€ä½ï¼ŒæŠ›å¼ƒæœ€åä¸€ä¸ªbitä½ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªbitä½
        num >>>= 1;
    }
    return Result.ok(count);
}
```

---

## 8.UVç»Ÿè®¡

### `HyperLogLog`ç”¨æ³•

é¦–å…ˆæˆ‘ä»¬ææ‡‚ä¸¤ä¸ªæ¦‚å¿µï¼š

* **UV**ï¼šå…¨ç§°`Unique Visitor`,ä¹Ÿå«ç‹¬ç«‹è®¿å®¢é‡ï¼Œæ˜¯æŒ‡é€šè¿‡äº’è”ç½‘è®¿é—®ã€æµè§ˆè¿™ä¸ªç½‘é¡µçš„è‡ªç„¶äººã€‚Iå¤©å†…åŒä¸€ä¸ªç”¨æˆ·å¤šæ¬¡è®¿
  é—®è¯¥ç½‘ç«™ï¼Œåªè®°å½•1æ¬¡ã€‚
* **PV**ï¼šå…¨ç§°`Page View`,ä¹Ÿå«é¡µé¢è®¿é—®é‡æˆ–ç‚¹å‡»é‡ï¼Œç”¨æˆ·æ¯è®¿é—®ç½‘ç«™çš„ä¸€ä¸ªé¡µé¢ï¼Œè®°å½•1æ¬¡PV,ç”¨æˆ·å¤šæ¬¡æ‰“å¼€é¡µé¢ï¼Œåˆ™
  è®°å½•å¤šæ¬¡PVã€‚å¾€å¾€ç”¨æ¥è¡¡é‡ç½‘ç«™çš„æµé‡ã€‚

---

`Hyperloglog`(HLL)æ˜¯ä»Loglogç®—æ³•æ´¾ç”Ÿçš„æ¦‚ç‡ç®—æ³•ï¼Œç”¨äºç¡®å®šéå¸¸å¤§çš„é›†åˆçš„åŸºæ•°ï¼Œè€Œä¸éœ€è¦å­˜å‚¨å…¶æ‰€æœ‰å€¼ã€‚ç›¸å…³ç®—æ³•
åŸç†å¤§å®¶å¯ä»¥å‚è€ƒï¼š[HyperLogLog ç®—æ³•çš„åŸç†è®²è§£ä»¥åŠ Redis æ˜¯å¦‚ä½•åº”ç”¨å®ƒçš„ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/6844903785744056333#heading-0)

`Redis`ä¸­çš„HLLæ˜¯åŸºäºstringç»“æ„å®ç°çš„ï¼Œå•ä¸ªHLLçš„å†…å­˜æ°¸è¿œå°äº16kb,å†…å­˜å ç”¨ä½çš„ä»¤äººå‘æŒ‡ï¼ä½œä¸ºä»£ä»·ï¼Œå…¶æµ‹é‡ç»“æœ
æ˜¯æ¦‚ç‡æ€§çš„ï¼Œæœ‰å°äº0.81%çš„è¯¯å·®ã€‚ä¸è¿‡å¯¹äºUVç»Ÿè®¡æ¥è¯´ï¼Œè¿™å®Œå…¨å¯ä»¥å¿½ç•¥ã€‚

![image-20230517223852581](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230517223852581.png)

---

### å®ç°UVç»Ÿè®¡

æˆ‘ä»¬ç›´æ¥åˆ©ç”¨å•å…ƒæµ‹è¯•ï¼Œå‘HyperL0gL0gä¸­æ·»åŠ 100ä¸‡æ¡æ•°æ®ï¼Œçœ‹çœ‹å†…å­˜å ç”¨å’Œç»Ÿè®¡æ•ˆæœå¦‚ä½•ï¼š

