---
title: 登录鉴权框架
date: 2024-3-5
updated: 2024-3-6
categories: "框架"
tags: 
  - "权限管理"
  - "Sa-Token"
---

# 登录鉴权框架

## [Sa-Token](https://github.com/dromara/sa-token)

> **Sa-Token** 是一个轻量级 Java 权限认证框架，主要解决：登录认证、权限认证、单点登录、OAuth2.0、分布式Session会话、微服务网关鉴权 等一系列权限相关问题。

![img](https://bed.flyone.space/%E7%AC%94%E8%AE%B0/sa-token-js4.png)

[开发文档]([框架介绍 (sa-token.cc)](https://sa-token.cc/doc.html#/))

## 鉴权设计-RBAC模型

> RBAC（Role-Based Access Control，基于角色的访问控制）是一种广泛使用的访问控制机制，它根据系统中定义的角色来管理用户和权限之间的关联。在RBAC模型中，访问权限不是直接分配给单个用户，而是分配给角色，然后用户通过被分配到一个或多个角色来获得这些角色的权限。这种模型简化了权限的管理，因为管理者只需要维护角色和角色权限，而不是每个用户的权限。
>
> RBAC模型主要包括以下几个核心概念：
>
> 1. **用户（User）**：系统的使用者，可以是人，也可以是任何需要与系统交互的实体。
> 2. **角色（Role）**：定义了一组权限的集合，这些权限代表了执行特定任务所需的能力。角色反映了组织中的职责和工作职位。
> 3. **权限（Permission）**：访问控制的具体措施，通常结合资源（如文件、数据库等）和操作（如读取、写入等）来定义。
> 4. **会话（Session）**：用户与系统交互的一个实例，在此期间，用户可以扮演一个或多个角色。
>
> RBAC支持三种主要的策略模型：
>
> - **RBAC-0（基础RBAC）**：提供最基本的RBAC支持，包括角色分配和用户到角色的映射。
> - **RBAC-1（层级RBAC）**：在基础RBAC的基础上添加了角色之间的继承关系，允许一个角色继承另一个角色的权限，从而简化权限的管理和分配。
> - **RBAC-2（受约束的RBAC）**：引入了角色之间的约束关系，比如互斥角色、基数约束（限制可以分配给特定角色的用户数），以及先决条件角色，以支持更复杂的策略和合规性要求。
>
> RBAC模型的优势在于其灵活性和简化的权限管理：通过为用户分配角色，可以轻松控制用户的访问权限，而不需要对每个用户的权限进行单独配置。这使得RBAC非常适合需要精细访问控制的大型组织或系统。

## 鉴权架构设计

1. `club-auth`模块: 

> 这个服务承载了我们所有的基础数据源。不管理鉴权，只管理数据相关的持久化操作以及业务操作，提供各种各样的权限相关的接口。

2. `nacos`:

> 将`auth`服务以及`subject`服务都注册到上面。内部进行调用，不对外暴露。通过`nacos`实现我们的服务发现。

3. `getway(网关)`

> 网关层会对外提供服务，内部实现路由，鉴权。整体我们采用`token`的方式来与前端进行交互。由网关来决定当前用户是否可以操作到后面的业务逻辑.

## 鉴权功能设计

### 用户基础模块

- 新增用户
- 修改用户
- 删除用户
- 用户启用
- 用户禁用
- 用户密码加密

### 角色基础模块

- 新增角色
- 修改角色
- 删除角色
- 角色启用禁用
- 角色与用户的关联

### 权限基础模块

- 新增权限
- 修改权限
- 删除权限
- 权限禁用与启用
- 权限的展示与隐藏
- 权限与角色的关联

## 登录注册模块

### 注册用户与验证

1. 短信验证

   - 成本主要是短信的费用

2. 邮箱验证

   - 用户注册的时候留一个邮箱，通过邮箱服务器发送链接，用户点击后实现激活，激活成功后就完成的注册
   - 0成本，但是容易进垃圾箱

3. ### 个人公众号(推荐)

   - 用户登陆后弹出公众号的码。扫码后，提示用户输入验证码。可以随机比如说nadbuge,通过我们的公众号对接的回调。能拿到一定的信息，用户的openId

4. 企业服务号（必须有营业执照）

### 登录功能

传统：登录后携带cookie，前端携带cookie请求完成验证。

token: token放入header来实现用户身份的识别与鉴权

### 踢人下线

发现风险用户，通过后台直接把用户踢掉，禁止其在访问，token 也可以置为失效的形式

### 集成 Redis

如果选择token，不做token的保存，服务重启啊，分布式微服务啊，数据是无法共享并且会产生丢失问题，所以采用`redis`来存储一些信息，实现共享

### 自定义token风格和前缀

正常的token可能是uuid。我们可以选择其他形式

token前端的传递我们也可以去定义前缀，固定前缀才生效。

### 记住我

勾选`记住我`的时候，实现自动登录

前后端分离没有token的时候，必然产生无法实现的问题，可以选择前端的`localStorage`来做

## 网关统一鉴权

检验权限，用户的角色等东西，统一放入网关执行

数据的权限获取产生问题：

1. 网关直接对接数据库，实现查询
2. redis 中获取数据，获取不到的时候还是要像第一种一样去数据库查
3. redis 中获取缓存，没有的话，从 `auth`服务里面获取相关的信息
