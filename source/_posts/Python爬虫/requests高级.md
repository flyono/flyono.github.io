---
title: requests高级
date: 2024-2-24 17:00:00
updated: 2024-2-24 17:00:00
categories: "Python爬虫"
tags: 
  - "Python"
  - "requests"
---

# requests高级

## 什么是cookie?
* cookie的本质就是一组数据（键值对的形式存在） 
* 是由服务器创建，返回给客户端，最终会保存在客户端浏览器中。 
* 如果客户端保存了cookie,则下次再次访问该服务器，就会携带cookie进行网络访问
* 典型案例：
  * 网站的免密登录
* 爬取雪球网中的咨询数据
  * url：https://xueqiu.com/
  * 需求：爬取热帖内容
  * 经过分析发现帖子的内容是通过jax动态加载出来的，因此通过抓包工具，定位到ajax请求的数据包，从数据包中提取：
    * url：: https://xueqiu.com/statuses/hot/listV2.json?since_id=-1&max_id=499057&size=15
    * 请求方式: GET
    * 请求参数: 
      * since_id: -1 
      * max_id: 499057 
      * size: 15
    * 发现没有爬取到数据
    * 分析why? 
      * 切记：只要爬虫拿不到你想要的数据，唯一的原因是爬虫程序模拟浏览器的力度不 够！一般来讲，模拟的力度重点放置在请求头中！ 
      * 上述案例，只需要在请求头`headers`中添加`cookie`即可！
    * 爬虫中Cookie的处理方式（两种方式）：
      * 手动处理：将抓包工具中的`cookie`赋值到`headers`即可
        * 缺点：
          * 编写麻烦
          * Cookie通常具有有效时长,会不断更新
          * Cookie中可能会存在会实时变化的局部数据
      * 自动处理
        * 基于session对象实现自动处理cookie
          * 1.常见空白session对象
          * 2.需要使用session对象发起请求，请求的目的是为了捕获cookie
            * 注意：如果session对象再发起请求的工程中，服务端产生了cookie,则cookie会自动存储在session对象中
          * 3.使用携带cookie的session对象，对目的的网址发起请求，就可以实现携带cookie的请求发送,从而获取想要的数据
        * 注意：session至少需要发起两次请求
          * 第一次发起请求获取cookie
          * 第二次携带cookie发起请求
## 代理
### 什么是代理
> 代理服务器
### 代理服务器的作用
> 转发请求和响应
### 爬虫为何需要使用代理
* 有些时候，需要对网站服务器发起高频的请求，网站的服务器会检测到这样的异常现 象，则会讲请求对应机器的ip地址加入黑名单，则该p再次发起的请求，网站服务器就不在受理，则我们就无法再次爬取该网站的数据。
* 使用代理后网站服务器接受到的请求,最终是由代理服务器发起，网站服务器通过 请求获取的ip就是代理服务器的ip,并不是我们客户端本身的ip。
### 代理的匿名度
* 透明：网站的服务器知道你使用了代理，也知道你的真实ip
* 匿名：网站服务器知道你使用了代理，但是无法获知你真实的ip
* 高匿：网站服务器不知道你使用了代理，也不知道你的真实p(推荐)
### 代理的类型
* http：该类型的代理服务器只可以转发Http协议的请求
* https：可以转发https协议的请求
### 如何获取代理？
> 代理精灵（不能用）
> http://http.zhiliandaili.cn/
> 
> 芝麻代理
> https://jahttp.zhimaruanjian.com/
* 深度代理
  * 对快代理进行n次请求，直到本机无法访问快代理为止（证明本机ip被快代理封掉了）
  * 构建一个代理池（封装了很多代理和端口的容器），用于数据的批量爬取
## 验证码
* 图鉴平台（推荐）：http://www.ttshitu.com/
* 超级鹰：https://www.chaojiying.com/about.html
* 使用图鉴识别古诗文网登录中的验证码
  * 古诗文网：https://so.gushiwen.cn/user/login.aspx?from=http://so.gushiwen.cn/user/collect.aspx
  * 使用流程：
    * 注册登录图鉴平台
    * 登录后，点击开发文档，提取识别的源代码
## 模拟登录
* 古诗文网
  * url：https://so.gushiwen.cn/user/login.aspx?from=http://so.gushiwen.cn/user/collect.aspx
  * 在抓包工具里定位点击登录按钮后对应的数据包：
    * 只要数据包的请求参数中包含用户名，密码和验证码则该数据包就是我们要定位的
    * 运行后打开gushiwen.html后发现没有登陆成功，可能原因：
      * 验证码不对
      * 没有携带Cookie
      * 出现了动态的请求参数
        * 如何获取动态变化的请求参数
          * 基于抓包工具全局搜索
            * 基于抓包工具进行全局搜索，发现该参数值被隐藏在了登录的页面源码中
## 防盗链
* 现在很多网站启用了防盗链反爬，防止服务器上的资源被人恶意盗取。什么是防盗链呢？
  * 以图片为例，访问图片要从他的网站访问才可以，否则直接访问图片地址得不到图片
* 练习：抓取微博图片，url:http://blog.sina.com.cn/lm/pic/ ,将页面中某一组系列详情页的图片进行抓取保存，比如三里屯时尚女郎：http://blog.sina.com.cn/s/blog_01ebcb8a0102zi2o.html?tj=1
* 注意： 
  * 1.在解析图片地址的时候，定位src的属性值，返回的内容和开发工具Element中看 到的不一样，通过network查看网页源码发现需要解析real_src的值。 
  * 2.直接请求real_src请求到的图片不显示，加上`Refere`请求头即可 
  * 3.哪里找`Refere`:抓包工具定位到某一张图片数据包，在其requests headers中获取
## 图片懒加载
* url：https://sc.chinaz.com/tupian/meinvtupian.html
* 需求：爬取上述链接中所有的图片数据
* 图片懒加载
  * 主要是应用在展示图片的网页中的一种技术，该技术是指当网页刷新后，先加载局部的几张图片数据即可，随着用户滑动滚轮，当图片被显示在浏览器的可视化区域范围的话，在动态将其图片请求加载出来即可。(图片数据是动态加载出来)
  * 如何实现图片懒加载/动态加载
    * 使用img标签的伪属性（指的是自定义的一种属性）。在网页中，为了防止图片马上加载出来，则在img标签中可以使用一种伪属性来存储图片的链接，而不是使用真正的src属性值来存储(图片链接一旦给了src属性，则图片会被立即加载出来)。只有当图片被滑动到浏览器可视化区域范围的时候，在通过js将img的伪属性修改为真正的src属性，则图片就会被加载出来。
  * 如何爬取图片懒加载的图片数据？ 
    * 只需要在解析图片的时候，定位伪属性(src2）的属性值即可。