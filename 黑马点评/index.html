<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>é»‘é©¬ç‚¹è¯„ | Fly one</title><meta name="author" content="Flyone"><meta name="copyright" content="Flyone"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="é»‘é©¬ç‚¹è¯„1.çŸ­ä¿¡ç™»å½• ğŸ‘Œæ•°æ®åº“æ„å»ºå¯¼å…¥å‡†å¤‡å¥½çš„ hmdp.sql æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹    è¡¨å æè¿°    tb_user ç”¨æˆ·è¡¨   tb_user_info ç”¨æˆ·è¯¦æƒ…è¡¨   tb_shop å•†æˆ·ä¿¡æ¯è¡¨   tb_shop_type å•†æˆ·ç±»å‹è¡¨   tb_blog ç”¨æˆ·æ—¥è®°è¡¨ï¼ˆè¾¾äººæ¢åº—æ—¥è®°ï¼‰   tb follow ç”¨æˆ·å…³æ³¨è¡¨   tb voucher ä¼˜æƒ åˆ¸è¡¨   tb_voucher ord">
<meta property="og:type" content="article">
<meta property="og:title" content="é»‘é©¬ç‚¹è¯„">
<meta property="og:url" content="https://fash.flyone.space/%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84/index.html">
<meta property="og:site_name" content="Fly one">
<meta property="og:description" content="é»‘é©¬ç‚¹è¯„1.çŸ­ä¿¡ç™»å½• ğŸ‘Œæ•°æ®åº“æ„å»ºå¯¼å…¥å‡†å¤‡å¥½çš„ hmdp.sql æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹    è¡¨å æè¿°    tb_user ç”¨æˆ·è¡¨   tb_user_info ç”¨æˆ·è¯¦æƒ…è¡¨   tb_shop å•†æˆ·ä¿¡æ¯è¡¨   tb_shop_type å•†æˆ·ç±»å‹è¡¨   tb_blog ç”¨æˆ·æ—¥è®°è¡¨ï¼ˆè¾¾äººæ¢åº—æ—¥è®°ï¼‰   tb follow ç”¨æˆ·å…³æ³¨è¡¨   tb voucher ä¼˜æƒ åˆ¸è¡¨   tb_voucher ord">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/wallhaven-yxgyyx_3840x2880.png">
<meta property="article:published_time" content="2023-05-22T16:00:00.000Z">
<meta property="article:modified_time" content="2024-01-22T16:00:00.000Z">
<meta property="article:author" content="Flyone">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/wallhaven-yxgyyx_3840x2880.png"><link rel="shortcut icon" href="/"><link rel="canonical" href="https://fash.flyone.space/%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    post: false
  },
  runtime: 'å¤©',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: {"limitCount":100,"languages":{"author":"ä½œè€…: Flyone","link":"é“¾æ¥: ","source":"æ¥æº: Fly one","info":"è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚"}},
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'é»‘é©¬ç‚¹è¯„',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-01-23 00:00:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">åŠ è½½ä¸­...</div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/QQ%E5%9B%BE%E7%89%8720210716180135.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">8</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">2</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> æ¸…å•</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/photo/"><i class="fa-fw fas fa-images"></i><span> ç…§ç‰‡</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://bed.flyone.space/%E7%AC%94%E8%AE%B0/wallhaven-yxgyyx_3840x2880.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Fly one</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> æ¸…å•</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/photo/"><i class="fa-fw fas fa-images"></i><span> ç…§ç‰‡</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">é»‘é©¬ç‚¹è¯„<a class="post-edit-link" href="https://github.com/flyono/flyono.github.io/blob/main/source/_posts/é»‘é©¬ç‚¹è¯„.md" title="ç¼–è¾‘" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2023-05-22T16:00:00.000Z" title="å‘è¡¨äº 2023-05-23 00:00:00">2023-05-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2024-01-22T16:00:00.000Z" title="æ›´æ–°äº 2024-01-23 00:00:00">2024-01-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE/">é¡¹ç›®</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">16.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>67åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="é»‘é©¬ç‚¹è¯„"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="é»‘é©¬ç‚¹è¯„"><a href="#é»‘é©¬ç‚¹è¯„" class="headerlink" title="é»‘é©¬ç‚¹è¯„"></a>é»‘é©¬ç‚¹è¯„</h1><h2 id="1-çŸ­ä¿¡ç™»å½•"><a href="#1-çŸ­ä¿¡ç™»å½•" class="headerlink" title="1.çŸ­ä¿¡ç™»å½•"></a>1.çŸ­ä¿¡ç™»å½•</h2><hr>
<h3 id="ğŸ‘Œæ•°æ®åº“æ„å»º"><a href="#ğŸ‘Œæ•°æ®åº“æ„å»º" class="headerlink" title="ğŸ‘Œæ•°æ®åº“æ„å»º"></a>ğŸ‘Œæ•°æ®åº“æ„å»º</h3><p>å¯¼å…¥å‡†å¤‡å¥½çš„ <a href="hmdp.sql">hmdp.sql</a> æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹</p>
<table>
<thead>
<tr>
<th align="left">è¡¨å</th>
<th align="left">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="left">tb_user</td>
<td align="left">ç”¨æˆ·è¡¨</td>
</tr>
<tr>
<td align="left">tb_user_info</td>
<td align="left">ç”¨æˆ·è¯¦æƒ…è¡¨</td>
</tr>
<tr>
<td align="left">tb_shop</td>
<td align="left">å•†æˆ·ä¿¡æ¯è¡¨</td>
</tr>
<tr>
<td align="left">tb_shop_type</td>
<td align="left">å•†æˆ·ç±»å‹è¡¨</td>
</tr>
<tr>
<td align="left">tb_blog</td>
<td align="left">ç”¨æˆ·æ—¥è®°è¡¨ï¼ˆè¾¾äººæ¢åº—æ—¥è®°ï¼‰</td>
</tr>
<tr>
<td align="left">tb follow</td>
<td align="left">ç”¨æˆ·å…³æ³¨è¡¨</td>
</tr>
<tr>
<td align="left">tb voucher</td>
<td align="left">ä¼˜æƒ åˆ¸è¡¨</td>
</tr>
<tr>
<td align="left">tb_voucher order</td>
<td align="left">ä¼˜æƒ åˆ¸çš„è®¢å•è¡¨</td>
</tr>
</tbody></table>
<hr>
<h3 id="ğŸ‘Œæ•´ä½“æ¶æ„"><a href="#ğŸ‘Œæ•´ä½“æ¶æ„" class="headerlink" title="ğŸ‘Œæ•´ä½“æ¶æ„"></a>ğŸ‘Œæ•´ä½“æ¶æ„</h3><p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230414214832837.png" alt="image-20230414214832837"></p>
<hr>
<h3 id="ğŸ‘Œå¯¼å…¥åç«¯é¡¹ç›®"><a href="#ğŸ‘Œå¯¼å…¥åç«¯é¡¹ç›®" class="headerlink" title="ğŸ‘Œå¯¼å…¥åç«¯é¡¹ç›®"></a>ğŸ‘Œå¯¼å…¥åç«¯é¡¹ç›®</h3><p>ä¿®æ”¹ç›¸åº”é…ç½®åï¼Œå¯åŠ¨é¡¹ç›®æµè§ˆå™¨è®¿é—®<a target="_blank" rel="noopener" href="http://localhost:8081/shop-type/list">http://localhost:8081/shop-type/list</a> å‡ºç°æ•°æ®åˆ™æ²¡æœ‰é—®é¢˜</p>
<hr>
<h3 id="ğŸ‘Œå¯¼å…¥å‰ç«¯é¡¹ç›®"><a href="#ğŸ‘Œå¯¼å…¥å‰ç«¯é¡¹ç›®" class="headerlink" title="ğŸ‘Œå¯¼å…¥å‰ç«¯é¡¹ç›®"></a>ğŸ‘Œå¯¼å…¥å‰ç«¯é¡¹ç›®</h3><p>æä¾›çš„èµ„æ–™ä¸­<code>nginx</code>ç›®å½•éƒ¨ç½²æˆ‘ä»¬éœ€è¦çš„å‰ç«¯é¡µé¢</p>
<p><strong>è¿è¡Œå‰ç«¯é¡¹ç›®</strong></p>
<p>åœ¨<code>nginx</code>æ‰€åœ¨ç›®å½•ä¸‹æ‰“å¼€ä¸€ä¸ªCMDçª—å£ï¼Œè¾“å…¥å‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start nginx.exe</span><br></pre></td></tr></table></figure>

<p>æµè§ˆå™¨æ‰“å¼€æ‰‹æœºç«¯å¼€å‘è€…å·¥å…·</p>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230414221615537.png" alt="image-20230414221615537"></p>
<hr>
<h3 id="ğŸ‘ŒåŸºäºSessionå®ç°ç™»å½•"><a href="#ğŸ‘ŒåŸºäºSessionå®ç°ç™»å½•" class="headerlink" title="ğŸ‘ŒåŸºäºSessionå®ç°ç™»å½•"></a>ğŸ‘ŒåŸºäºSessionå®ç°ç™»å½•</h3><hr>
<h4 id="å‘é€éªŒè¯ç åŠŸèƒ½"><a href="#å‘é€éªŒè¯ç åŠŸèƒ½" class="headerlink" title="å‘é€éªŒè¯ç åŠŸèƒ½"></a>å‘é€éªŒè¯ç åŠŸèƒ½</h4><p><strong>æµç¨‹å›¾</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%% å‘é€çŸ­ä¿¡éªŒè¯ç </span><br><span class="line">graph LR</span><br><span class="line">A((å¼€å§‹)) --&gt; B[æäº¤æ‰‹æœºå·];</span><br><span class="line">B --&gt; C&#123;æ ¡éªŒæ‰‹æœºå·&#125; --&gt; |ä¸ç¬¦åˆ|B</span><br><span class="line">C --&gt; |ç¬¦åˆ|D[ç”ŸæˆéªŒè¯ç ] --&gt; E[ä¿å­˜éªŒè¯ç åˆ°Session] --&gt; F[å‘é€éªŒè¯ç ] --&gt; G((ç»“æŸ))</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendCode</span><span class="params">(String phone, HttpSession session)</span> &#123;</span><br><span class="line">    <span class="comment">//1,æ ¡éªŒæ‰‹æœºå·</span></span><br><span class="line">    <span class="keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;</span><br><span class="line">        <span class="comment">//2,å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ‰‹æœºå·æ ¼å¼é”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3,ç¬¦åˆï¼Œç”ŸæˆéªŒè¯ç </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> RandomUtil.randomNumbers(<span class="number">6</span>);</span><br><span class="line">    <span class="comment">//4,ä¿å­˜éªŒè¯ç åˆ°session</span></span><br><span class="line">    session.setAttribute(<span class="string">&quot;code&quot;</span>,code);</span><br><span class="line">    <span class="comment">//5.å‘é€éªŒè¯ç </span></span><br><span class="line">    log.debug(<span class="string">&quot;å‘é€çŸ­ä¿¡éªŒè¯ç æˆåŠŸï¼ŒéªŒè¯ç ï¼š&#123;&#125;&quot;</span>,code);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="çŸ­ä¿¡éªŒè¯ç ç™»å½•å’Œæ³¨å†ŒåŠŸèƒ½"><a href="#çŸ­ä¿¡éªŒè¯ç ç™»å½•å’Œæ³¨å†ŒåŠŸèƒ½" class="headerlink" title="çŸ­ä¿¡éªŒè¯ç ç™»å½•å’Œæ³¨å†ŒåŠŸèƒ½"></a>çŸ­ä¿¡éªŒè¯ç ç™»å½•å’Œæ³¨å†ŒåŠŸèƒ½</h4><p><strong>æµç¨‹å›¾</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%% å‘é€çŸ­ä¿¡éªŒè¯ç </span><br><span class="line">graph LR</span><br><span class="line">A((å¼€å§‹)) --&gt; B[æäº¤æ‰‹æœºå·å’ŒéªŒè¯ç ];</span><br><span class="line">B --&gt; C&#123;æ ¡éªŒéªŒè¯ç &#125; --&gt; |ä¸ä¸€è‡´|B</span><br><span class="line">C --&gt; |ä¸€è‡´|D[æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·] --&gt; E[ç”¨æˆ·æ˜¯å¦å­˜åœ¨] --&gt; |ä¸å­˜åœ¨|F[åˆ›å»ºæ–°ç”¨æˆ·] --&gt; G[ä¿å­˜ç”¨æˆ·åˆ°æ•°æ®åº“] --&gt; H</span><br><span class="line">E --&gt; |å­˜åœ¨|H[ä¿å­˜ç”¨æˆ·åˆ°Session] --&gt; I((ç»“æŸ))</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;</span><br><span class="line">    <span class="comment">//1.æ ¡éªŒæ‰‹æœºå·</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">phone</span> <span class="operator">=</span> loginForm.getPhone();</span><br><span class="line">    <span class="keyword">if</span> (session.getAttribute(phone) == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//2,å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ‰‹æœºå·æ ¼å¼é”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.æ ¡éªŒéªŒè¯ç </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">cacheCode</span> <span class="operator">=</span> loginForm.getCode();</span><br><span class="line">    <span class="keyword">if</span> (cacheCode == <span class="literal">null</span> || !session.getAttribute(phone).equals(cacheCode)) &#123;</span><br><span class="line">        <span class="comment">//3.ä¸ä¸€è‡´ï¼ŒæŠ¥é”™</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;éªŒè¯ç é”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4.ä¸€è‡´ï¼Œæ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="built_in">this</span>.query().eq(<span class="string">&quot;phone&quot;</span>, phone).one();</span><br><span class="line">    <span class="comment">//5.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//6.ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·å¹¶ä¿å­˜</span></span><br><span class="line">        user = saveUserWithPhone(phone);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//7.ä¿å­˜ç”¨æˆ·ä¿¡æ¯å­™sessionä¸­</span></span><br><span class="line">    session.setAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä¿å­˜ç”¨æˆ·æ–¹æ³•</span></span><br><span class="line"><span class="keyword">private</span> User <span class="title function_">saveUserWithPhone</span><span class="params">(String phone)</span> &#123;</span><br><span class="line">    <span class="comment">//1.åˆ›å»ºç”¨æˆ·</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setPhone(phone);</span><br><span class="line">    user.setNickName(USER_NICK_NAME_PREFIX+RandomUtil.randomString(<span class="number">10</span>));</span><br><span class="line">    <span class="comment">//2.ä¿å­˜ç”¨æˆ·</span></span><br><span class="line">    <span class="built_in">this</span>.save(user);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="ç™»å½•éªŒè¯-x2F-éšè—ç”¨æˆ·æ•æ„Ÿä¿¡æ¯"><a href="#ç™»å½•éªŒè¯-x2F-éšè—ç”¨æˆ·æ•æ„Ÿä¿¡æ¯" class="headerlink" title="ç™»å½•éªŒè¯ &#x2F; éšè—ç”¨æˆ·æ•æ„Ÿä¿¡æ¯"></a>ç™»å½•éªŒè¯ &#x2F; éšè—ç”¨æˆ·æ•æ„Ÿä¿¡æ¯</h4><p><strong>æµç¨‹å›¾</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">A((å¼€å§‹)) --&gt; B[è¯·æ±‚å¹¶æºå¸¦cookie] --&gt; C[ä»sessionè·å–ç”¨æˆ·] --&gt; D&#123;åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨&#125; --&gt; |å­˜åœ¨|E[ä¿å­˜ç”¨æˆ·åˆ°ThreadLocal]</span><br><span class="line">D --&gt; |ä¸å­˜åœ¨|F[æ‹¦æˆª] --&gt; G((ç»“æŸ))</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç™»å½•æ‹¦æˆªå™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‰ç½®æ‹¦æˆªå™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//1.è·å–session</span></span><br><span class="line">    <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line">    <span class="comment">//2.è·å–sessionä¸­çš„ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> session.getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">    <span class="comment">//3.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//4.ä¸å­˜åœ¨ï¼Œæ‹¦æˆª 401 çŠ¶æ€ç  æœªæˆæƒ</span></span><br><span class="line">        response.setStatus(<span class="number">401</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5.å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°ThreadLocal</span></span><br><span class="line">    UserHolder.saveUser((UserDTO) user);</span><br><span class="line">    <span class="comment">//6.æ”¾è¡Œ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmdp.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.hmdp.dto.UserDTO;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.entity.User;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  ThreadLocalç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserHolder</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;UserDTO&gt; tl = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">saveUser</span><span class="params">(UserDTO user)</span>&#123;</span><br><span class="line">        tl.set(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UserDTO <span class="title function_">getUser</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tl.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeUser</span><span class="params">()</span>&#123;</span><br><span class="line">        tl.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">\</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>ThreadLocal</strong></p>
<p><code>ThreadLocal</code> æ˜¯ Java ä¸­çš„ä¸€ä¸ªç±»ï¼Œå®ƒæä¾›äº†çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚è¿™äº›å˜é‡ä¸å®ƒä»¬çš„æ™®é€šå‰¯æœ¬ä¸åŒï¼Œå› ä¸ºæ¯ä¸ªè®¿é—®å®ƒä»¬ï¼ˆé€šè¿‡ get æˆ– set æ–¹æ³•ï¼‰çš„çº¿ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹åˆå§‹åŒ–çš„å˜é‡å‰¯æœ¬ 1ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³è±¡ <code>ThreadLocal</code> å°†æ•°æ®å­˜å‚¨åœ¨ä¸€ä¸ªä»¥çº¿ç¨‹ä¸ºé”®çš„æ˜ å°„ä¸­ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬åœ¨ <code>threadLocalValue</code> ä¸Šè°ƒç”¨ get æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬å°†è·å¾—è¯·æ±‚çº¿ç¨‹çš„ Integer å€¼<br>ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æƒ³è¦æ‹¥æœ‰ä¸€ä¸ªä¸ç‰¹å®šçº¿ç¨‹æ†ç»‘çš„ Integer å€¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ThreadLocal&lt;Integer&gt; threadLocalValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œå½“æˆ‘ä»¬æƒ³è¦ä»çº¿ç¨‹ä¸­ä½¿ç”¨è¿™ä¸ªå€¼æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨ get æˆ– set æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">threadLocalValue.set(<span class="number">1</span>);</span><br><span class="line"><span class="type">Integer</span> <span class="variable">result</span> <span class="operator">=</span> threadLocalValue.get();</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<h1 id="è®°å¾—ç»™é…ç½®ç±»åŠ ä¸Šæ³¨è§£"><a href="#è®°å¾—ç»™é…ç½®ç±»åŠ ä¸Šæ³¨è§£" class="headerlink" title="è®°å¾—ç»™é…ç½®ç±»åŠ ä¸Šæ³¨è§£"></a><strong>è®°å¾—ç»™é…ç½®ç±»åŠ ä¸Šæ³¨è§£</strong></h1></blockquote>
<hr>
<h4 id="é›†ç¾¤çš„sessionå…±äº«é—®é¢˜"><a href="#é›†ç¾¤çš„sessionå…±äº«é—®é¢˜" class="headerlink" title="é›†ç¾¤çš„sessionå…±äº«é—®é¢˜"></a>é›†ç¾¤çš„sessionå…±äº«é—®é¢˜</h4><p><code>sessionå…±äº«é—®é¢˜</code>ï¼šå¤šå°Tomcatå¹¶ä¸å…±äº«sessionå­˜å‚¨ç©ºé—´ï¼Œå½“è¯·æ±‚åˆ‡æ¢åˆ°ä¸åŒtomcatæœåŠ¡æ—¶å¯¼è‡´æ•°æ®ä¸¢å¤±çš„é—®é¢˜ã€‚</p>
<hr>
<h3 id="ğŸ‘ŒåŸºäºRediså®ç°å…±äº«sessionç™»å½•"><a href="#ğŸ‘ŒåŸºäºRediså®ç°å…±äº«sessionç™»å½•" class="headerlink" title="ğŸ‘ŒåŸºäºRediså®ç°å…±äº«sessionç™»å½•"></a>ğŸ‘ŒåŸºäºRediså®ç°å…±äº«sessionç™»å½•</h3><h4 id="å‘é€éªŒè¯ç "><a href="#å‘é€éªŒè¯ç " class="headerlink" title="å‘é€éªŒè¯ç "></a>å‘é€éªŒè¯ç </h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%% å‘é€çŸ­ä¿¡éªŒè¯ç </span><br><span class="line">graph LR</span><br><span class="line">A((å¼€å§‹)) --&gt; B[æäº¤æ‰‹æœºå·];</span><br><span class="line">B --&gt; C&#123;æ ¡éªŒæ‰‹æœºå·&#125; --&gt; |ä¸ç¬¦åˆ|B</span><br><span class="line">C --&gt; |ç¬¦åˆ|D[ç”ŸæˆéªŒè¯ç ] --&gt; E[ä¿å­˜éªŒè¯ç åˆ°Redis] --&gt; F[å‘é€éªŒè¯ç ] --&gt; G((ç»“æŸ))</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendCode</span><span class="params">(String phone, HttpSession session)</span> &#123;</span><br><span class="line">    <span class="comment">//1,æ ¡éªŒæ‰‹æœºå·</span></span><br><span class="line">    <span class="keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;</span><br><span class="line">        <span class="comment">//2,å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ‰‹æœºå·æ ¼å¼é”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3,ç¬¦åˆï¼Œç”ŸæˆéªŒè¯ç </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> RandomUtil.randomNumbers(<span class="number">6</span>);</span><br><span class="line">    <span class="comment">//4,ä¿å­˜éªŒè¯ç åˆ°Redis //set key value ex 120  ç§’ä¸ºå•ä½</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(LOGIN_CODE_KEY + phone,code,LOGIN_CODE_TTL, TimeUnit.MINUTES);</span><br><span class="line">    session.setAttribute(<span class="string">&quot;code&quot;</span>,code);</span><br><span class="line">    <span class="comment">//5.å‘é€éªŒè¯ç </span></span><br><span class="line">    log.debug(<span class="string">&quot;å‘é€çŸ­ä¿¡éªŒè¯ç æˆåŠŸï¼ŒéªŒè¯ç ï¼š&#123;&#125;&quot;</span>,code);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<h4 id="çŸ­ä¿¡éªŒè¯ç ç™»å½•å’Œæ³¨å†ŒåŠŸèƒ½-1"><a href="#çŸ­ä¿¡éªŒè¯ç ç™»å½•å’Œæ³¨å†ŒåŠŸèƒ½-1" class="headerlink" title="çŸ­ä¿¡éªŒè¯ç ç™»å½•å’Œæ³¨å†ŒåŠŸèƒ½"></a>çŸ­ä¿¡éªŒè¯ç ç™»å½•å’Œæ³¨å†ŒåŠŸèƒ½</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%% å‘é€çŸ­ä¿¡éªŒè¯ç </span><br><span class="line">graph LR</span><br><span class="line">A((å¼€å§‹)) --&gt; B[æäº¤æ‰‹æœºå·å’ŒéªŒè¯ç ];</span><br><span class="line">B --&gt; C&#123;æ ¡éªŒéªŒè¯ç &#125; --&gt; |ä¸ä¸€è‡´|B</span><br><span class="line">C --&gt; |ä¸€è‡´|D[æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·] --&gt; E[ç”¨æˆ·æ˜¯å¦å­˜åœ¨] --&gt; |ä¸å­˜åœ¨|F[åˆ›å»ºæ–°ç”¨æˆ·] --&gt; G[ä¿å­˜ç”¨æˆ·åˆ°æ•°æ®åº“] --&gt; H</span><br><span class="line">E --&gt; |å­˜åœ¨|H[ä¿å­˜ç”¨æˆ·åˆ°Redis] --&gt; I[è¿”å›tokenåˆ°å®¢æˆ·ç«¯] --&gt; J((ç»“æŸ))</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;</span><br><span class="line">    <span class="comment">//1.æ ¡éªŒæ‰‹æœºå·</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">phone</span> <span class="operator">=</span> loginForm.getPhone();</span><br><span class="line">    <span class="keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;</span><br><span class="line">        <span class="comment">//2,å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ‰‹æœºå·æ ¼å¼é”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.ä»Redisè·å–æ ¡éªŒéªŒè¯ç </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">cacheCode</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(LOGIN_CODE_KEY + phone);</span><br><span class="line">    <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> loginForm.getCode();</span><br><span class="line">    <span class="keyword">if</span> (cacheCode == <span class="literal">null</span> || !cacheCode.equals(code)) &#123;</span><br><span class="line">        <span class="comment">//3.ä¸ä¸€è‡´ï¼ŒæŠ¥é”™</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;éªŒè¯ç é”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4.ä¸€è‡´ï¼Œæ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="built_in">this</span>.query().eq(<span class="string">&quot;phone&quot;</span>, phone).one();</span><br><span class="line">    <span class="comment">//5.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//6.ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·å¹¶ä¿å­˜</span></span><br><span class="line">        user = saveUserWithPhone(phone);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 7.ä¿å­˜ç”¨æˆ·ä¿¡æ¯Redisä¸­</span></span><br><span class="line">    <span class="comment">// 7.1 éšæœºç”ŸæˆTokenä½œä¸ºç™»å½•ä»¤ç‰Œ</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// 7.2 å°†Userå¯¹è±¡è½¬ä¸ºHashå­˜å‚¨</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> BeanUtil.copyProperties(user, UserDTO.class);</span><br><span class="line">    Map&lt;String, Object&gt; userMap = BeanUtil.beanToMap(userDTO);</span><br><span class="line">    <span class="comment">// 7.3 å­˜å‚¨</span></span><br><span class="line">    stringRedisTemplate.opsForHash().putAll(LOGIN_USER_KEY + token, userMap);</span><br><span class="line">    <span class="comment">// 7.4 è®¾ç½®è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    stringRedisTemplate.expire(LOGIN_USER_KEY + token, CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="comment">// 8 è¿”å›Token</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="ç™»å½•éªŒè¯"><a href="#ç™»å½•éªŒè¯" class="headerlink" title="ç™»å½•éªŒè¯"></a>ç™»å½•éªŒè¯</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">A((å¼€å§‹)) --&gt; B[è¯·æ±‚å¹¶æºå¸¦Token] --&gt; C[ä»Redisè·å–ç”¨æˆ·] --&gt; D&#123;åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨&#125; --&gt; |å­˜åœ¨|E[ä¿å­˜ç”¨æˆ·åˆ°ThreadLocal]</span><br><span class="line">D --&gt; |ä¸å­˜åœ¨|F[æ‹¦æˆª] --&gt; G((ç»“æŸ))</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‰ç½®æ‹¦æˆªå™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//1.è·å–è¯·æ±‚å¤´ä¸­çš„Token</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(token)) &#123;</span><br><span class="line">        response.setStatus(<span class="number">401</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.è·å–Redisä¸­çš„ç”¨æˆ·</span></span><br><span class="line">    Map&lt;Object, Object&gt; userMap = stringRedisTemplate.opsForHash().entries(RedisConstants.LOGIN_USER_KEY + token);</span><br><span class="line">    <span class="comment">//3.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (userMap.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">//4.ä¸å­˜åœ¨ï¼Œæ‹¦æˆª 401 çŠ¶æ€ç  æœªæˆæƒ</span></span><br><span class="line">        response.setStatus(<span class="number">401</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.å°†æŸ¥è¯¢çš„Hashæ•°æ®è½¬ä¸ºUserDTOå¯¹è±¡</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(userMap, <span class="keyword">new</span> <span class="title class_">UserDTO</span>(), <span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// 6.å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°ThreadLocal</span></span><br><span class="line">    UserHolder.saveUser(userDTO);</span><br><span class="line">    <span class="comment">// 7.åˆ·æ–°Tokenæœ‰æ•ˆæœŸ</span></span><br><span class="line">    stringRedisTemplate.expire(LOGIN_USER_KEY + token, CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="comment">// 8.æ”¾è¡Œ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<h2 id="Resultç±»ä¸­ä¸è¦åœ¨æ·»åŠ è¿”å›Msgæ„é€ æ–¹æ³•"><a href="#Resultç±»ä¸­ä¸è¦åœ¨æ·»åŠ è¿”å›Msgæ„é€ æ–¹æ³•" class="headerlink" title="Resultç±»ä¸­ä¸è¦åœ¨æ·»åŠ è¿”å›Msgæ„é€ æ–¹æ³•"></a>Resultç±»ä¸­ä¸è¦åœ¨æ·»åŠ è¿”å›Msgæ„é€ æ–¹æ³•</h2></blockquote>
<hr>
<h4 id="ç™»å½•æ‹¦æˆªå™¨çš„ä¼˜åŒ–"><a href="#ç™»å½•æ‹¦æˆªå™¨çš„ä¼˜åŒ–" class="headerlink" title="ç™»å½•æ‹¦æˆªå™¨çš„ä¼˜åŒ–"></a>ç™»å½•æ‹¦æˆªå™¨çš„ä¼˜åŒ–</h4><p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230415154649051.png" alt="image-20230415154649051"></p>
<hr>
<h2 id="2-å•†æˆ·æŸ¥è¯¢ç¼“å­˜"><a href="#2-å•†æˆ·æŸ¥è¯¢ç¼“å­˜" class="headerlink" title="2.å•†æˆ·æŸ¥è¯¢ç¼“å­˜"></a>2.å•†æˆ·æŸ¥è¯¢ç¼“å­˜</h2><h3 id="ğŸ’¥ä»€ä¹ˆæ˜¯ç¼“å­˜"><a href="#ğŸ’¥ä»€ä¹ˆæ˜¯ç¼“å­˜" class="headerlink" title="ğŸ’¥ä»€ä¹ˆæ˜¯ç¼“å­˜"></a>ğŸ’¥ä»€ä¹ˆæ˜¯ç¼“å­˜</h3><p><code>ç¼“å­˜:</code>å°±æ˜¯æ•°æ®äº¤æ¢çš„ç¼“å†²åŒºï¼ˆç§°ä½œCache),æ˜¯å­˜è´®æ•°æ®çš„ä¸´æ—¶åœ°æ–¹ï¼Œä¸€èˆ¬è¯»å†™æ€§èƒ½è¾ƒé«˜ã€‚</p>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230415162809894.png" alt="image-20230415162809894"></p>
<hr>
<h3 id="ğŸ‘Œæ·»åŠ Redisç¼“å­˜"><a href="#ğŸ‘Œæ·»åŠ Redisç¼“å­˜" class="headerlink" title="ğŸ‘Œæ·»åŠ Redisç¼“å­˜"></a>ğŸ‘Œæ·»åŠ Redisç¼“å­˜</h3><p><strong>æµç¨‹å›¾</strong></p>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230415163741591.png" alt="image-20230415163741591"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.ä»RedisæŸ¥è¯¢å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson))&#123;</span><br><span class="line">        <span class="comment">// 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.ä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(id);</span><br><span class="line">    <span class="comment">// 5.è¿”å›é”™è¯¯</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6.å­˜åœ¨ï¼Œå†™å…¥Redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(shop));</span><br><span class="line">    <span class="comment">// 7.è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="ç»ƒä¹ -ç»™åº—é“ºç±»å‹æŸ¥è¯¢ä¸šåŠ¡æ·»åŠ ç¼“å­˜"><a href="#ç»ƒä¹ -ç»™åº—é“ºç±»å‹æŸ¥è¯¢ä¸šåŠ¡æ·»åŠ ç¼“å­˜" class="headerlink" title="ç»ƒä¹ :ç»™åº—é“ºç±»å‹æŸ¥è¯¢ä¸šåŠ¡æ·»åŠ ç¼“å­˜"></a>ç»ƒä¹ :ç»™åº—é“ºç±»å‹æŸ¥è¯¢ä¸šåŠ¡æ·»åŠ ç¼“å­˜</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryTypeList</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.ä»Redisä¸­æŸ¥è¯¢æ•°æ®</span></span><br><span class="line">    List&lt;String&gt; jsonShopTypes = stringRedisTemplate.opsForList().range(CACHE_TYPES_KEY, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 2.æœ‰æ•°æ®ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (!CollectionUtil.isEmpty(jsonShopTypes)) &#123;</span><br><span class="line">        <span class="comment">//ç¼“å­˜å‘½ä¸­ JSONåŒ–Listè¿”å›</span></span><br><span class="line">        List&lt;ShopType&gt; shopList = jsonShopTypes.stream()</span><br><span class="line">                .map(item -&gt; JSONUtil.toBean(item, ShopType.class))</span><br><span class="line">                .sorted(Comparator.comparing(ShopType::getSort))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shopList);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.shopList</span></span><br><span class="line">    List&lt;ShopType&gt; shopList = <span class="built_in">this</span>.query().orderByAsc(<span class="string">&quot;sort&quot;</span>).list();</span><br><span class="line">    <span class="comment">// 4.æ•°æ®åº“æ— æ•°æ®è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (CollectionUtil.isEmpty(shopList)) &#123;</span><br><span class="line">        <span class="comment">//Collections.emptyList().toString() è¿”å›ä¸€ä¸ªå¯åºåˆ—åŒ–çš„ç©ºé›†åˆ</span></span><br><span class="line"><span class="comment">//            stringRedisTemplate.opsForValue()</span></span><br><span class="line"><span class="comment">//                    .set(CACHE_TYPES_KEY, Collections.emptyList().toString(), CACHE_NULL_TTL, TimeUnit.MINUTES);</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ— åº—é“ºç±»å‹&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.æœ‰æ•°æ®å†™å…¥Redisä¸­å†è¿”å›</span></span><br><span class="line">    List&lt;String&gt; shopTypeCache = shopList.stream()</span><br><span class="line">            .sorted(Comparator.comparing(ShopType::getSort))</span><br><span class="line">            .map(JSONUtil::toJsonStr)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    stringRedisTemplate.opsForList().rightPushAll(CACHE_TYPES_KEY,shopTypeCache);</span><br><span class="line">    stringRedisTemplate.expire(CACHE_TYPES_KEY,CACHE_NULL_TTL,TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shopList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="ğŸ’¥ç¼“å­˜æ›´æ–°ç­–ç•¥"><a href="#ğŸ’¥ç¼“å­˜æ›´æ–°ç­–ç•¥" class="headerlink" title="ğŸ’¥ç¼“å­˜æ›´æ–°ç­–ç•¥"></a>ğŸ’¥ç¼“å­˜æ›´æ–°ç­–ç•¥</h3><table>
<thead>
<tr>
<th>ç§ç±»</th>
<th align="center">å†…å­˜æ·˜æ±°</th>
<th align="center">è¶…æ—¶å‰”é™¤</th>
<th align="center">ä¸»åŠ¨æ›´æ–°</th>
</tr>
</thead>
<tbody><tr>
<td>è¯´æ˜</td>
<td align="center">ä¸ç”¨è‡ªå·±ç»´æŠ¤ï¼Œåˆ©ç”¨<code>Redis</code>çš„å†…å­˜æ·˜æ±°æœºåˆ¶ï¼Œ<br>å½“å†…å­˜ä¸è¶³æ—¶è‡ªåŠ¨æ·˜æ±°éƒ¨åˆ†æ•°æ®ã€‚ä¸‹æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ç¼“å­˜ã€‚</td>
<td align="center">ç»™ç¼“å­˜æ•°æ®æ·»åŠ TTLæ—¶é—´ï¼Œåˆ°æœŸåè‡ª<br/>åŠ¨åˆ é™¤ç¼“å­˜ã€‚ä¸‹æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ç¼“å­˜ã€‚</td>
<td align="center">ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œåœ¨ä¿®æ”¹æ•°æ®åº“çš„<br/>åŒæ—¶ï¼Œæ›´æ–°ç¼“å­˜ã€‚</td>
</tr>
<tr>
<td>ä¸€è‡´æ€§</td>
<td align="center">å·®</td>
<td align="center">ä¸€èˆ¬</td>
<td align="center">å¥½</td>
</tr>
<tr>
<td>ç»´æŠ¤æˆæœ¬</td>
<td align="center">æ— </td>
<td align="center">ä½</td>
<td align="center">é«˜</td>
</tr>
</tbody></table>
<blockquote>
<p>ä¸šåŠ¡åœºæ™¯ï¼š</p>
<ul>
<li>ä½ä¸€è‡´æ€§éœ€æ±‚ï¼šä½¿ç”¨å†…å­˜æ·˜æ±°æœºåˆ¶ã€‚ä¾‹å¦‚åº—é“ºç±»å‹çš„æŸ¥è¯¢ç¼“å­˜</li>
<li>é«˜ä¸€è‡´æ€§éœ€æ±‚ï¼šä¸»åŠ¨æ›´æ–°ï¼Œå¹¶ä»¥è¶…æ—¶å‰”é™¤ä½œä¸ºå…œåº•æ–¹æ¡ˆã€‚ä¾‹å¦‚åº—é“ºè¯¦æƒ…æŸ¥è¯¢çš„ç¼“å­˜</li>
</ul>
</blockquote>
<hr>
<p><strong>ä¸»åŠ¨æ›´æ–°ç­–ç•¥</strong></p>
<p>ğŸ’¥<strong>ä¸‰ç§è§£å†³æ–¹æ¡ˆ</strong></p>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230415230911993.png" alt="image-20230415230911993"></p>
<p>ğŸ’¥æ“ä½œç¼“å­˜å’Œæ•°æ®åº“æ—¶æœ‰ä¸‰ä¸ªé—®é¢˜éœ€è¦è€ƒè™‘ï¼š</p>
<ol>
<li>åˆ é™¤ç¼“å­˜è¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ</li>
</ol>
<ul>
<li>æ›´æ–°ç¼“å­˜ï¼šæ¯æ¬¡æ›´æ–°æ•°æ®åº“éƒ½æ›´æ–°ç¼“å­˜ï¼Œæ— æ•ˆå†™æ“ä½œè¾ƒå¤šã€‚âŒ</li>
<li>åˆ é™¤ç¼“å­˜ï¼šæ›´æ–°æ•°æ®åº“æ—¶è®©ç¼“å­˜å¤±æ•ˆï¼ŒæŸ¥è¯¢æ—¶å†æ›´æ–°ç¼“å­˜ã€‚âœ”</li>
</ul>
<ol start="2">
<li>å¦‚ä½•ä¿è¯ç¼“å­˜ä¸æ•°æ®åº“çš„æ“ä½œçš„åŒæ—¶æˆåŠŸæˆ–å¤±è´¥ï¼Ÿ</li>
</ol>
<ul>
<li>å•ä½“ç³»ç»Ÿï¼Œå°†ç¼“å­˜ä¸æ•°æ®åº“æ“ä½œæ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡</li>
<li>åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåˆ©ç”¨TCCç­‰åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ</li>
</ul>
<hr>
<ol start="3">
<li>å…ˆæ“ä½œç¼“å­˜è¿˜æ˜¯å…ˆæ“ä½œæ•°æ®åº“ï¼Ÿ</li>
</ol>
<ul>
<li>å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ“ä½œæ•°æ®åº“</li>
<li>å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</li>
</ul>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230415232106714.png" alt="image-20230415232106714"></p>
<blockquote>
<p>ä¸¤ç§æ–¹æ¡ˆå‡ºç°ä¸ä¸€è‡´æ€§çš„å®‰å…¨é—®é¢˜</p>
<p><code>æ–¹æ¡ˆäºŒ</code>å‘ç”Ÿæ¦‚ç‡ä½äº<code>æ–¹æ¡ˆä¸€</code></p>
</blockquote>
<hr>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><blockquote>
<p>ç¼“å­˜æ›´æ–°ç­–ç•¥çš„æœ€ä½³å®è·µæ–¹æ¡ˆï¼š<br>1.ä½ä¸€è‡´æ€§éœ€æ±‚ï¼šä½¿ç”¨<code>Redis</code>è‡ªå¸¦çš„å†…å­˜æ·˜æ±°æœºåˆ¶<br>2.é«˜ä¸€è‡´æ€§éœ€æ±‚ï¼šä¸»åŠ¨æ›´æ–°ï¼Œå¹¶ä»¥è¶…æ—¶å‰”é™¤ä½œä¸ºå…œåº•æ–¹æ¡ˆ</p>
<h4 id="â—†è¯»æ“ä½œï¼š"><a href="#â—†è¯»æ“ä½œï¼š" class="headerlink" title="â—†è¯»æ“ä½œï¼š"></a>â—†è¯»æ“ä½œï¼š</h4><h5 id="ç¼“å­˜å‘½ä¸­åˆ™ç›´æ¥è¿”å›"><a href="#ç¼“å­˜å‘½ä¸­åˆ™ç›´æ¥è¿”å›" class="headerlink" title="ç¼“å­˜å‘½ä¸­åˆ™ç›´æ¥è¿”å›"></a>ç¼“å­˜å‘½ä¸­åˆ™ç›´æ¥è¿”å›</h5><h5 id="ç¼“å­˜æœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶å†™å…¥ç¼“å­˜ï¼Œè®¾å®šè¶…æ—¶æ—¶é—´"><a href="#ç¼“å­˜æœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶å†™å…¥ç¼“å­˜ï¼Œè®¾å®šè¶…æ—¶æ—¶é—´" class="headerlink" title="ç¼“å­˜æœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶å†™å…¥ç¼“å­˜ï¼Œè®¾å®šè¶…æ—¶æ—¶é—´"></a>ç¼“å­˜æœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶å†™å…¥ç¼“å­˜ï¼Œè®¾å®šè¶…æ—¶æ—¶é—´</h5><h4 id="â—†å†™æ“ä½œï¼š"><a href="#â—†å†™æ“ä½œï¼š" class="headerlink" title="â—†å†™æ“ä½œï¼š"></a>â—†å†™æ“ä½œï¼š</h4><h5 id="å…ˆå†™æ•°æ®åº“ï¼Œç„¶åå†åˆ é™¤ç¼“å­˜"><a href="#å…ˆå†™æ•°æ®åº“ï¼Œç„¶åå†åˆ é™¤ç¼“å­˜" class="headerlink" title="å…ˆå†™æ•°æ®åº“ï¼Œç„¶åå†åˆ é™¤ç¼“å­˜"></a>å…ˆå†™æ•°æ®åº“ï¼Œç„¶åå†åˆ é™¤ç¼“å­˜</h5><h5 id="è¦ç¡®ä¿æ•°æ®åº“ä¸ç¼“å­˜æ“ä½œçš„åŸå­æ€§"><a href="#è¦ç¡®ä¿æ•°æ®åº“ä¸ç¼“å­˜æ“ä½œçš„åŸå­æ€§" class="headerlink" title="è¦ç¡®ä¿æ•°æ®åº“ä¸ç¼“å­˜æ“ä½œçš„åŸå­æ€§"></a>è¦ç¡®ä¿æ•°æ®åº“ä¸ç¼“å­˜æ“ä½œçš„åŸå­æ€§</h5></blockquote>
<hr>
<h4 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h4><p><strong>ç»™æŸ¥è¯¢å•†é“ºçš„ç¼“å­˜æ·»åŠ è¶…æ—¶å‰”é™¤å’Œä¸»åŠ¨æ›´æ–°çš„ç­–ç•¥</strong><br>ä¿®æ”¹<code>ShopController</code>ä¸­çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ»¡è¶³ä¸‹é¢çš„éœ€æ±‚ï¼š<br>    â‘ æ ¹æ®<code>id</code>æŸ¥è¯¢åº—é“ºæ—¶ï¼Œå¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå°†æ•°æ®åº“ç»“æœå†™å…¥ç¼“å­˜ï¼Œå¹¶è®¾ç½®è¶…æ—¶æ—¶é—´</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 6.å­˜åœ¨ï¼Œå†™å…¥Redisæ·»åŠ è¿‡æœŸæ—¶é—´</span></span><br><span class="line">stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(shop),CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br></pre></td></tr></table></figure>

<p>â€‹	â‘¡æ ¹æ®<code>id</code>ä¿®æ”¹åº—é“ºæ—¶ï¼Œå…ˆä¿®æ”¹æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">(Shop shop)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> shop.getId();</span><br><span class="line">    <span class="keyword">if</span> (id == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºidä¸èƒ½ä¸ºç©º&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 1.æ›´æ–°æ•°æ®åº“</span></span><br><span class="line">    <span class="built_in">this</span>.updateById(shop);</span><br><span class="line">    <span class="comment">// 2.åˆ é™¤ç¼“å­˜</span></span><br><span class="line">    stringRedisTemplate.delete(CACHE_SHOP_KEY + id);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="ğŸ‘Œç¼“å­˜ç©¿é€"><a href="#ğŸ‘Œç¼“å­˜ç©¿é€" class="headerlink" title="ğŸ‘Œç¼“å­˜ç©¿é€"></a>ğŸ‘Œç¼“å­˜ç©¿é€</h3><p><code>ç¼“å­˜ç©¿é€</code>æ˜¯æŒ‡å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œè¿™æ ·ç¼“å­˜æ°¸è¿œä¸ä¼šç”Ÿæ•ˆï¼Œè¿™äº›è¯·æ±‚éƒ½ä¼šæ‰“åˆ°æ•°æ®åº“ã€‚</p>
<blockquote>
<p>å¦‚æœåˆ«æœ‰ç”¨å¿ƒçš„è®¿é—®ä¸€ä¸ªç¼“å­˜ä¸­ä¸å­˜åœ¨çš„æ•°æ®ï¼Œåˆ™ä¼šç›´æ¥è¯·æ±‚æ•°æ®åº“ï¼Œå¤§é‡è¯·æ±‚ä¸‹å¯èƒ½ä¼šå¯¼è‡´æ•°æ®åº“å´©æºƒ</p>
</blockquote>
<p><strong>è§£å†³æ–¹æ³•ï¼š</strong></p>
<ul>
<li>ç¼“å­˜ç©ºå¯¹è±¡</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">å½“ç¬¬ä¸€æ¬¡è®¿é—®ç¼“å­˜ä¸å­˜åœ¨çš„æ•°æ®åï¼Œç¼“å­˜ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œè¿™æ ·ä¸‹ä¸€æ¬¡è®¿é—®æ—¶åˆ™è¿”å›ç¼“å­˜ä¸­çš„ç©ºå¯¹è±¡</span><br><span class="line">    </span><br><span class="line">ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œç»´æŠ¤æ–¹ä¾¿</span><br><span class="line">ç¼ºç‚¹ï¼š</span><br><span class="line">	<span class="number">1.</span>é¢å¤–çš„å†…å­˜æ¶ˆè€—</span><br><span class="line">	<span class="number">2.</span>å¯èƒ½é€ æˆçŸ­æœŸçš„ä¸ä¸€è‡´</span><br></pre></td></tr></table></figure>

<img src="https://cdn.jsdelivr.net/gh/flyono/Chart-bed@main/img/image-20230415235521184.png" alt="image-20230415235521184" style="zoom: 50%;" />

<ul>
<li>å¸ƒéš†è¿‡æ»¤å™¨</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">å½“ä¸€ä¸ªå…ƒç´ è¢«åŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨ä¸­çš„æ—¶å€™ï¼Œä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼šä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­çš„å“ˆå¸Œå‡½æ•°å¯¹å…ƒç´ å€¼è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°å“ˆå¸Œå€¼ï¼ˆæœ‰å‡ ä¸ªå“ˆå¸Œå‡½æ•°å¾—åˆ°å‡ ä¸ªå“ˆå¸Œå€¼ï¼‰ã€‚æ ¹æ®å¾—åˆ°çš„å“ˆå¸Œå€¼ï¼Œåœ¨ä½æ•°ç»„ä¸­æŠŠå¯¹åº”ä¸‹æ ‡çš„å€¼ç½®ä¸º<span class="number">1</span>ã€‚</span><br><span class="line"></span><br><span class="line">å½“æˆ‘ä»¬éœ€è¦åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨çš„æ—¶å€™ï¼Œä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼šå¯¹ç»™å®šå…ƒç´ å†æ¬¡è¿›è¡Œç›¸åŒçš„å“ˆå¸Œè®¡ç®—ï¼›å¾—åˆ°å€¼ä¹‹ååˆ¤æ–­ä½æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ æ˜¯å¦éƒ½ä¸º <span class="number">1</span>ï¼Œå¦‚æœå€¼éƒ½ä¸º <span class="number">1</span>ï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªå€¼åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ªå€¼ä¸ä¸º <span class="number">1</span>ï¼Œè¯´æ˜è¯¥å…ƒç´ ä¸åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚</span><br><span class="line"></span><br><span class="line">ä¼˜ç‚¹ï¼šå†…å­˜å ç”¨è¾ƒå°‘ï¼Œæ²¡æœ‰å¤šä½™Key</span><br><span class="line">ç¼ºç‚¹ï¼š</span><br><span class="line">    <span class="number">1.</span>å®ç°å¤æ‚</span><br><span class="line">    <span class="number">2.</span>å­˜åœ¨è¯¯åˆ¤å¯èƒ½</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>æµç¨‹</strong></p>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230416000225717.png" alt="image-20230416000225717"></p>
<p>ç¼“å­˜ç©ºå¯¹è±¡å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.ä»RedisæŸ¥è¯¢å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson))&#123;</span><br><span class="line">        <span class="comment">// 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (shopJson != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.ä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(id);</span><br><span class="line">    <span class="comment">// 5.è¿”å›é”™è¯¯</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, <span class="string">&quot;&quot;</span>,CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6.å­˜åœ¨ï¼Œå†™å…¥Redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(shop),CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="comment">// 7.è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>ç¼“å­˜ç©¿é€äº§ç”Ÿçš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>ç”¨æˆ·è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œä¸æ–­å‘èµ·è¿™æ ·çš„è¯·æ±‚ï¼Œç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§å‹åŠ›</li>
</ul>
<p>ç¼“å­˜ç©¿é€çš„è§£å†³æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ</p>
<ul>
<li>ç¼“å­˜nullå€¼</li>
<li>å¸ƒéš†è¿‡æ»¤</li>
<li>å¢å¼º<code>id</code>çš„å¤æ‚åº¦ï¼Œé¿å…è¢«çŒœæµ‹<code>id</code>è§„å¾‹</li>
<li>åšå¥½æ•°æ®çš„åŸºç¡€æ ¼å¼æ ¡éªŒ</li>
<li>åŠ å¼ºç”¨æˆ·æƒé™æ ¡éªŒ</li>
<li>åšå¥½çƒ­ç‚¹å‚æ•°çš„é™æµ</li>
</ul>
<hr>
<h3 id="ğŸ‘Œç¼“å­˜é›ªå´©"><a href="#ğŸ‘Œç¼“å­˜é›ªå´©" class="headerlink" title="ğŸ‘Œç¼“å­˜é›ªå´©"></a>ğŸ‘Œç¼“å­˜é›ªå´©</h3><p><code>ç¼“å­˜é›ªå´©</code>æ˜¯æŒ‡åœ¨åŒä¸€æ—¶æ®µå¤§é‡çš„ç¼“å­˜keyåŒæ—¶å¤±æ•ˆæˆ–è€…<code>Redis</code>æœåŠ¡å®•æœºï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚åˆ°è¾¾æ•°æ®åº“ï¼Œå¸¦æ¥å·¨å¤§å‹åŠ›ã€‚</p>
<blockquote>
<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<ul>
<li>ç»™ä¸åŒçš„Keyçš„TTLæ·»åŠ éšæœºå€¼</li>
<li>åˆ©ç”¨<code>Redis</code>é›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§</li>
<li>ç»™ç¼“å­˜ä¸šåŠ¡æ·»åŠ é™çº§é™æµç­–ç•¥</li>
<li>ç»™ä¸šåŠ¡æ·»åŠ å¤šçº§ç¼“å­˜</li>
</ul>
</blockquote>
<hr>
<h3 id="ğŸ‘Œç¼“å­˜å‡»ç©¿"><a href="#ğŸ‘Œç¼“å­˜å‡»ç©¿" class="headerlink" title="ğŸ‘Œç¼“å­˜å‡»ç©¿"></a>ğŸ‘Œç¼“å­˜å‡»ç©¿</h3><p><code>ç¼“å­˜å‡»ç©¿</code>é—®é¢˜ä¹Ÿå«<code>çƒ­ç‚¹Key</code>é—®é¢˜ï¼Œå°±æ˜¯ä¸€ä¸ªè¢«<code>é«˜å¹¶å‘è®¿é—®</code>å¹¶ä¸”<code>ç¼“å­˜é‡å»ºä¸šåŠ¡è¾ƒå¤æ‚</code>çš„keyçªç„¶å¤±æ•ˆäº†ï¼Œæ— æ•°çš„è¯·æ±‚è®¿é—®ä¼š<br>åœ¨ç¬é—´ç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„å†²å‡»ã€‚</p>
<blockquote>
<p><strong>å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</strong></p>
<ul>
<li>äº’æ–¥é”</li>
</ul>
<img src="https://cdn.jsdelivr.net/gh/flyono/Chart-bed@main/img/image-20230416160758527.png" alt="image-20230416160758527" style="zoom:50%;" />

<ul>
<li>é€»è¾‘è¿‡æœŸ</li>
</ul>
<img src="https://cdn.jsdelivr.net/gh/flyono/Chart-bed@main/img/image-20230416161656406.png" alt="image-20230416161656406" style="zoom:50%;" />
</blockquote>
<p><strong>ä¼˜ç¼ºç‚¹åˆ†æï¼š</strong></p>
<table>
<thead>
<tr>
<th align="center">è§£å†³æ–¹æ¡ˆ</th>
<th align="center">ä¼˜ç‚¹</th>
<th align="center">ç¼ºç‚¹</th>
</tr>
</thead>
<tbody><tr>
<td align="center">äº’æ–¥é”</td>
<td align="center">æ²¡æœ‰é¢å¤–çš„å†…å­˜æ¶ˆè€—<br>ä¿è¯ä¸€è‡´æ€§<br>å®ç°ç®€å•</td>
<td align="center">çº¿ç¨‹éœ€è¦ç­‰å¾…ï¼Œæ€§èƒ½å—å½±å“<br>å¯èƒ½æœ‰æ­»é”é£é™©</td>
</tr>
<tr>
<td align="center">é€»è¾‘è¿‡æœŸ</td>
<td align="center">çº¿ç¨‹æ— éœ€ç­‰å¾…ï¼Œæ€§èƒ½è¾ƒå¥½</td>
<td align="center">ä¸ä¿è¯ä¸€è‡´æ€§<br>æœ‰é¢å¤–å†…å­˜æ¶ˆè€—<br>å®ç°å¤æ‚</td>
</tr>
</tbody></table>
<hr>
<h4 id="æ¡ˆä¾‹-1"><a href="#æ¡ˆä¾‹-1" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h4><p><strong>åŸºäºäº’æ–¥é”æ–¹å¼è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</strong><br>éœ€æ±‚ï¼šä¿®æ”¹æ ¹æ®idæŸ¥è¯¢å•†é“ºçš„ä¸šåŠ¡ï¼ŒåŸºäº<code>äº’æ–¥é”æ–¹å¼</code>æ¥è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</p>
<p><strong>æµç¨‹å›¾</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">A((å¼€å§‹)) --&gt; B[æäº¤åº—é“ºid] --&gt; C[ä»Redisä¸­æŸ¥è¯¢å•†é“ºç¼“å­˜] --&gt; D&#123;&#123;åˆ¤æ–­ç¼“å­˜æ˜¯å¦å‘½ä¸­&#125;&#125; --&gt; |å‘½ä¸­|E[è¿”å›æ•°æ®] --&gt;Z((ç»“æŸ))</span><br><span class="line">D --&gt; |æœªå‘½ä¸­|F[å°è¯•è·å–äº’æ–¥é”] --&gt; G&#123;&#123;åˆ¤æ–­æ˜¯å¦è·å–é”&#125;&#125; --&gt; |æ˜¯|H[æ ¹æ®idæŸ¥è¯¢æ•°æ®åº“] --&gt; I[å°†åº—é“ºæ•°æ®å†™å…¥Redis]--&gt;J[é‡Šæ”¾äº’æ–¥é”] --&gt; E</span><br><span class="line">G --&gt; |å¦|K[ä¼‘çœ ä¸€æ®µæ—¶é—´] --&gt; C</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* çº¿ç¨‹æ± </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* åŸºäºäº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> id åº—é“ºid</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> Shop <span class="title function_">queryWithMutex</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.ä»RedisæŸ¥è¯¢å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨(å‘½ä¸­)</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="comment">// 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (shopJson != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.å®ç°ç¼“å­˜é‡å»º</span></span><br><span class="line">    <span class="comment">// 4.1 è·å–äº’æ–¥é”</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">        <span class="comment">// 4.2 åˆ¤æ–­æ˜¯å¦è·å–æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">            <span class="comment">// 4.3 å¤±è´¥ï¼Œä¼‘çœ å¹¶é‡è¯•</span></span><br><span class="line">            Thread.sleep(<span class="number">50</span>);</span><br><span class="line">            <span class="keyword">return</span> queryWithMutex(id);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.4 æˆåŠŸï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">        shop = <span class="built_in">this</span>.getById(id);</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿé‡å»ºå»¶è¿Ÿ</span></span><br><span class="line">        Thread.sleep(<span class="number">200</span>);</span><br><span class="line">        <span class="comment">// 5.è¿”å›é”™è¯¯</span></span><br><span class="line">        <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">            stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 6.å­˜åœ¨ï¼Œå†™å…¥Redis</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(shop), CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 7.é‡Šæ”¾äº’æ–¥é”</span></span><br><span class="line">        unlock(lockKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 8.è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–é”</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key é”®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é‡Šæ”¾é”</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key é”®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    stringRedisTemplate.delete(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>åŸºäºé€»è¾‘è¿‡æœŸæ–¹å¼è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</strong><br>éœ€æ±‚ï¼šä¿®æ”¹æ ¹æ®idæŸ¥è¯¢å•†é“ºçš„ä¸šåŠ¡ï¼ŒåŸºäº<code>é€»è¾‘è¿‡æœŸæ–¹å¼</code>æ¥è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</p>
<p><strong>æµç¨‹å›¾</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line"></span><br><span class="line">A((å¼€å§‹)) --&gt; B[æäº¤åº—é“ºid] --&gt; C[ä»Redisä¸­æŸ¥è¯¢åº—é“ºid] --&gt; D&#123;&#123;åˆ¤æ–­ç¼“å­˜æ˜¯å¦å‘½ä¸­&#125;&#125; --&gt;  |æœªå‘½ä¸­|F[è¿”å›ç©º] --&gt; G((ç»“æŸ))</span><br><span class="line">D --&gt; |å‘½ä¸­|E&#123;&#123;åˆ¤æ–­ç¼“å­˜æ˜¯å¦è¿‡æœŸ&#125;&#125;</span><br><span class="line">E --&gt; |æœªè¿‡æœŸ|H[è¿”å›åº—é“ºä¿¡æ¯] --&gt; G</span><br><span class="line">E --&gt; |è¿‡æœŸ|I[å°è¯•è·å–äº’æ–¥é”] --&gt; J&#123;&#123;åˆ¤æ–­æ˜¯å¦è·å–é”&#125;&#125; </span><br><span class="line">J --&gt; |å¦|H</span><br><span class="line">J --&gt; |æ˜¯|K[å¼€å¯ç‹¬ç«‹çº¿ç¨‹æ‰§è¡Œç¼“å­˜é‡å»º] -.-&gt; database[æ ¹æ®idæŸ¥è¯¢æ•°æ®åº“] --&gt; write[å°†å•†é“ºæ•°æ®å†™å…¥Redis,å¹¶è®¾ç½®è¾‘è¿‡æœŸæ—¶é—´]</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŸºäºé€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿</span></span><br><span class="line"><span class="comment"> * éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœæ•°æ®ä¸€å¼€å§‹æœªå­˜åœ¨äºRedisä¸­ï¼Œåˆ™ä¼šè¿”å›æ— åº—é“ºæ•°æ®ï¼Œæ‰€æœ‰éœ€è¦æ‰§è¡Œå‰ç¼“å­˜é¢„çƒ­</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Shop <span class="title function_">queryWithLogicalExpire</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.ä»RedisæŸ¥è¯¢å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(shopJson)) &#123;</span><br><span class="line">        <span class="comment">// 3.æœªå‘½ä¸­ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.å‘½ä¸­ï¼Œéœ€è¦å…ˆå°†jsonååºåˆ—åŒ–ä¸ºå¯¹è±¡</span></span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, RedisData.class);</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), Shop.class);</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();</span><br><span class="line">    <span class="comment">// 5.åˆ¤æ–­ç¼“å­˜æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">if</span> (expireTime.isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// 5.1æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›åº—é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.2å·²è¿‡æœŸï¼Œéœ€è¦ç¼“å­˜é‡å»º</span></span><br><span class="line">    <span class="comment">// 6.ç¼“å­˜é‡å»º</span></span><br><span class="line">    <span class="comment">// 6.1 è·å–äº’æ–¥é”</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">    <span class="comment">// 6.2 åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (isLock) &#123;</span><br><span class="line">        <span class="comment">// 6.3 æˆåŠŸ,å¼€å¯ç‹¬ç«‹çº¿ç¨‹ï¼Œå®ç°ç¼“å­˜é‡å»º</span></span><br><span class="line">        CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//ç¼“å­˜é‡å»º</span></span><br><span class="line">                <span class="built_in">this</span>.saveShop2Redis(id, <span class="number">20L</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                unlock(lockKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6.4 å¤±è´¥ï¼Œè¿”å›è¿‡æœŸåº—é“ºä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="ğŸ‘Œç¼“å­˜å·¥å…·å°è£…"><a href="#ğŸ‘Œç¼“å­˜å·¥å…·å°è£…" class="headerlink" title="ğŸ‘Œç¼“å­˜å·¥å…·å°è£…"></a>ğŸ‘Œç¼“å­˜å·¥å…·å°è£…</h3><blockquote>
<p>åŸºäº<code>StringRedisTemplate</code>å°è£…ä¸€ä¸ªç¼“å­˜å·¥å…·ç±»ï¼Œæ»¡è¶³ä¸‹åˆ—éœ€æ±‚ï¼š<br>æ–¹æ³•1ï¼šå°†ä»»æ„)avaå¯¹è±¡åºåˆ—åŒ–ä¸ºJSONå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®TTLè¿‡æœŸæ—¶é—´<br>æ–¹æ³•2ï¼šå°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºJSONå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œç”¨äºå¤„ç†ç¼“å­˜å‡»ç©¿é—®é¢˜<br>æ–¹æ³•3ï¼šæ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œåˆ©ç”¨ç¼“å­˜ç©ºå€¼çš„æ–¹å¼è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜<br>æ–¹æ³•4ï¼šæ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œéœ€è¦åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmdp.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.BooleanUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONObject;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONUtil;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.entity.Shop;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.hmdp.utils.RedisConstants.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Rediså·¥å…·ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheClient</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, Object value, Long time, TimeUnit unit)</span>&#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, unit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setWithLogicExpire</span><span class="params">(String key, Object value, Long time, TimeUnit unit)</span>&#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®é€»è¾‘è¿‡æœŸ</span></span><br><span class="line">        <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisData</span>();</span><br><span class="line">        redisData.setData(value);</span><br><span class="line">        redisData.setExpireTime(LocalDateTime.now().plusSeconds(unit.toSeconds(time)));</span><br><span class="line">        <span class="comment">// å†™å…¥Redis</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç¼“å­˜ç©¿é€</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyPrefix keyå‰ç¼€</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id æŸ¥è¯¢id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type ç±»å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dbFallback æ•°æ®åº“æŸ¥è¯¢å‡½æ•°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit æ—¶é—´å•ä½</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;R&gt; æ³›å‹ 1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;ID&gt; æ³›å‹ 2</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithPassThrough</span><span class="params">(</span></span><br><span class="line"><span class="params">            String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">        <span class="comment">// 1.ä»RedisæŸ¥è¯¢å•†é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">// 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">            <span class="comment">// 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toBean(json, type);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (json != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.ä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">        <span class="comment">// 5.è¿”å›é”™è¯¯</span></span><br><span class="line">        <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">            stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 6.å­˜åœ¨ï¼Œå†™å…¥Redis</span></span><br><span class="line">        <span class="built_in">this</span>.set(key, r, time, unit);</span><br><span class="line">        <span class="comment">// 7.è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * çº¿ç¨‹æ± </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithLogicalExpire</span><span class="params">(</span></span><br><span class="line"><span class="params">            String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">        <span class="comment">// 1.ä»RedisæŸ¥è¯¢å•†é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">// 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(json)) &#123;</span><br><span class="line">            <span class="comment">// 3.æœªå‘½ä¸­ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.å‘½ä¸­ï¼Œéœ€è¦å…ˆå°†jsonååºåˆ—åŒ–ä¸ºå¯¹è±¡</span></span><br><span class="line">        <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(json, RedisData.class);</span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), type);</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();</span><br><span class="line">        <span class="comment">// 5.åˆ¤æ–­ç¼“å­˜æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">        <span class="keyword">if</span> (expireTime.isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="comment">// 5.1æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›åº—é“ºä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 5.2å·²è¿‡æœŸï¼Œéœ€è¦ç¼“å­˜é‡å»º</span></span><br><span class="line">        <span class="comment">// 6.ç¼“å­˜é‡å»º</span></span><br><span class="line">        <span class="comment">// 6.1 è·å–äº’æ–¥é”</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">        <span class="comment">// 6.2 åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (isLock) &#123;</span><br><span class="line">            <span class="comment">// 6.3 æˆåŠŸ,å¼€å¯ç‹¬ç«‹çº¿ç¨‹ï¼Œå®ç°ç¼“å­˜é‡å»º</span></span><br><span class="line">            CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//ç¼“å­˜é‡å»º</span></span><br><span class="line">                    <span class="comment">//æŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">                    <span class="type">R</span> <span class="variable">r1</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">                    <span class="comment">//å†™å…¥Redis</span></span><br><span class="line">                    <span class="built_in">this</span>.setWithLogicExpire(key, r1, time, unit);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    unlock(lockKey);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 6.4 å¤±è´¥ï¼Œè¿”å›è¿‡æœŸåº—é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–é”</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é‡Šæ”¾é”</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key é”®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        stringRedisTemplate.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-ä¼˜æƒ åˆ¸ç§’æ€"><a href="#3-ä¼˜æƒ åˆ¸ç§’æ€" class="headerlink" title="3.ä¼˜æƒ åˆ¸ç§’æ€"></a>3.ä¼˜æƒ åˆ¸ç§’æ€</h2><h3 id="ğŸ‘Œå…¨å±€å”¯ä¸€ID"><a href="#ğŸ‘Œå…¨å±€å”¯ä¸€ID" class="headerlink" title="ğŸ‘Œå…¨å±€å”¯ä¸€ID"></a>ğŸ‘Œå…¨å±€å”¯ä¸€ID</h3><p>æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼š</p>
<p>è¿™å°±å¯¼è‡´äº†å½“ç”¨æˆ·æŠ¢è´­æ—¶ï¼Œå°±ä¼šç”Ÿæˆè®¢å•å¹¶ä¿å­˜åˆ°<code>tb_voucher_order</code>è¿™å¼ è¡¨ä¸­ï¼Œè€Œè®¢å•è¡¨å¦‚æœä½¿ç”¨æ•°æ®åº“è‡ªå¢IDå°±å­˜åœ¨ä¸€äº›é—®é¢˜ï¼š</p>
<ul>
<li>idçš„è§„å¾‹æ€§å¤ªæ˜æ˜¾</li>
<li>å—å•è¡¨æ•°æ®é‡çš„é™åˆ¶</li>
</ul>
<p><code>å…¨å±€IDç”Ÿæˆå™¨</code>ï¼Œæ˜¯ä¸€ç§åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ç”¨æ¥ç”Ÿæˆå…¨å±€å”¯ä¸€Dçš„å·¥å…·ï¼Œä¸€èˆ¬è¦æ»¡è¶³ä¸‹åˆ—ç‰¹æ€§ï¼š</p>
<blockquote>
<ol>
<li>å”¯ä¸€æ€§</li>
<li>é€’å¢æ€§</li>
<li>é«˜å¯ç”¨</li>
<li>é«˜æ€§èƒ½</li>
<li>å®‰å…¨æ€§</li>
</ol>
</blockquote>
<p>å¦‚ä½•è®¾è®¡ï¼Ÿ</p>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230416214703660.png" alt="image-20230416214703660"></p>
<p>IDçš„ç»„æˆéƒ¨åˆ†ï¼š</p>
<ul>
<li>ç¬¦å·ä½ï¼š<code>1 bit</code>, æ°¸è¿œä¸º0</li>
<li>æ—¶é—´æˆ³ï¼š<code>31 bit</code>, ä»¥ç§’ä¸ºå•ä½ï¼Œå¯ä»¥ä½¿ç”¨69å¹´</li>
<li>åºåˆ—å·ï¼š<code>32 bit</code>, ç§’å†…çš„è®¡æ•°å™¨ï¼Œæ”¯æŒæ¯ç§’äº§ç”Ÿ2^32ä¸ªä¸åŒID</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmdp.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.ZoneOffset;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å…¨å±€IDç”Ÿæˆå™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisIdWorker</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¼€å§‹æ—¶é—´æˆ³</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">BEGIN_TIMESTAMP</span> <span class="operator">=</span> <span class="number">1640995200L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åºåˆ—å·çš„ä½æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BITS</span> <span class="operator">=</span> <span class="number">32</span>;</span><br><span class="line">    <span class="keyword">private</span> RedisTemplate RedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisIdWorker</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.RedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyPrefix ä¸šåŠ¡å‰ç¼€</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">(String keyPrefix)</span>&#123;</span><br><span class="line">        <span class="comment">// 1.ç”Ÿæˆæ—¶é—´æˆ³</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="type">long</span> <span class="variable">nowSecond</span> <span class="operator">=</span> now.toEpochSecond(ZoneOffset.UTC);</span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> nowSecond - BEGIN_TIMESTAMP;</span><br><span class="line">        <span class="comment">// 2.ç”Ÿæˆåºåˆ—å·</span></span><br><span class="line">        <span class="comment">// 2.1 è·å–å½“å‰æ—¥æœŸï¼Œç²¾ç¡®åˆ°å¤©</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">date</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy:MM:dd&quot;</span>));</span><br><span class="line">        <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> RedisTemplate.opsForValue().increment(<span class="string">&quot;icr&quot;</span> + keyPrefix + <span class="string">&quot;:&quot;</span> + date);</span><br><span class="line">        <span class="comment">// 3.æ‹¼æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> timestamp &lt;&lt; COUNT_BITS | count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    //è·å–æ—¥æœŸå¯¹åº”çš„ç§’æ•°</span></span><br><span class="line"><span class="comment">    LocalDateTime time = LocalDateTime.of(2022, 1, 1, 0, 0, 0);</span></span><br><span class="line"><span class="comment">    long second = time.toEpochSecond(ZoneOffset.UTC);</span></span><br><span class="line"><span class="comment">    System.out.println(second);</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>å…¨å±€å”¯ä¸€IDç”Ÿæˆç­–ç•¥</p>
<ul>
<li>UUID</li>
<li><code>Redis</code>è‡ªå¢</li>
<li>snowflakeç®—æ³•</li>
<li>æ•°æ®åº“è‡ªå¢</li>
</ul>
<p><code>Redis</code>è‡ªå¢ç­–ç•¥</p>
<ul>
<li>æ¯å¤©ä¸€ä¸ªkey,æ–¹ä¾¿ç»Ÿè®¡è®¢å•é‡</li>
<li>IDæ„é€ æ˜¯ æ—¶é—´æˆ³+è®¡æ•°å™¨</li>
</ul>
<hr>
<h3 id="ğŸ‘Œå®ç°ä¼˜æƒ åˆ¸ç§’æ€ä¸‹å•"><a href="#ğŸ‘Œå®ç°ä¼˜æƒ åˆ¸ç§’æ€ä¸‹å•" class="headerlink" title="ğŸ‘Œå®ç°ä¼˜æƒ åˆ¸ç§’æ€ä¸‹å•"></a>ğŸ‘Œå®ç°ä¼˜æƒ åˆ¸ç§’æ€ä¸‹å•</h3><p><strong>ä¸‹å•æ—¶éœ€è¦åˆ¤æ–­ä¸¤ç‚¹ï¼š</strong></p>
<ul>
<li>ç§’æ€æ˜¯å¦å¼€å§‹æˆ–ç»“æŸï¼Œå¦‚æœå°šæœªå¼€å§‹æˆ–å·²ç»ç»“æŸåˆ™æ— æ³•ä¸‹å•</li>
<li>åº“å­˜æ˜¯å¦å……è¶³ï¼Œä¸è¶³åˆ™æ— æ³•ä¸‹å•</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">strat((å¼€å§‹)) --&gt; A[æäº¤ä¼˜æƒ åˆ¸id] --&gt; B[æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯] --&gt; C&#123;&#123;åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å¯&#125;&#125;</span><br><span class="line">C --&gt; |å¦|R[è¿”å›å¼‚å¸¸ç»“æœ] --&gt; last((ç»“æŸ))</span><br><span class="line">C --&gt; |æ˜¯|D&#123;&#123;åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³&#125;&#125;</span><br><span class="line">D --&gt; |å¦|R</span><br><span class="line">D --&gt; |æ˜¯|E[æ‰£å‡åº“å­˜] --&gt; create[åˆ›å»ºè®¢å•] --&gt; re[è¿”å›è®¢å•id] --&gt; last</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å¯</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">//å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">//å·²ç»ç»“æŸ</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">//åº“å­˜ä¸è¶³</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.æ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update().setSql(<span class="string">&quot;stock = stock - 1&quot;</span>).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update();</span><br><span class="line">    <span class="keyword">if</span> (!success)&#123;</span><br><span class="line">        <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6.åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">// 6.1 è®¢å•id</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="comment">// 6.2 ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    <span class="comment">// 6.3 ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    <span class="built_in">this</span>.save(voucherOrder);</span><br><span class="line">    <span class="comment">// 7.è¿”å›è®¢å•id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="ğŸ‘Œè¶…å–é—®é¢˜"><a href="#ğŸ‘Œè¶…å–é—®é¢˜" class="headerlink" title="ğŸ‘Œè¶…å–é—®é¢˜"></a>ğŸ‘Œè¶…å–é—®é¢˜</h3><p><code>è¶…å–é—®é¢˜</code>æ˜¯å…¸å‹çš„å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé’ˆå¯¹è¿™ä¸€é—®é¢˜çš„å¸¸è§è§£å†³æ–¹æ¡ˆå°±æ˜¯åŠ é”ï¼š</p>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230417131236265.png" alt="image-20230417131236265"></p>
<p><strong>ä¹è§‚é”å¸¸ç”¨çš„ä¸¤ç§æ–¹å¼ï¼š</strong></p>
<ul>
<li>ç‰ˆæœ¬å·æ³•</li>
</ul>
<blockquote>
<p>æ·»åŠ <code>version</code>å­—æ®µ,ä¿®æ”¹æ—¶æºå¸¦<code>version</code>å¹¶åˆ¤æ–­ç‰ˆæœ¬å·æ˜¯å¦æ”¹å˜</p>
</blockquote>
<ul>
<li><p>CASæ³•ï¼ˆ<code>CompareAndSet</code>ï¼‰</p>
<blockquote>
<p>ä¿®æ”¹æ—¶ç›´æ¥æºå¸¦<code>stock</code>å¹¶åˆ¤æ–­æ•°é‡æ˜¯å¦æ­£ç¡®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 5.æ‰£å‡åº“å­˜æ—¶å†åˆ¤æ–­ä¸€æ¬¡åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">        .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">        .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">        .gt(<span class="string">&quot;stock&quot;</span>,<span class="number">0</span>)</span><br><span class="line">        .update();</span><br></pre></td></tr></table></figure></blockquote>
</li>
</ul>
<hr>
<ol>
<li>æ‚²è§‚é”ï¼šæ·»åŠ åŒæ­¥é”ï¼Œè®©çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œ<ul>
<li>ä¼˜ç‚¹ï¼šç®€å•ç²—æš´</li>
<li>ç¼ºç‚¹ï¼šæ€§èƒ½ä¸€èˆ¬</li>
</ul>
</li>
<li>ä¹è§‚é”ï¼šä¸åŠ é”ï¼Œåœ¨æ›´æ–°æ—¶åˆ¤æ–­æ˜¯å¦æœ‰å…¶å®ƒçº¿ç¨‹åœ¨ä¿®æ”¹<ul>
<li>ä¼˜ç‚¹ï¼šæ€§èƒ½å¥½</li>
<li>ç¼ºç‚¹ï¼šå­˜åœ¨æˆåŠŸç‡ä½çš„é—®é¢˜</li>
</ul>
</li>
</ol>
<hr>
<h3 id="ğŸ‘Œä¸€äººä¸€å•"><a href="#ğŸ‘Œä¸€äººä¸€å•" class="headerlink" title="ğŸ‘Œä¸€äººä¸€å•"></a>ğŸ‘Œä¸€äººä¸€å•</h3><p>éœ€æ±‚ï¼šä¿®æ”¹ç§’æ€ä¸šåŠ¡ï¼Œè¦æ±‚åŒä¸€ä¸ªä¼˜æƒ åˆ¸ï¼Œä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€å•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">strat((å¼€å§‹)) --&gt; submit(æäº¤ä¼˜æƒ åˆ¸id) --&gt; query(æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯) --&gt; åˆ¤æ–­1&#123;&#123;åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å¯&#125;&#125;</span><br><span class="line"></span><br><span class="line">åˆ¤æ–­1 --&gt; |æ˜¯|åˆ¤æ–­2&#123;&#123;åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³&#125;&#125;</span><br><span class="line">åˆ¤æ–­1 --&gt; |å¦|return(è¿”å›å¼‚å¸¸ç»“æœ) --&gt; last((ç»“æŸ))</span><br><span class="line"></span><br><span class="line">åˆ¤æ–­2 --&gt; |æ˜¯|query2(æ ¹æ®ä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idæŸ¥è¯¢è®¢å•) --&gt; åˆ¤æ–­3(åˆ¤æ–­è®¢å•æ˜¯å¦å­˜åœ¨)</span><br><span class="line">åˆ¤æ–­2 --&gt; |å¦|return</span><br><span class="line"></span><br><span class="line">åˆ¤æ–­3 --&gt; |ä¸å­˜åœ¨|æ‰£å‡(æ‰£å‡åº“å­˜) --&gt; create(åˆ›å»ºè®¢å•) --&gt; a(è¿”å›è®¢å•id) --&gt; last((ç»“æŸ))</span><br><span class="line">åˆ¤æ–­3 --&gt; |å­˜åœ¨|return</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>çŸ¥è¯†ç‚¹éšè®°ï¼š<code>springæ¡†æ¶äº‹åŠ¡å¤±æ•ˆ</code>ã€<code>aopä»£ç†å¯¹è±¡</code>ã€<code>synchronizedé”å¯¹è±¡</code>ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 5.ä¸€äººä¸€å•</span></span><br><span class="line">...</span><br><span class="line">&#123;   </span><br><span class="line">    ...</span><br><span class="line">	<span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// å¯¹ç”¨æˆ·IDåŠ é”</span></span><br><span class="line">	<span class="keyword">synchronized</span>(userId.toString().intern())&#123;</span><br><span class="line">    	<span class="comment">// è·å–ä»£ç†å¯¹è±¡ï¼ˆäº‹åŠ¡ï¼‰</span></span><br><span class="line">	    <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">    	<span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// 5.ä¸€äººä¸€å•</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 5.1 æŸ¥è¯¢è®¢å•</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">    <span class="comment">// 5.2 åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// ç”¨æˆ·å·²è´­ä¹°</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6.æ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">            .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            .update();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 7.åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">// 7.1 è®¢å•id</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="comment">// 7.2 ç”¨æˆ·id</span></span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    <span class="comment">// 7.3 ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    <span class="built_in">this</span>.save(voucherOrder);</span><br><span class="line">    <span class="comment">// 8.è¿”å›è®¢å•id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>ä¸€äººä¸€å•çš„å¹¶å‘å®‰å…¨é—®é¢˜</strong></p>
<p>é€šè¿‡åŠ é”å¯ä»¥è§£å†³åœ¨å•æœºæƒ…å†µä¸‹çš„ä¸€äººä¸€å•å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯åœ¨é›†ç¾¤æ¨¡å¼ä¸‹å°±ä¸è¡Œäº†</p>
<ol>
<li>æˆ‘ä»¬å°†æœåŠ¡å¯åŠ¨ä¸¤ä»½ï¼Œç«¯å£åˆ†åˆ«ä¸º8081å’Œ8082ï¼š</li>
</ol>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230505213208486.png" alt="image-20230505213208486"></p>
<ol start="2">
<li>ç„¶åä¿®æ”¹nginxçš„confç›®å½•ä¸‹çš„nginx.confæ–‡ä»¶ï¼Œé…ç½®åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡ï¼š</li>
</ol>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230505213238125.png" alt="image-20230505213238125"></p>
<p>ç°åœ¨ï¼Œç”¨æˆ·è¯·æ±‚ä¼šåœ¨è¿™ä¸¤ä¸ªèŠ‚ç‚¹ä¸Šè´Ÿè½½å‡è¡¡ï¼Œå†æ¬¡æµ‹è¯•ä¸‹æ˜¯å¦å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p>
<p>å›¾å½¢æ¼”ç¤ºï¼š</p>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230505215636801.png" alt="image-20230505215636801"></p>
<hr>
<h3 id="ğŸ‘Œåˆ†å¸ƒå¼é”"><a href="#ğŸ‘Œåˆ†å¸ƒå¼é”" class="headerlink" title="ğŸ‘Œåˆ†å¸ƒå¼é”"></a>ğŸ‘Œåˆ†å¸ƒå¼é”</h3><p><strong>ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”</strong><br><strong>åˆ†å¸ƒå¼é”</strong>ï¼šæ»¡è¶³åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–é›†ç¾¤æ¨¡å¼ä¸‹å¤šè¿›ç¨‹å¯è§å¹¶ä¸”äº’æ–¥çš„é”ã€‚</p>
<p>åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ˜¯å®ç°å¤šè¿›ç¨‹ä¹‹é—´äº’æ–¥ï¼Œè€Œæ»¡è¶³è¿™ä¸€ç‚¹çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œå¸¸è§çš„æœ‰ä¸‰ç§ï¼š</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">MySQL</th>
<th align="center"><code>Redis</code></th>
<th align="center">Zookeeper</th>
</tr>
</thead>
<tbody><tr>
<td align="center">äº’æ–¥</td>
<td align="center">åˆ©ç”¨MySQLæœ¬èº«çš„äº’æ–¥é”æœºåˆ¶</td>
<td align="center">åˆ©ç”¨<code>setnx</code>è¿™æ ·çš„äº’æ–¥å‘½ä»¤</td>
<td align="center">åˆ©ç”¨èŠ‚ç‚¹çš„å”¯ä¸€æ€§å’Œæœ‰åºæ€§å®ç°äº’æ–¥</td>
</tr>
<tr>
<td align="center">é«˜å¯ç”¨</td>
<td align="center">å¥½</td>
<td align="center">å¥½</td>
<td align="center">å¥½</td>
</tr>
<tr>
<td align="center">é«˜æ€§èƒ½</td>
<td align="center">ä¸€èˆ¬</td>
<td align="center">å¥½</td>
<td align="center">ä¸€èˆ¬</td>
</tr>
<tr>
<td align="center">å®‰å…¨æ€§</td>
<td align="center">æ–­å¼€è¿æ¥ï¼Œè‡ªåŠ¨é‡Šæ”¾é”</td>
<td align="center">åˆ©ç”¨é”è¶…æ—¶æ—¶é—´ï¼Œåˆ°æœŸé‡Šæ”¾</td>
<td align="center">ä¸´æ—¶èŠ‚ç‚¹ï¼Œæ–­å¼€è¿æ¥è‡ªåŠ¨é‡Šæ”¾</td>
</tr>
</tbody></table>
<hr>
<p><strong>åŸºäº<code>Redis</code>çš„åˆ†å¸ƒå¼é”</strong></p>
<p>å®ç°åˆ†å¸ƒå¼é”æ—¶éœ€è¦å®ç°çš„ä¸¤ä¸ªåŸºæœ¬æ–¹æ³•ï¼š</p>
<ul>
<li><p>è·å–é”ï¼š</p>
<ul>
<li><p>äº’æ–¥ï¼šç¡®ä¿åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ é”ï¼Œåˆ©ç”¨setnxçš„äº’æ–¥ç‰¹æ€§</span></span><br><span class="line">SFTNX lock thread1</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>é‡Šæ”¾é”ï¼š</p>
<ul>
<li><p>æ‰‹åŠ¨é‡Šæ”¾</p>
</li>
<li><p>è¶…å¸‚é‡Šæ”¾ï¼šè·å–é”æ—¶æ·»åŠ ä¸€ä¸ªè¶…æ—¶æ—¶é—´</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é‡Šæ”¾é”ï¼Œåˆ é™¤å³å¯</span></span><br><span class="line">DEL key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æ·»åŠ é”ï¼ŒNXæ˜¯äº’æ–¥ã€EXæ˜¯è®¾ç½®è¶…æ—¶æ—¶é—´</span></span><br><span class="line">SET lock thread1 EX 10 NX</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<hr>
<p>æµç¨‹å›¾</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">%%&#123;init: &#123;&#x27;theme&#x27;:&#x27;neutral&#x27;&#125;&#125;%%</span><br><span class="line">flowchart LR</span><br><span class="line">strat((å¼€å§‹)) --&gt; get(å°è¯•è·å–é”) --&gt; åˆ¤æ–­&#123;åˆ¤æ–­ç»“æœ&#125; --&gt; |nil|fail(è·å–é”å¤±è´¥)</span><br><span class="line">	subgraph è·å–é”</span><br><span class="line">	 success(è·å–é”æˆåŠŸ) --&gt; to(æ‰§è¡Œä¸šåŠ¡) </span><br><span class="line">	end</span><br><span class="line">	åˆ¤æ–­ --&gt; |ok|è·å–é” --&gt; |ä¸šåŠ¡è¶…æ—¶æˆ–æœåŠ¡å®•æœºæ—¶|è‡ªåŠ¨(è‡ªåŠ¨é‡Šæ”¾é”)</span><br><span class="line">	to --&gt; é‡Šæ”¾é”(é‡Šæ”¾é”)</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>æ¡ˆä¾‹ åŸºäº<code>Redis</code>å®ç°åˆ†å¸ƒå¼é”åˆçº§ç‰ˆæœ¬</strong><br>éœ€æ±‚ï¼šå®šä¹‰ä¸€ä¸ªç±»ï¼Œå®ç°ä¸‹é¢æ¥å£ï¼Œåˆ©ç”¨<code>Redis</code>å®ç°åˆ†å¸ƒå¼é”åŠŸèƒ½ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ILock</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å°è¯•è·å–é”</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> timeoutSecé”æŒæœ‰çš„è¶…æ—¶æ—¶é—´ï¼Œè¿‡æœŸåè‡ªåŠ¨é‡Šæ”¾</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> trueä»£è¡¨è·å–é”æˆåŠŸï¼›falseä»£è¡¨è·å–é”å¤±è´¥</span></span><br><span class="line"><span class="comment">    â˜…*/</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * é‡Šæ”¾é”</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmdp.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRedisLock</span> <span class="keyword">implements</span> <span class="title class_">ILock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleRedisLock</span><span class="params">(String name, StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–çº¿ç¨‹ID</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">threadId</span> <span class="operator">=</span> Thread.currentThread().getId();</span><br><span class="line">        <span class="comment">//è·å–é”</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">                .setIfAbsent(KEY_PREFIX + name, threadId + <span class="string">&quot;&quot;</span>, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(success);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        stringRedisTemplate.delete(KEY_PREFIX + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 5.ä¸€äººä¸€å•</span></span><br><span class="line"><span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line"><span class="comment">// åˆ›å»ºé”å¯¹è±¡</span></span><br><span class="line"><span class="type">SimpleRedisLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleRedisLock</span>(<span class="string">&quot;order:&quot;</span> + userId, stringRedisTemplate);</span><br><span class="line"><span class="comment">// è·å–é”</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">1200</span>);</span><br><span class="line"><span class="comment">// åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ</span></span><br><span class="line"><span class="keyword">if</span> (!isLock)&#123;</span><br><span class="line">    <span class="comment">// è·å–é”å¤±è´¥,è¿”å›é”™è¯¯æˆ–é‡è¯•</span></span><br><span class="line">    <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–ä»£ç†å¯¹è±¡ï¼ˆäº‹åŠ¡ï¼‰</span></span><br><span class="line">    <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">    <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>è¯¯åˆ é—®é¢˜</strong></p>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230506200307582.png" alt="image-20230506200307582"></p>
<img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230506200343946.png" alt="image-20230506200343946" style="zoom:50%;" />

<hr>
<p><strong>æ¡ˆä¾‹ æ”¹è¿›<code>Redis</code>çš„åˆ†å¸ƒå¼é”</strong><br>éœ€æ±‚ï¼šä¿®æ”¹ä¹‹å‰çš„åˆ†å¸ƒå¼é”å®ç°ï¼Œæ»¡è¶³ï¼š</p>
<ol>
<li>åœ¨è·å–é”æ—¶å­˜å…¥çº¿ç¨‹æ ‡ç¤ºï¼ˆå¯ä»¥ç”¨UUIDè¡¨ç¤ºï¼‰</li>
<li>åœ¨é‡Šæ”¾é”æ—¶å…ˆè·å–é”ä¸­çš„çº¿ç¨‹æ ‡ç¤ºï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡è¯†ä¸€è‡´<ul>
<li>å¦‚æœä¸€è‡´åˆ™é‡Šæ”¾é”</li>
<li>å¦‚æœä¸ä¸€è‡´åˆ™ä¸é‡Šæ”¾é”</li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmdp.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.lang.UUID;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRedisLock</span> <span class="keyword">implements</span> <span class="title class_">ILock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ID_PREFIX</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>) + <span class="string">&quot;-&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleRedisLock</span><span class="params">(String name, StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–çº¿ç¨‹ID</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> ID_PREFIX +  Thread.currentThread().getId();</span><br><span class="line">        <span class="comment">//è·å–é”</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">                .setIfAbsent(KEY_PREFIX + name, threadId, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(success);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–çº¿ç¨‹æ ‡è¯†</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">        <span class="comment">// è·å–é”ä¸­çš„æ ‡è¯†</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(KEY_PREFIX + name);</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ ‡è¯†æ˜¯å¦ä¸€è‡´</span></span><br><span class="line">        <span class="keyword">if</span> (threadId.equals(id))&#123;</span><br><span class="line">            <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">            stringRedisTemplate.delete(KEY_PREFIX + name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜</strong></p>
<img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230506202100754.png" alt="image-20230506202100754" style="zoom:50%;" />

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å½“é‡Šæ”¾é”æ—¶è¿›ç¨‹é˜»å¡ï¼Œå¦‚æœæ­¤æ—¶é”è¶…æ—¶ä¼šè¢«Redisé‡Šæ”¾ï¼Œæ­¤æ—¶å†æ¥ä¸€ä¸ªçº¿ç¨‹2å»è·å–é”æˆåŠŸï¼Œå½“é˜»å¡è¿›ç¨‹ä¸åœ¨é˜»å¡åä¼šç›´æ¥é‡Šæ”¾çº¿ç¨‹2è·å–çš„é”</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨<code>Redis</code>çš„Luaè„šæœ¬è§£å†³<br><code>Redis</code>:æä¾›äº†Luaè„šæœ¬åŠŸèƒ½ï¼Œåœ¨ä¸€ä¸ªè„šæœ¬ä¸­ç¼–å†™å¤šæ¡<code>Redis</code>å‘½ä»¤ï¼Œç¡®ä¿å¤šæ¡å‘½ä»¤æ‰§è¡Œæ—¶çš„åŸå­æ€§ã€‚Luaæ˜¯ä¸€ç§ç¼–<br>ç¨‹è¯­è¨€ï¼Œå®ƒçš„åŸºæœ¬è¯­æ³•å¤§å®¶å¯ä»¥å‚è€ƒç½‘ç«™ï¼š<a target="_blank" rel="noopener" href="https://www.runoob.com/lua/lua-tutorial.html">https://Www.runoob.com/lua/lua-tutorial.html</a></p>
<p>å†™å¥½è„šæœ¬ä»¥åï¼Œéœ€è¦ç”¨<code>Redis</code>å‘½ä»¤æ¥è°ƒç”¨è„šæœ¬ï¼Œè°ƒç”¨è„šæœ¬çš„å¸¸è§å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EVAL script numkeys key [key ...] arg [arg ...]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è°ƒç”¨è„šæœ¬</span></span><br><span class="line">EVAL &quot;return redis.call(&#x27;set&#x27;, &#x27;name&#x27;, &#x27;jack&#x27;)&quot; 0</span><br></pre></td></tr></table></figure>

<hr>
<p>é‡Šæ”¾é”çš„ä¸šåŠ¡æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<p>1.è·å–é”ä¸­çš„çº¿ç¨‹æ ‡ç¤º<br>2.åˆ¤æ–­æ˜¯å¦ä¸æŒ‡å®šçš„æ ‡ç¤ºï¼ˆå½“å‰çº¿ç¨‹æ ‡ç¤º)ä¸€è‡´<br>3.å¦‚æœä¸€è‡´åˆ™é‡Šæ”¾é”ï¼ˆåˆ é™¤ï¼‰<br>4.å¦‚æœä¸ä¸€è‡´åˆ™ä»€ä¹ˆéƒ½ä¸åš</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- è¿™é‡Œçš„KEYSã€Œ1]å°±æ˜¯é”çš„key,è¿™é‡Œçš„ARGV[17</span></span><br><span class="line"><span class="comment">-- å°±æ˜¯å½“å‰çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line"><span class="comment">-- è·å–é”ä¸­çš„æ ‡è¯†ï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡è¯†ä¸€è‡´</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;GET&#x27;</span>,KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>]) <span class="keyword">then</span></span><br><span class="line">	<span class="comment">-- ä¸€è‡´ï¼Œåˆ™åˆ é™¤é”</span></span><br><span class="line">	<span class="keyword">return</span> redis.call(<span class="string">&#x27;DEL&#x27;</span>,KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- ä¸ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<hr>
<p><strong>æ¡ˆä¾‹ å†æ¬¡æ”¹è¿›<code>Redis</code>çš„åˆ†å¸ƒå¼é”</strong></p>
<p>éœ€æ±‚ï¼šåŸºäºLuaè„šæœ¬å®ç°åˆ†å¸ƒå¼é”çš„é‡Šæ”¾é”é€»è¾‘</p>
<p>æç¤ºï¼š<code>RedisTemplate</code>è°ƒç”¨Luaè„šæœ¬çš„APIå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Overried</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">execute</span><span class="params">(RedisScript&lt;T&gt; script, List&lt;K&gt; keys, Object... args)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> scriptExecutor.execute(script, keys, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- luaè„šæœ¬</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;GET&#x27;</span>,KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>]) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- ä¸€è‡´ï¼Œåˆ™åˆ é™¤é”</span></span><br><span class="line">    <span class="keyword">return</span> redis.call(<span class="string">&#x27;DEL&#x27;</span>,KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- ä¸ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmdp.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.lang.UUID;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.RedisScript;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRedisLock</span> <span class="keyword">implements</span> <span class="title class_">ILock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ID_PREFIX</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>) + <span class="string">&quot;-&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; UNLOCK_SCRIPT;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        UNLOCK_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">        UNLOCK_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;unlock.lua&quot;</span>));</span><br><span class="line">        UNLOCK_SCRIPT.setResultType(Long.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleRedisLock</span><span class="params">(String name, StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–çº¿ç¨‹ID</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> ID_PREFIX +  Thread.currentThread().getId();</span><br><span class="line">        <span class="comment">//è·å–é”</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">                .setIfAbsent(KEY_PREFIX + name, threadId, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(success);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//è°ƒç”¨luaè„šæœ¬</span></span><br><span class="line">        stringRedisTemplate.execute(</span><br><span class="line">                UNLOCK_SCRIPT,</span><br><span class="line">                Collections.singletonList(KEY_PREFIX + name),</span><br><span class="line">                ID_PREFIX +  Thread.currentThread().getId()</span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* @Override</span></span><br><span class="line"><span class="comment">    public void unlock() &#123;</span></span><br><span class="line"><span class="comment">        // è·å–çº¿ç¨‹æ ‡è¯†</span></span><br><span class="line"><span class="comment">        String threadId = ID_PREFIX + Thread.currentThread().getId();</span></span><br><span class="line"><span class="comment">        // è·å–é”ä¸­çš„æ ‡è¯†</span></span><br><span class="line"><span class="comment">        String id = stringRedisTemplate.opsForValue().get(KEY_PREFIX + name);</span></span><br><span class="line"><span class="comment">        // åˆ¤æ–­æ ‡è¯†æ˜¯å¦ä¸€è‡´</span></span><br><span class="line"><span class="comment">        if (threadId.equals(id))&#123;</span></span><br><span class="line"><span class="comment">            // é‡Šæ”¾é”</span></span><br><span class="line"><span class="comment">            stringRedisTemplate.delete(KEY_PREFIX + name);</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>æ€»ç»“</strong></p>
<p>åŸºäº<code>Redis</code>çš„åˆ†å¸ƒå¼é”å®ç°æ€è·¯ï¼š</p>
<ul>
<li>åˆ©ç”¨<code>set nx ex</code>è·å–é”ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä¿å­˜çº¿ç¨‹æ ‡ç¤º</li>
<li>é‡Šæ”¾é”æ—¶å…ˆåˆ¤æ–­çº¿ç¨‹æ ‡ç¤ºæ˜¯å¦ä¸è‡ªå·±ä¸€è‡´ï¼Œä¸€è‡´åˆ™åˆ é™¤é”</li>
</ul>
<p>ç‰¹æ€§ï¼š</p>
<ul>
<li>åˆ©ç”¨<code>set nx</code>æ»¡è¶³äº’æ–¥æ€§</li>
<li>åˆ©ç”¨<code>set ex</code>ä¿è¯æ•…éšœæ—¶é”ä¾ç„¶èƒ½é‡Šæ”¾ï¼Œé¿å…æ­»é”ï¼Œæé«˜å®‰å…¨æ€§</li>
<li>åˆ©ç”¨<code>Redis</code>é›†ç¾¤ä¿è¯é«˜å¯ç”¨å’Œé«˜å¹¶å‘ç‰¹æ€§</li>
</ul>
<hr>
<p><strong>åŸºäº<code>Redis</code>çš„åˆ†å¸ƒå¼é”ä¼˜åŒ–</strong></p>
<p>åŸºäº<code>set nx</code>å®ç°çš„åˆ†å¸ƒå¼é”å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š</p>
<ol>
<li>ä¸å¯é‡å…¥<ul>
<li>åŒä¸€ä¸ªçº¿ç¨‹æ— æ³•å¤šæ¬¡è·å–åŒä¸€æŠŠé”</li>
</ul>
</li>
<li>ä¸å¯é‡è¯•<ul>
<li>è·å–é”åªå°è¯•ä¸€æ¬¡å°±è¿”å›<code>false</code>,æ²¡æœ‰é‡è¯•æœºåˆ¶</li>
</ul>
</li>
<li>è¶…æ—¶é‡Šæ”¾<ul>
<li>é”è¶…æ—¶é‡Šæ”¾è™½ç„¶å¯ä»¥é¿å…æ­»é”ï¼Œä½†å¦‚æœæ˜¯ä¸šåŠ¡æ‰§è¡Œè€—æ—¶è¾ƒé•¿ï¼Œä¹Ÿä¼šå¯¼è‡´é”é‡Šæ”¾ï¼Œå­˜åœ¨å®‰å…¨éšæ‚£</li>
</ul>
</li>
<li>ä¸»ä»ä¸€è‡´æ€§<ul>
<li>å¦‚æœ<code>Redis</code>æä¾›äº†ä¸»ä»é›†ç¾¤ï¼Œä¸»ä»åŒæ­¥å­˜åœ¨å»¶è¿Ÿï¼Œå½“ä¸»å®•æœºæ—¶ï¼Œå¦‚æœä»å¹¶åŒæ­¥ä¸»ä¸­çš„é”æ•°æ®ï¼Œåˆ™ä¼šå‡ºç°é”å®ç°</li>
</ul>
</li>
</ol>
<h4 id="Redisson"><a href="#Redisson" class="headerlink" title="Redisson"></a><strong><code>Redisson</code></strong></h4><p><code>Redisson</code>æ˜¯ä¸€ä¸ªåœ¨<code>Redis</code>çš„åŸºç¡€ä¸Šå®ç°çš„avaé©»å†…å­˜æ•°æ®ç½‘æ ¼(In-Memory Data Grid)ã€‚å®ƒä¸ä»…æä¾›äº†ä¸€ç³»åˆ—çš„åˆ†å¸ƒå¼<br>çš„<code>java</code>å¸¸ç”¨å¯¹è±¡ï¼Œè¿˜æä¾›äº†è®¸å¤šåˆ†å¸ƒå¼æœåŠ¡ï¼Œå…¶ä¸­å°±åŒ…å«äº†å„ç§åˆ†å¸ƒå¼é”çš„å®ç°ã€‚</p>
<img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230506222548035.png" alt="image-20230506222548035" style="zoom:50%;" />

<p>å®˜ç½‘åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://redisson.org/">https://redisson.org</a><br>GitHubåœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/redisson/redisson">https://github.com/redisson/redisson</a></p>
<hr>
<p><strong><code>Redission</code> å…¥é—¨</strong></p>
<ol>
<li>å¼•å…¥ä¾èµ–</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.13.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>é…ç½®<code>Redission</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Redissonclientredissonclient</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//é…ç½®ç±»</span></span><br><span class="line">        Config config <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="comment">//æ·»åŠ redis.åœ°å€ï¼Œè¿™é‡Œæ·»åŠ äº†å•ç‚¹çš„åœ°å€ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨config.useclusterServers()æ·»åŠ é›†ç¾¤åœ°å€</span></span><br><span class="line">        config.usesingleServer().setAddress(<span class="string">&quot;redis://192.168.150.101:6379&quot;</span>).setPassowrd(<span class="string">&quot;123321&quot;</span>);</span><br><span class="line">        <span class="comment">//åˆ›å»ºå®¢æˆ·ç«¯</span></span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ä½¿ç”¨<code>Redission</code>çš„åˆ†å¸ƒå¼é”</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> Redissonclient redissonclient;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testRedisson</span><span class="params">()</span><span class="keyword">throws</span> InterruptedException&#123;</span><br><span class="line">    <span class="comment">// è·å–é”ï¼ˆå¯é‡å…¥ï¼‰ï¼ŒæŒ‡å®šé”çš„åç§°</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonclient.getLock(<span class="string">&quot;anyLock&quot;</span>);</span><br><span class="line">    <span class="comment">// å°è¯•è·å–é”ï¼Œå‚æ•°åˆ†åˆ«æ˜¯ï¼šè·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆæœŸé—´ä¼šé‡è¯•ï¼‰ï¼Œé”è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ï¼Œæ—¶é—´å•ä½</span></span><br><span class="line">    <span class="type">boolean</span> isLock lock.tryLock(<span class="number">1</span>,<span class="number">10</span>,TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­é‡Šæ”¾è·å–æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span>(isLock)&#123;</span><br><span class="line">    	<span class="keyword">try</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ‰§è¡Œä¸šåŠ¡&quot;</span>)ï¼›</span><br><span class="line">    	&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">             <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">    		lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong><code>Redisson</code>å¯é‡å…¥é”åŸç†</strong></p>
<img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230507140113175.png" alt="image-20230507140113175" style="zoom:50%;" />

<img src="C:/Users/luoyifei/AppData/Roaming/Typora/typora-user-images/image-20230507140054993.png" alt="image-20230507140054993" style="zoom:50%;" />

<hr>
<p><strong>é”é‡è¯•å’Œ<code>WacthDog</code>æœºåˆ¶</strong></p>
<p><strong>è·å–é” \ é‡Šæ”¾é”æµç¨‹ï¼š</strong></p>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230508211058785.png" alt="image-20230508211058785"></p>
<hr>
<p><strong>æ€»ç»“ï¼š</strong></p>
<p><strong><code>Redisson</code>åˆ†å¸ƒå¼é”åŸç†ï¼š</strong></p>
<ul>
<li><strong>å¯é‡å…¥</strong>ï¼šåˆ©ç”¨Hashç»“æ„è®°å½•çº¿ç¨‹idå’Œé‡å…¥æ¬¡æ•°</li>
<li><strong>å¯é‡è¯•</strong>ï¼šåˆ©ç”¨ä¿¡å·é‡å’Œ<code>PubSub</code>åŠŸèƒ½å®ç°ç­‰å¾…ã€å”¤é†’ï¼Œè·å–é”å¤±è´¥çš„é‡è¯•æœºåˆ¶</li>
<li><strong>è¶…æ—¶ç»­çº¦</strong>ï¼šåˆ©ç”¨<code>WatchDog</code>æœºåˆ¶ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆ<code>releaseTime</code>&#x2F;3ï¼‰,é‡ç½®è¶…æ—¶æ—¶é—´</li>
</ul>
<hr>
<p><strong><code>Redisson</code>åˆ†å¸ƒå¼é”ä¸»ä»ä¸€è‡´æ€§é—®é¢˜:</strong></p>
<p><code>Redisson</code>é€šè¿‡<code>multiLock</code>æ¥è§£å†³ä¸»ä»ä¸€è‡´æ€§é—®é¢˜ï¼š</p>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230508214228870.png" alt="image-20230508214228870"></p>
<hr>
<p><strong>æ€»ç»“</strong></p>
<ol>
<li>ä¸å¯é‡å…¥é”<code>Redis</code>åˆ†å¸ƒå¼é”:</li>
</ol>
<ul>
<li>åŸç†ï¼šåˆ©ç”¨<code>setnx</code>çš„äº’æ–¥æ€§ï¼›åˆ©ç”¨exé¿å…æ­»é”ï¼›é‡Šæ”¾é”æ—¶åˆ¤æ–­çº¿ç¨‹æ ‡è¯†ï¼›</li>
<li>ç¼ºé™·ï¼šä¸å¯é‡å…¥ã€æ— æ³•é‡è¯•ã€é”è¶…æ—¶å¤±æ•ˆ</li>
</ul>
<ol start="2">
<li>å¯é‡å…¥çš„<code>Redis</code>åˆ†å¸ƒå¼é”:</li>
</ol>
<ul>
<li>åŸç†ï¼šåˆ©ç”¨Hashç»“æ„ï¼Œè®°å½•çº¿ç¨‹æ ‡è¯†å’Œé‡å…¥æ¬¡æ•°ï¼›åˆ©ç”¨<code>watchDog</code>æœºåˆ¶å»¶ç»­é”è¿‡æœŸæ—¶é—´ï¼›åˆ©ç”¨ä¿¡å·é‡æ§åˆ¶é”é‡è¯•ç­‰å¾…</li>
<li>ç¼ºé™·ï¼š<code>redis</code>å®•æœºå¼•èµ·é”å¤±æ•ˆé—®é¢˜</li>
</ul>
<ol start="3">
<li><code>Redisson</code>çš„<code>multiLock</code>:</li>
</ol>
<ul>
<li>åŸç†ï¼šå¤šä¸ªç‹¬ç«‹çš„<code>Redis</code>èŠ‚ç‚¹ï¼Œå¿…é¡»åœ¨æ‰€æœ‰èŠ‚ç‚¹éƒ½è·å–é‡å…¥é”ï¼Œæ‰ç®—è·å–æˆåŠŸ</li>
<li>ç¼ºé™·ï¼šè¿ç»´æˆæœ¬é«˜ã€å®ç°å¤æ‚</li>
</ul>
<hr>
<h3 id="ğŸ‘ŒRedisç§’æ€ä¼˜åŒ–"><a href="#ğŸ‘ŒRedisç§’æ€ä¼˜åŒ–" class="headerlink" title="ğŸ‘ŒRedisç§’æ€ä¼˜åŒ–"></a>ğŸ‘Œ<code>Redis</code>ç§’æ€ä¼˜åŒ–</h3><p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230508220925274.png" alt="image-20230508220925274"></p>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230508221651369.png" alt="image-20230508221651369"></p>
<hr>
<p><strong>æ¡ˆä¾‹ æ”¹è¿›ç§’æ€ä¸šåŠ¡ï¼Œæé«˜å¹¶å‘æ€§èƒ½</strong><br>    éœ€æ±‚ï¼š<br>        â‘  æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œå°†ä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°<code>Redis</code>ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜ä¼˜æƒ åˆ¸</span></span><br><span class="line">    save(voucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€ä¿¡æ¯</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">    seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">    seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">    seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">    seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">    seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€åº“å­˜åˆ°Rediså½“ä¸­</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹		â‘¡ åŸºäºLuaè„šæœ¬ï¼Œåˆ¤æ–­ç§’æ€åº“å­˜ã€ä¸€äººä¸€å•ï¼Œå†³å®šç”¨æˆ·æ˜¯å¦æŠ¢è´­æˆåŠŸ</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1.å‚æ•°åˆ—è¡¨</span></span><br><span class="line"><span class="comment">-- 1.1 ä¼˜æƒ åˆ¸ID</span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- 1.2 ç”¨æˆ·ID</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2.æ•°æ®KEY</span></span><br><span class="line"><span class="comment">-- 2.1 åº“å­˜Key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">-- 2.2 è®¢å•Key</span></span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.è„šæœ¬ä¸šåŠ¡</span></span><br><span class="line"><span class="comment">-- 3.1 åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ get stockKey</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.2 åº“å­˜ä¸è¶³</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 3.2åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å• SISMEMBER orderKey userId</span></span><br><span class="line"><span class="keyword">if</span> ((redis.call(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId)) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.3 å­˜åœ¨ï¼Œå³é‡å¤ä¸‹å•</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.4 æ‰£åº“å­˜</span></span><br><span class="line">redis.call(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.5 ä¸‹å•</span></span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 1.æ‰§è¡Œluaè„šæœ¬</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(</span><br><span class="line">            SECKILL_SCRIPT,</span><br><span class="line">            Collections.emptyList(),</span><br><span class="line">            voucherId.toString(),</span><br><span class="line">            userId.toString()</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> result.intValue();</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">// 2.1 ä¸ä¸º0,ä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(r == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2.2 ä¸º0,æœ‰è´­ä¹°èµ„æ ¼,æŠŠä¸‹å•ä¿¡æ¯ä¿å­˜åˆ°é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="comment">// TODO ä¿å­˜åˆ°é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.è¿”å›è®¢å•id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹		â‘¢ å¦‚æœæŠ¢è´­æˆåŠŸï¼Œå°†ä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idå°è£…åå­˜å…¥é˜»å¡é˜Ÿåˆ—</p>
<p>â€‹		â‘£ å¼€å¯çº¿ç¨‹ä»»åŠ¡ï¼Œä¸æ–­ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå®ç°å¼‚æ­¥ä¸‹å•åŠŸèƒ½</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºé˜»å¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">private</span> BlockingQueue&lt;VoucherOrder&gt; orderTasks = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line"><span class="comment">// åˆ›å»ºçº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">SECKILL_ORDER_EXECUTOR</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"><span class="comment">// è¯¥æ³¨è§£ä¼šå…¶æ ‡æ³¨æ–¹æ³•åœ¨è¯¥ç±»è¢«åˆå§‹åŒ–æ—¶æ‰§è¡Œ</span></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">    SECKILL_ORDER_EXECUTOR.submit(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åˆ›å»ºçº¿ç¨‹ä»»åŠ¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="comment">// 1.è·å–é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> orderTasks.take();</span><br><span class="line">                <span class="comment">// 2.åˆ›å»ºè®¢å•</span></span><br><span class="line">                handleVoucherOrder(voucherOrder);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¨é€‰çº¿ç¨‹æ˜¯å–ä¸åˆ°ç”¨æˆ·çš„</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;    </span><br><span class="line">    <span class="comment">// Long userId = UserHolder.getUser().getId();</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥åªèƒ½ç”±voucherOrderè·å¾—</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">    <span class="comment">// åˆ›å»ºé”å¯¹è±¡</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">    <span class="comment">// è·å–é”</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock();</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (!isLock)&#123;</span><br><span class="line">        <span class="comment">// è·å–é”å¤±è´¥,è¿”å›é”™è¯¯æˆ–é‡è¯•</span></span><br><span class="line">        log.error(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        proxy.createVoucherOrder(voucherOrder);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 1.æ‰§è¡Œluaè„šæœ¬</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(</span><br><span class="line">            SECKILL_SCRIPT,</span><br><span class="line">            Collections.emptyList(),</span><br><span class="line">            voucherId.toString(),</span><br><span class="line">            userId.toString()</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> result.intValue();</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">// 2.1 ä¸ä¸º0,ä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(r == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2.2 ä¸º0,æœ‰è´­ä¹°èµ„æ ¼,æŠŠä¸‹å•ä¿¡æ¯ä¿å­˜åˆ°é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">// 2.3 è®¾ç½®è®¢å•ID</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="comment">// 2.4 è®¾ç½®ç”¨æˆ·id</span></span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    <span class="comment">// 2.5 è®¾ç½®ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    <span class="comment">// 2.6 æ”¾å…¥é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    orderTasks.add(voucherOrder);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// è·å–ä»£ç†å¯¹è±¡ï¼ˆäº‹åŠ¡ï¼‰</span></span><br><span class="line">    proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">    <span class="comment">// 4.è¿”å›è®¢å•id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">    <span class="comment">// 5.ä¸€äººä¸€å•</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getId();</span><br><span class="line">    <span class="comment">// åˆ›å»ºé”å¯¹è±¡</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">redisLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">    <span class="comment">// å°è¯•è·å–é”</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> redisLock.tryLock();</span><br><span class="line">    <span class="comment">// åˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (!isLock)&#123;</span><br><span class="line">        <span class="comment">// è·å–é”å¤±è´¥ï¼Œç›´æ¥è¿”å›å¤±è´¥æˆ–é‡è¯•</span></span><br><span class="line">       log.error(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 5.1 æŸ¥è¯¢è®¢å•</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()).count();</span><br><span class="line">        <span class="comment">// 5.2 åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ç”¨æˆ·å·²è´­ä¹°</span></span><br><span class="line">            log.error(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 6.æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId())</span><br><span class="line">                .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>)</span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">            log.error(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.save(voucherOrder);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">        redisLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>æ€»ç»“</strong></p>
<blockquote>
<p><strong>ç§’æ€ä¸šåŠ¡çš„ä¼˜åŒ–æ€è·¯æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
</blockquote>
<p>â‘  å…ˆåˆ©ç”¨<code>Redis</code>å®Œæˆåº“å­˜ä½™é‡ï¼Œä¸€äººä¸€å•åˆ¤æ–­ï¼Œå®ŒæˆæŠ¢å•ä¸šåŠ¡</p>
<p>â‘¡ å†å°†ä¸‹å•ä¸šåŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œåˆ©ç”¨ç‹¬ç«‹çº¿ç¨‹å¼‚æ­¥ä¸‹å•</p>
<blockquote>
<p><strong>åŸºäºé˜»å¡é˜Ÿåˆ—çš„å¼‚æ­¥ç§’æ€å­˜åœ¨å“ªäº›é—®é¢˜?</strong></p>
</blockquote>
<ul>
<li>å†…å­˜é™åˆ¶é—®é¢˜</li>
<li>æ•°æ®å®‰å…¨é—®é¢˜</li>
</ul>
<hr>
<h3 id="ğŸ‘ŒRedisiæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ç§’æ€"><a href="#ğŸ‘ŒRedisiæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ç§’æ€" class="headerlink" title="ğŸ‘ŒRedisiæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ç§’æ€"></a>ğŸ‘Œ<code>Redisi</code>æ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ç§’æ€</h3><p><code>æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queue)</code>,å­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚æœ€ç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹åŒ…æ‹¬3ä¸ªè§’è‰²ï¼š</p>
<ul>
<li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­˜å‚¨å’Œç®¡ç†æ¶ˆæ¯ï¼Œä¹Ÿè¢«ç§°ä¸º<code>æ¶ˆæ¯ä»£ç†ï¼ˆMessage Broker)</code></li>
<li>ç”Ÿäº§è€…ï¼šå‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—</li>
<li>æ¶ˆè´¹è€…ï¼šä»æ¶ˆæ¯é˜Ÿåˆ—è·å–æ¶ˆæ¯å¹¶å¤„ç†æ¶ˆæ¯</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">subgraph ç”Ÿäº§è€…</span><br><span class="line">	åˆ¤æ–­ç§’æ€æ—¶é—´å’Œåº“å­˜ --&gt; æ ¡éªŒä¸€äººä¸€å• --&gt; å‘é€ä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idåˆ°æ¶ˆæ¯é˜Ÿåˆ—</span><br><span class="line">end</span><br><span class="line">ç”Ÿäº§è€… --&gt; m[(Message Queue)] --&gt; æ¶ˆè´¹è€…</span><br><span class="line">subgraph æ¶ˆè´¹è€…</span><br><span class="line">	æ¥æ”¶æ¶ˆæ¯å®Œæˆä¸‹å•</span><br><span class="line">end</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>Redis</code> ä¸­æä¾›äº†ä¸‰ç§ä¸åŒçš„æ–¹å¼æ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼š</p>
<ul>
<li><code>List</code>ç»“æ„ï¼šåŸºäºListç»“æ„æ¨¡æ‹Ÿæ¶ˆæ¯é˜Ÿåˆ—</li>
<li><code>PubSub</code>ï¼šåŸºæœ¬çš„ç‚¹å¯¹ç‚¹æ¶ˆæ¯æ¨¡å‹</li>
<li>Streamï¼šæ¯”è¾ƒå®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹</li>
</ul>
<hr>
<p><strong>åŸºäºListç»“æ„æ¨¡æ‹Ÿæ¶ˆæ¯é˜Ÿåˆ—</strong></p>
<p>æ¶ˆæ¯é˜Ÿåˆ—(Message Queue),å­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚è€Œ<code>Redis</code>çš„<code>list</code>æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¾ˆå®¹æ˜“æ¨¡æ‹Ÿå‡ºé˜Ÿåˆ—æ•ˆæœã€‚</p>
<p>é˜Ÿåˆ—æ˜¯å…¥å£å’Œå‡ºå£ä¸åœ¨ä¸€è¾¹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ï¼šLPUSHç»“åˆRPOPã€æˆ–è€…RPUSHç»“åˆLPOPæ¥å®ç°ã€‚</p>
<p>ä¸è¿‡è¦æ³¨æ„çš„æ˜¯ï¼Œå½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯æ—¶RPOPæˆ–LPOPæ“ä½œä¼šè¿”å›<code>null</code>,å¹¶ä¸åƒVMçš„é˜»å¡é˜Ÿåˆ—é‚£æ ·ä¼šé˜»å¡å¹¶ç­‰å¾…æ¶ˆæ¯<br>å› æ­¤è¿™é‡Œåº”è¯¥ä½¿ç”¨BRPOPæˆ–è€…BLPOPæ¥å®ç°é˜»å¡æ•ˆæœã€‚</p>
<hr>
<p><strong>æ€»ç»“ï¼š</strong></p>
<p>åŸºäº<code>List</code>çš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ<br>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>åˆ©ç”¨<code>Redis</code>å­˜å‚¨ï¼Œä¸å—é™äºVMå†…å­˜ä¸Šé™</li>
<li>åŸºäº<code>Redis</code>çš„æŒä¹…åŒ–æœºåˆ¶ï¼Œæ•°æ®å®‰å…¨æ€§æœ‰ä¿è¯</li>
<li>å¯ä»¥æ»¡è¶³æ¶ˆæ¯æœ‰åºæ€§</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±</li>
<li>åªæ”¯æŒå•æ¶ˆè´¹è€…</li>
</ul>
<hr>
<p><strong>åŸºäº<code>PubSub</code>çš„æ¶ˆæ¯é˜Ÿåˆ—</strong></p>
<p><code>PubSub</code>ï¼ˆå‘å¸ƒè®¢é˜…)æ˜¯Redis2.0ç‰ˆæœ¬å¼•å…¥çš„æ¶ˆæ¯ä¼ é€’æ¨¡å‹ã€‚é¡¾åæ€ä¹‰ï¼Œæ¶ˆè´¹è€…å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ª<code>channel</code>,ç”Ÿäº§è€…å‘å¯¹åº”<code>channel</code>å‘é€æ¶ˆæ¯åï¼Œæ‰€æœ‰è®¢é˜…è€…éƒ½èƒ½æ”¶åˆ°ç›¸å…³æ¶ˆæ¯ã€‚</p>
<ul>
<li><code>SUBSCRIBE channel [channel]</code>ï¼šè®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“</li>
<li><code>PUBLISH channel msg</code>ï¼šå‘ä¸€ä¸ªé¢‘é“å‘é€æ¶ˆæ¯</li>
<li><code>PSUBSCRIBE pattern [pattern]</code>ï¼šè®¢é˜…ä¸patternæ ¼å¼åŒ¹é…çš„æ‰€æœ‰é¢‘é“</li>
</ul>
<hr>
<p><strong>æ€»ç»“ï¼š</strong></p>
<p>åŸºäº<code>PubSub</code>çš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ<br>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>é‡‡ç”¨å‘å¸ƒè®¢é˜…æ¨¡å‹ï¼Œæ”¯æŒå¤šç”Ÿäº§ã€å¤šæ¶ˆè´¹</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>ä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–</li>
<li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±</li>
<li>æ¶ˆæ¯å †ç§¯æœ‰ä¸Šé™ï¼Œè¶…å‡ºæ—¶æ•°æ®ä¸¢å¤±</li>
</ul>
<hr>
<p><strong>åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—</strong></p>
<p><code>Stream</code>æ˜¯<code>Redis5.0</code>å¼•å…¥çš„ä¸€ç§æ–°æ•°æ®ç±»å‹ï¼Œå¯ä»¥å®ç°ä¸€ä¸ªåŠŸèƒ½éå¸¸å®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230509223217785.png" alt="image-20230509223217785"></p>
<p>ä¾‹å¦‚ï¼š</p>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230509223242364.png" alt="image-20230509223242364"></p>
<p>è¯»å–æ¶ˆæ¯çš„æ–¹å¼ä¹‹ä¸€ï¼š<code>XREAD</code></p>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230509223757060.png" alt="image-20230509223757060"></p>
<hr>
<p><strong>æ€»ç»“</strong></p>
<p>STREAM:ç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADå‘½ä»¤ç‰¹ç‚¹</p>
<ul>
<li>æ¶ˆæ¯å¯å›æ½®</li>
<li>ä¸€ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…è¯»å–</li>
<li>å¯ä»¥é˜»å¡è¯»å–</li>
<li>æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©</li>
</ul>
<hr>
<p><strong>åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„</strong></p>
<p>æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Group):å°†å¤šä¸ªæ¶ˆè´¹è€…åˆ’åˆ†åˆ°ä¸€ä¸ªç»„ä¸­ï¼Œç›‘å¬åŒä¸€ä¸ªé˜Ÿåˆ—ã€‚å…·å¤‡ä¸‹åˆ—ç‰¹ç‚¹ï¼š</p>
<ol>
<li>æ¶ˆæ¯åˆ†æµ</li>
</ol>
<blockquote>
<p>é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¼šåˆ†æµç»™ç»„å†…çš„ä¸åŒæ¶ˆè´¹è€…ï¼Œè€Œä¸æ˜¯é‡å¤æ¶ˆè´¹ï¼Œä»è€ŒåŠ å¿«æ¶ˆæ¯å¤„ç†çš„é€Ÿåº¦</p>
</blockquote>
<ol start="2">
<li>æ¶ˆæ¯æ ‡è¯†</li>
</ol>
<blockquote>
<p>æ¶ˆè´¹è€…ç»„ä¼šç»´æŠ¤ä¸€ä¸ªæ ‡ç¤ºè®°å½•æœ€åä¸€ä¸ªè¢«å¤„ç†çš„æ¶ˆæ¯ï¼Œå“ªæ€•æ¶ˆè´¹è€…å®•æœºé‡å¯ï¼Œè¿˜ä¼šä»æ ‡ç¤ºä¹‹åè¯»å–æ¶ˆæ¯ã€‚ç¡®ä¿æ¯ä¸€ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æ¶ˆè´¹</p>
</blockquote>
<ol start="3">
<li>æ¶ˆæ¯ç¡®è®¤</li>
</ol>
<blockquote>
<p>æ¶ˆè´¹è€…è·å–æ¶ˆæ¯åï¼Œæ¶ˆæ¯å¤„äº<code>pending</code>çŠ¶æ€ï¼Œå¹¶å­˜å…¥ä¸€ä¸ª<code>pending-list</code>ã€‚å½“å¤„ç†å®Œæˆåéœ€è¦é€šè¿‡<code>XACK</code>æ¥ç¡®è®¤æ¶ˆæ¯ï¼Œæ ‡è®°æ¶ˆæ¯ä¸ºå·²å¤„ç†ï¼Œæ‰ä¼šä»<code>pending-List</code>ç§»é™¤ã€‚</p>
</blockquote>
<hr>
<p>åˆ›å»ºæ¶ˆè´¹è€…ç»„ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XGROUP CREATE key groupName ID [MKSTREAM]</span><br></pre></td></tr></table></figure>

<ul>
<li><code>key</code>:é˜Ÿåˆ—åç§°</li>
<li><code>groupName</code>:æ¶ˆè´¹è€…ç»„åç§°</li>
<li><code>ID</code>:èµ·å§‹IDæ ‡ç¤ºï¼Œ<code>$</code>ä»£è¡¨é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªæ¶ˆæ¯ï¼Œ<code>0</code>åˆ™ä»£è¡¨é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ¶ˆæ¯</li>
<li><code>MKSTREAM</code>: é˜Ÿåˆ—ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—</li>
</ul>
<p>å…¶ä»–å¸¸è§å‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">åˆ é™¤æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„</span></span><br><span class="line">XGROUP DESTORY key groupName</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ç»™æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„æ·»åŠ æ¶ˆè´¹è€…</span></span><br><span class="line">XGROUP CREATECONSUMER key groupname consumername</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">åˆ é™¤æ¶ˆè´¹è€…ç»„ä¸­çš„æŒ‡å®šæ¶ˆè´¹è€…</span></span><br><span class="line">XGROUP DELCONSUMER key groupname consumername</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key ...] ID [ID ...]</span><br></pre></td></tr></table></figure>

<ul>
<li><code>group</code>:æ¶ˆè´¹ç»„åç§°</li>
<li><code>consumer</code>ï¼šæ¶ˆè´¹è€…åç§°ï¼Œå¦‚æœæ¶ˆè´¹è€…ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…</li>
<li><code>count</code>:æœ¬æ¬¡æŸ¥è¯¢çš„æœ€å¤§æ•°é‡</li>
<li><code>BLOCK milliseconds</code>:å½“æ²¡æœ‰æ¶ˆæ¯æ—¶æœ€é•¿ç­‰å¾…æ—¶é—´</li>
<li><code>NOACK</code>:æ— éœ€æ‰‹åŠ¨ACK,è·å–åˆ°æ¶ˆæ¯åè‡ªåŠ¨ç¡®è®¤</li>
<li>STREAMS key:æŒ‡å®šé˜Ÿåˆ—åç§°</li>
<li>ID:è·å–æ¶ˆæ¯çš„èµ·å§‹ID:<ul>
<li>â€œ&gt;â€ï¼šä»ä¸‹ä¸€ä¸ªæœªæ¶ˆè´¹çš„æ¶ˆæ¯å¼€å§‹</li>
<li>å…¶ä»–ï¼šæ ¹æ®æŒ‡å®šidä»<code>pending-list</code>ä¸­è·å–å·²æ¶ˆè´¹ä½†æœªç¡®è®¤çš„æ¶ˆæ¯ï¼Œä¾‹å¦‚0ï¼Œæ˜¯ä»pending-listä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯å¼€å§‹</li>
</ul>
</li>
</ul>
<hr>
<p><strong>æ€»ç»“</strong></p>
<p>STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADGROUPå‘½ä»¤ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ¶ˆæ¯å¯å›æº¯</li>
<li>å¯ä»¥å¤šæ¶ˆè´¹è€…äº‰æŠ¢æ¶ˆæ¯ï¼ŒåŠ å¿«æ¶ˆè´¹é€Ÿåº¦</li>
<li>å¯ä»¥é˜»å¡è¯»å–</li>
<li>æ²¡æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©</li>
<li>æœ‰æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼Œä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡</li>
</ul>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">List</th>
<th align="center">PubSub</th>
<th align="center">Stream</th>
</tr>
</thead>
<tbody><tr>
<td align="center">æ¶ˆæ¯æŒä¹…åŒ–</td>
<td align="center">æ”¯æŒ</td>
<td align="center">ä¸æ”¯æŒ</td>
<td align="center">æ”¯æŒ</td>
</tr>
<tr>
<td align="center">é˜»å¡è¯»å–</td>
<td align="center">æ”¯æŒ</td>
<td align="center">æ”¯æŒ</td>
<td align="center">æ”¯æŒ</td>
</tr>
<tr>
<td align="center">æ¶ˆæ¯å †ç§¯å¤„ç†</td>
<td align="center">å—é™äºå†…å­˜ç©ºé—´ï¼Œå¯ä»¥åˆ©ç”¨å¤šæ¶ˆè´¹è€…åŠ å¿«å¤„ç†</td>
<td align="center">å—é™äºæ¶ˆè´¹è€…ç¼“å†²åŒº</td>
<td align="center">å—é™äºé˜Ÿåˆ—é•¿åº¦ï¼Œå¯ä»¥åˆ©ç”¨æ¶ˆè´¹è€…ç»„æé«˜æ¶ˆè´¹é€Ÿåº¦ï¼Œå‡å°‘å †ç§¯</td>
</tr>
<tr>
<td align="center">æ¶ˆæ¯ç¡®è®¤æœºåˆ¶</td>
<td align="center">ä¸æ”¯æŒ</td>
<td align="center">ä¸æ”¯æŒ</td>
<td align="center">æ”¯æŒ</td>
</tr>
<tr>
<td align="center">æ¶ˆæ¯å›æº¯</td>
<td align="center">ä¸æ”¯æŒ</td>
<td align="center">ä¸æ”¯æŒ</td>
<td align="center">æ”¯æŒ</td>
</tr>
</tbody></table>
<hr>
<p><strong>æ¡ˆä¾‹ åŸºäºRedisçš„Streamç»“æ„ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°å¼‚æ­¥ç§’æ€ä¸‹å•</strong><br>éœ€æ±‚ï¼š<br>â‘ åˆ›å»ºä¸€ä¸ªStreamç±»å‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåä¸º<code>stream.orders</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XGROUP CREATE stream.orders g1 0 MKSTREAM</span><br></pre></td></tr></table></figure>

<p>â‘¡ä¿®æ”¹ä¹‹å‰çš„ç§’æ€ä¸‹å•Luaè„šæœ¬ï¼Œåœ¨è®¤å®šæœ‰æŠ¢è´­èµ„æ ¼åï¼Œç›´æ¥å‘<code>stream.orders</code>ä¸­æ·»åŠ æ¶ˆæ¯ï¼Œå†…å®¹åŒ…å«<code>voucherld</code>ã€<code>userld</code>ã€<code>orderld</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1.å‚æ•°åˆ—è¡¨</span></span><br><span class="line"><span class="comment">-- 1.1 ä¼˜æƒ åˆ¸ID</span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- 1.2 ç”¨æˆ·ID</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="comment">-- 1.2 ç”¨æˆ·ID</span></span><br><span class="line"><span class="keyword">local</span> orderId = ARGV[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2.æ•°æ®KEY</span></span><br><span class="line"><span class="comment">-- 2.1 åº“å­˜Key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">-- 2.2 è®¢å•Key</span></span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.è„šæœ¬ä¸šåŠ¡</span></span><br><span class="line"><span class="comment">-- 3.1 åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ get stockKey</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.2 åº“å­˜ä¸è¶³</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 3.2åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å• SISMEMBER orderKey userId</span></span><br><span class="line"><span class="keyword">if</span> ((redis.call(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId)) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.3 å­˜åœ¨ï¼Œå³é‡å¤ä¸‹å•</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.4 æ‰£åº“å­˜</span></span><br><span class="line">redis.call(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.5 ä¸‹å•</span></span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId)</span><br><span class="line"></span><br><span class="line"><span class="comment">--3.6 å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ— XADD stream.orders * k1 v1 k2 v2</span></span><br><span class="line">redis.call(<span class="string">&#x27;xadd&#x27;</span>, <span class="string">&#x27;stream.orders&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;userId&#x27;</span>, userId, <span class="string">&#x27;voucherId&#x27;</span>, voucherId, <span class="string">&#x27;id&#x27;</span>, orderId)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>â‘¢é¡¹ç›®å¯åŠ¨æ—¶ï¼Œå¼€å¯ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡ï¼Œå°è¯•è·å–<code>stream.orders</code>ä¸­çš„æ¶ˆæ¯ï¼Œå®Œæˆä¸‹å•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºçº¿ç¨‹ä»»åŠ¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;stream.orders&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 1.è·å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS stream.orders &gt;</span></span><br><span class="line">                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(</span><br><span class="line">                        Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                        StreamReadOptions.empty().count(<span class="number">1</span>).block(Duration.ofSeconds(<span class="number">2</span>)),</span><br><span class="line">                        StreamOffset.create(queueName, ReadOffset.lastConsumed())</span><br><span class="line">                );</span><br><span class="line">                <span class="comment">// 2.åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦è·å–æˆåŠŸ</span></span><br><span class="line">                <span class="keyword">if</span> (list == <span class="literal">null</span> || list.isEmpty())&#123;</span><br><span class="line">                    <span class="comment">// 2.1 å¦‚æœå¤±è´¥ï¼Œè¯´æ˜æ²¡æœ‰æ¶ˆæ¯ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 3.è§£ææ¶ˆæ¯ä¸­çš„è®¢å•ä¿¡æ¯</span></span><br><span class="line">                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="number">0</span>);</span><br><span class="line">                Map&lt;Object, Object&gt; values = record.getValue();</span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(values, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                <span class="comment">// 3.è·å–æˆåŠŸï¼Œå¯ä»¥ä¸‹å•</span></span><br><span class="line">                handleVoucherOrder(voucherOrder);</span><br><span class="line">                <span class="comment">// 4.ACKç¡®è®¤ SACK stream.orders g1 id</span></span><br><span class="line">                stringRedisTemplate.opsForStream().acknowledge(queueName, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                handlePendingList();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlePendingList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 1.è·å–pending-listä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 STREAMS stream.orders 0</span></span><br><span class="line">                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(</span><br><span class="line">                        Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                        StreamReadOptions.empty().count(<span class="number">1</span>),</span><br><span class="line">                        StreamOffset.create(queueName, ReadOffset.from(<span class="string">&quot;0&quot;</span>))</span><br><span class="line">                );</span><br><span class="line">                <span class="comment">// 2.åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦è·å–æˆåŠŸ</span></span><br><span class="line">                <span class="keyword">if</span> (list == <span class="literal">null</span> || list.isEmpty())&#123;</span><br><span class="line">                    <span class="comment">// 2.1 å¦‚æœå¤±è´¥ï¼Œè¯´æ˜pending-listä¸­æ²¡æœ‰æ¶ˆæ¯ï¼Œç»“æŸå¾ªç¯</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 3.è§£ææ¶ˆæ¯ä¸­çš„è®¢å•ä¿¡æ¯</span></span><br><span class="line">                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="number">0</span>);</span><br><span class="line">                Map&lt;Object, Object&gt; values = record.getValue();</span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(values, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                <span class="comment">// 3.è·å–æˆåŠŸï¼Œå¯ä»¥ä¸‹å•</span></span><br><span class="line">                handleVoucherOrder(voucherOrder);</span><br><span class="line">                <span class="comment">// 4.ACKç¡®è®¤ SACK stream.orders g1 id</span></span><br><span class="line">                stringRedisTemplate.opsForStream().acknowledge(queueName, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;å¤„ç†pending-listè®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">20</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// è·å–è®¢å•ID</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="comment">// 1.æ‰§è¡Œluaè„šæœ¬</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(</span><br><span class="line">            SECKILL_SCRIPT,</span><br><span class="line">            Collections.emptyList(),</span><br><span class="line">            voucherId.toString(),</span><br><span class="line">            userId.toString(),</span><br><span class="line">            String.valueOf(orderId)</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> result.intValue();</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">// 2.1 ä¸ä¸º0,ä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(r == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// è·å–ä»£ç†å¯¹è±¡ï¼ˆäº‹åŠ¡ï¼‰</span></span><br><span class="line">    proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">    <span class="comment">// 4.è¿”å›è®¢å•id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-è¾¾äººæ¢åº—"><a href="#4-è¾¾äººæ¢åº—" class="headerlink" title="4.è¾¾äººæ¢åº—"></a>4.è¾¾äººæ¢åº—</h2><h3 id="ğŸ‘Œå‘å¸ƒæ¢åº—ç…§ç‰‡"><a href="#ğŸ‘Œå‘å¸ƒæ¢åº—ç…§ç‰‡" class="headerlink" title="ğŸ‘Œå‘å¸ƒæ¢åº—ç…§ç‰‡"></a>ğŸ‘Œå‘å¸ƒæ¢åº—ç…§ç‰‡</h3><p>æ¢åº—ç¬”è®°ç±»ä¼¼ç‚¹è¯„ç½‘ç«™çš„è¯„ä»·ï¼Œå¾€å¾€æ˜¯å›¾æ–‡ç»“åˆã€‚å¯¹åº”çš„è¡¨æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li><code>tb_blog</code>:æ¢åº—ç¬”è®°è¡¨ï¼ŒåŒ…å«ç¬”è®°ä¸­çš„æ ‡é¢˜ã€æ–‡å­—ã€å›¾ç‰‡ç­‰</li>
<li><code>tb blog_comments</code>:å…¶ä»–ç”¨æˆ·å¯¹æ¢åº—ç¬”è®°çš„è¯„ä»·</li>
</ul>
<hr>
<p><strong>æ¡ˆä¾‹ å®ç°æŸ¥çœ‹å‘å¸ƒæ¢åº—ç¬”è®°çš„æ¥å£</strong><br>éœ€æ±‚ï¼šç‚¹å‡»é¦–é¡µçš„æ¢åº—ç¬”è®°ï¼Œä¼šè¿›å…¥è¯¦æƒ…é¡µé¢ï¼Œå®ç°è¯¥é¡µé¢çš„æŸ¥è¯¢æ¥å£ï¼š</p>
<hr>
<h3 id="ğŸ‘Œç‚¹èµ"><a href="#ğŸ‘Œç‚¹èµ" class="headerlink" title="ğŸ‘Œç‚¹èµ"></a>ğŸ‘Œç‚¹èµ</h3><p>åœ¨é¦–é¡µçš„æ¢åº—ç¬”è®°æ’è¡Œæ¦œå’Œæ¢åº—å›¾æ–‡è¯¦æƒ…é¡µé¢éƒ½æœ‰ç‚¹èµçš„åŠŸèƒ½ï¼š</p>
<hr>
<p><strong>æ¡ˆä¾‹ å®Œå–„ç‚¹èµåŠŸèƒ½</strong><br>éœ€æ±‚ï¼š</p>
<ul>
<li>åŒä¸€ä¸ªç”¨æˆ·åªèƒ½ç‚¹èµä¸€æ¬¡ï¼Œå†æ¬¡ç‚¹å‡»åˆ™å–æ¶ˆç‚¹èµ</li>
<li>å¦‚æœå½“å‰ç”¨æˆ·å·²ç»ç‚¹èµï¼Œåˆ™ç‚¹èµæŒ‰é’®é«˜äº®æ˜¾ç¤ºï¼ˆå‰ç«¯å·²å®ç°ï¼Œåˆ¤æ–­å­—æ®µBlogç±»çš„<code>isLike</code>å±æ€§)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryHotBlog</span><span class="params">(Integer current)</span> &#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®ç”¨æˆ·æŸ¥è¯¢</span></span><br><span class="line">    Page&lt;Blog&gt; page = query()</span><br><span class="line">            .orderByDesc(<span class="string">&quot;liked&quot;</span>)</span><br><span class="line">            .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class="line">    <span class="comment">// è·å–å½“å‰é¡µæ•°æ®</span></span><br><span class="line">    List&lt;Blog&gt; records = page.getRecords();</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">    records.forEach(blog -&gt; &#123;</span><br><span class="line">        queryBlogUser(blog);</span><br><span class="line">        isBlogLiked(blog);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(records);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">Blog</span> <span class="variable">blog</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="keyword">if</span> (blog == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åšå®¢ä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    queryBlogUser(blog);</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æ˜¯å¦è¢«ç‚¹èµ</span></span><br><span class="line">    isBlogLiked(blog);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">isBlogLiked</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="keyword">if</span> (userId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().isMember(BLOG_LIKED_KEY + blog.getId(), userId.toString());</span><br><span class="line">        blog.setIsLike(BooleanUtil.isTrue(isMember));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().isMember(BLOG_LIKED_KEY + id, userId.toString());</span><br><span class="line">    <span class="keyword">if</span> (BooleanUtil.isFalse(isMember)) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">            stringRedisTemplate.opsForSet().add(BLOG_LIKED_KEY + id, userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">            stringRedisTemplate.opsForSet().remove(BLOG_LIKED_KEY + id, userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="ğŸ‘Œç‚¹èµæ’è¡Œæ¦œ"><a href="#ğŸ‘Œç‚¹èµæ’è¡Œæ¦œ" class="headerlink" title="ğŸ‘Œç‚¹èµæ’è¡Œæ¦œ"></a>ğŸ‘Œç‚¹èµæ’è¡Œæ¦œ</h3><p>åœ¨æ¢åº—ç¬”è®°çš„è¯¦æƒ…é¡µé¢ï¼Œåº”è¯¥æŠŠç»™è¯¥ç¬”è®°ç‚¹èµçš„äººæ˜¾ç¤ºå‡ºæ¥ï¼Œæ¯”å¦‚æœ€æ—©ç‚¹èµçš„TOP5,å½¢æˆç‚¹èµæ’è¡Œæ¦œï¼š</p>
<hr>
<p><strong>æ¡ˆä¾‹ å®ç°æŸ¥è¯¢ç‚¹èµæ’è¡Œæ¦œçš„æ¥å£</strong><br>éœ€æ±‚ï¼šæŒ‰ç…§ç‚¹èµæ—¶é—´å…ˆåæ’åºï¼Œè¿”å›Top5çš„ç”¨æˆ·</p>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230512205432498.png" alt="image-20230512205432498"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(BLOG_LIKED_KEY + id, userId.toString());</span><br><span class="line">    <span class="keyword">if</span> (score == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="comment">// zadd key value score</span></span><br><span class="line">        <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">            <span class="comment">// æ”¹ä¸ºZSETæ•°æ®ç±»å‹</span></span><br><span class="line">            stringRedisTemplate.opsForZSet().add(BLOG_LIKED_KEY + id, userId.toString(), System.currentTimeMillis());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">            stringRedisTemplate.opsForZSet().remove(BLOG_LIKED_KEY + id, userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogLikes</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// zrang key 0 4</span></span><br><span class="line">    Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(BLOG_LIKED_KEY + id, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="comment">// è§£æ</span></span><br><span class="line">    <span class="keyword">if</span> (top5 == <span class="literal">null</span> || top5.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.EMPTY_LIST);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Long&gt; ids = top5.stream().map(Long::valueOf).collect(Collectors.toList());</span><br><span class="line">    <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">    List&lt;UserDTO&gt; userDTOs = userService</span><br><span class="line">            .query()</span><br><span class="line">            .in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span>+ idStr +<span class="string">&quot;)&quot;</span>).list()</span><br><span class="line">            .stream()</span><br><span class="line">            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> Result.ok(userDTOs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-å¥½å‹å…³æ³¨"><a href="#5-å¥½å‹å…³æ³¨" class="headerlink" title="5.å¥½å‹å…³æ³¨"></a>5.å¥½å‹å…³æ³¨</h2><h3 id="ğŸ‘Œå…³æ³¨ä¸å–å…³"><a href="#ğŸ‘Œå…³æ³¨ä¸å–å…³" class="headerlink" title="ğŸ‘Œå…³æ³¨ä¸å–å…³"></a>ğŸ‘Œå…³æ³¨ä¸å–å…³</h3><p><strong>æ¡ˆä¾‹ å®ç°å…³æ³¨å’Œå–å…³åŠŸèƒ½</strong><br>éœ€æ±‚ï¼šåŸºäºè¯¥è¡¨æ•°æ®ç»“æ„ï¼Œå®ç°ä¸¤ä¸ªæ¥å£ï¼š<br>â‘  å…³æ³¨å’Œå–å…³æ¥å£<br>â‘¡ åˆ¤æ–­æ˜¯å¦å…³æ³¨çš„æ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmdp.service.impl;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.dto.Result;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.dto.UserDTO;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.entity.Follow;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.mapper.FollowMapper;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.service.IFollowService;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.utils.UserHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *  æœåŠ¡å®ç°ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> è™å“¥</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-12-22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FollowServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;FollowMapper, Follow&gt; <span class="keyword">implements</span> <span class="title class_">IFollowService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFollow)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ¤æ–­isFollow</span></span><br><span class="line">        <span class="keyword">if</span> (isFollow) &#123;</span><br><span class="line">            <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">            follow.setUserId(userId);</span><br><span class="line">            follow.setFollowUserId(followUserId);</span><br><span class="line">            save(follow);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            remove(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;Follow&gt;()</span><br><span class="line">                    .eq(<span class="string">&quot;user_id&quot;</span>, userId)</span><br><span class="line">                    .eq(<span class="string">&quot;follow_user_id&quot;</span>,followUserId));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">isFollow</span><span class="params">(Long followUserId)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//æŸ¥è¯¢æ˜¯å¦å…³æ³¨</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId).count();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.ok(count &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="ğŸ‘Œå…±åŒå…³æ³¨"><a href="#ğŸ‘Œå…±åŒå…³æ³¨" class="headerlink" title="ğŸ‘Œå…±åŒå…³æ³¨"></a>ğŸ‘Œå…±åŒå…³æ³¨</h3><p><strong>æ¡ˆä¾‹ ç°å…±åŒå…³æ³¨åŠŸèƒ½</strong><br>éœ€æ±‚ï¼šåˆ©ç”¨<code>Redis</code>ä¸­æ°å½“çš„æ•°æ®ç»“æ„ï¼Œå®ç°å…±åŒå…³æ³¨åŠŸèƒ½ã€‚åœ¨åšä¸»ä¸ªäººé¡µé¢å±•ç¤ºå‡ºå½“å‰ç”¨æˆ·ä¸åšä¸»çš„å…±åŒå¥½å‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">followCommons</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follow:&quot;</span> + userId;</span><br><span class="line">    <span class="comment">// æ±‚äº¤é›†</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key2</span> <span class="operator">=</span> <span class="string">&quot;follow:&quot;</span> + id;</span><br><span class="line">    Set&lt;String&gt; intersect = stringRedisTemplate.opsForSet().intersect(key, key2);</span><br><span class="line">    <span class="comment">// è§£æ</span></span><br><span class="line">    <span class="keyword">if</span> (intersect == <span class="literal">null</span> || intersect.isEmpty())&#123;</span><br><span class="line">        <span class="comment">// æ— äº¤é›†</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Long&gt; ids = intersect.stream().map(Long::valueOf).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢</span></span><br><span class="line">    List&lt;UserDTO&gt; users = userService.listByIds(ids).stream()</span><br><span class="line">            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class)).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.ok(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="ğŸ‘Œå…³æ³¨æ¨é€"><a href="#ğŸ‘Œå…³æ³¨æ¨é€" class="headerlink" title="ğŸ‘Œå…³æ³¨æ¨é€"></a>ğŸ‘Œå…³æ³¨æ¨é€</h3><p>å…³æ³¨æ¨é€ä¹Ÿå«åš<code>Feed</code>æµï¼Œç›´è¯‘ä¸ºæŠ•å–‚ã€‚ä¸ºç”¨æˆ·æŒç»­çš„æä¾›â€œæ²‰æµ¸å¼â€çš„ä½“éªŒï¼Œé€šè¿‡æ— é™ä¸‹æ‹‰åˆ·æ–°è·å–æ–°çš„ä¿¡æ¯ã€‚</p>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230514192735016.png" alt="image-20230514192735016"></p>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230514192743075.png" alt="image-20230514192743075"></p>
<p><code>Feed æµ</code>çš„æ¨¡å¼</p>
<p>Feedæµäº§å“æœ‰ä¸¤ç§å¸¸è§æ¨¡å¼ï¼š<br>â— Timelineï¼šä¸åšå†…å®¹ç­›é€‰ï¼Œç®€å•çš„æŒ‰ç…§å†…å®¹å‘å¸ƒæ—¶é—´æ’åºï¼Œå¸¸ç”¨äºå¥½å‹æˆ–å…³æ³¨ã€‚ä¾‹å¦‚æœ‹å‹åœˆ</p>
<ul>
<li><p>ä¼˜ç‚¹ï¼šä¿¡æ¯å…¨é¢ï¼Œä¸ä¼šæœ‰ç¼ºå¤±ã€‚å¹¶ä¸”å®ç°ä¹Ÿç›¸å¯¹ç®€å•</p>
</li>
<li><p>ç¼ºç‚¹ï¼šä¿¡æ¯å™ªéŸ³è¾ƒå¤šï¼Œç”¨æˆ·ä¸ä¸€å®šæ„Ÿå…´è¶£ï¼Œå†…å®¹è·å–æ•ˆç‡ä½</p>
<ul>
<li>æ‹‰æ¨¡å¼ï¼šè¯»æ‰©æ•£</li>
<li>æ¨æ¨¡å¼ï¼šå†™æ‰©æ•£</li>
<li>æ¨æ‹‰ç»“åˆï¼š</li>
</ul>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230514194402346.png" alt="image-20230514194402346"></p>
</li>
</ul>
<p>â— æ™ºèƒ½æ’åºï¼šåˆ©ç”¨æ™ºèƒ½ç®—æ³•å±è”½æ‰è¿è§„çš„ã€ç”¨æˆ·ä¸æ„Ÿå…´è¶£çš„å†…å®¹ã€‚æ¨é€ç”¨æˆ·æ„Ÿå…´è¶£ä¿¡æ¯æ¥å¸å¼•ç”¨æˆ·</p>
<ul>
<li>ä¼˜ç‚¹ï¼šæŠ•å–‚ç”¨æˆ·æ„Ÿå…´è¶£ä¿¡æ¯ï¼Œç”¨æˆ·ç²˜åº¦å¾ˆé«˜ï¼Œå®¹æ˜“æ²‰è¿·</li>
<li>ç¼ºç‚¹ï¼šå¦‚æœç®—æ³•ä¸ç²¾å‡†ï¼Œå¯èƒ½èµ·åˆ°åä½œç”¨</li>
</ul>
<hr>
<p><strong>æ¡ˆä¾‹ åŸºäºæ¨æ¨¡å¼å®ç°å…³æ³¨æ¨é€åŠŸèƒ½</strong><br>éœ€æ±‚ï¼š<br>â‘ ä¿®æ”¹æ–°å¢æ¢åº—ç¬”è®°çš„ä¸šåŠ¡ï¼Œåœ¨ä¿å­˜blogåˆ°æ•°æ®åº“çš„åŒæ—¶ï¼Œæ¨é€åˆ°ç²‰ä¸çš„æ”¶ä»¶ç®±</p>
<p>â‘¡æ”¶ä»¶ç®±æ»¡è¶³å¯ä»¥æ ¹æ®æ—¶é—´æˆ³æ’åºï¼Œå¿…é¡»ç”¨<code>Redis</code>çš„æ•°æ®ç»“æ„å®ç°</p>
<p>â‘¢æŸ¥è¯¢æ”¶ä»¶ç®±æ•°æ®æ—¶ï¼Œå¯ä»¥å®ç°åˆ†é¡µæŸ¥è¯¢</p>
<hr>
<p><code>Feedæµ</code>çš„åˆ†é¡µé—®é¢˜</p>
<p><code>Feedæµ</code>ä¸­çš„æ•°æ®ä¼šä¸æ–­æ›´æ–°ï¼Œæ‰€ä»¥æ•°æ®çš„è§’æ ‡ä¹Ÿåœ¨å˜åŒ–ï¼Œå› æ­¤ä¸èƒ½é‡‡ç”¨ä¼ ç»Ÿçš„åˆ†é¡µæ¨¡å¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    blog.setUserId(user.getId());</span><br><span class="line">    <span class="comment">// ä¿å­˜æ¢åº—åšæ–‡</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(blog);</span><br><span class="line">    <span class="keyword">if</span> (!isSuccess) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ–°å¢å¤±è´¥&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢ç¬”è®°ä½œè€…çš„æ‰€æœ‰ç²‰ä¸</span></span><br><span class="line">    List&lt;Follow&gt; follows = followService.query().eq(<span class="string">&quot;follow_user_id&quot;</span>, user.getId()).list();</span><br><span class="line">    <span class="comment">// æ¨é€ç¬”è®°Idç»™æ‰€æœ‰ç²‰ä¸</span></span><br><span class="line">    <span class="keyword">for</span> (Follow follow : follows) &#123;</span><br><span class="line">        <span class="comment">// è·å–ç²‰ä¸Id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> follow.getUserId();</span><br><span class="line">        <span class="comment">// æ¨é€</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;feed:&quot;</span> + userId;</span><br><span class="line">        stringRedisTemplate.opsForZSet().add(key, blog.getId().toString(), System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å›id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>æ¡ˆä¾‹ å®ç°å…³æ³¨æ¨é€é¡µé¢çš„åˆ†é¡µæŸ¥è¯¢</strong><br>éœ€æ±‚ï¼šåœ¨ä¸ªäººä¸»é¡µçš„â€œå…³æ³¨â€å¡ç‰‡ä¸­ï¼ŒæŸ¥è¯¢å¹¶å±•ç¤ºæ¨é€çš„Blogä¿¡æ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogOfFollow</span><span class="params">(Long max, Integer offset)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.æŸ¥è¯¢æ”¶ä»¶ç®±</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> FEED_KEY + userId;</span><br><span class="line">    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples = stringRedisTemplate.opsForZSet()</span><br><span class="line">            .reverseRangeByScoreWithScores(key, <span class="number">0</span>, max, offset, <span class="number">2</span>);</span><br><span class="line">    <span class="comment">// éç©ºåˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (typedTuples == <span class="literal">null</span> || typedTuples.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.è§£ææ•°æ®ï¼šblogIdã€score(æ—¶é—´æˆ³)ã€offset</span></span><br><span class="line">    List&lt;Long&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(typedTuples.size());</span><br><span class="line">    <span class="type">long</span> <span class="variable">minTime</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">os</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (ZSetOperations.TypedTuple&lt;String&gt; typedTuple : typedTuples) &#123;</span><br><span class="line">        <span class="comment">// 3.1 è·å–id</span></span><br><span class="line">        ids.add(Long.valueOf(typedTuple.getValue()));</span><br><span class="line">        <span class="comment">// 3.2 è·å–åˆ†æ•°(æ—¶é—´æˆ³)</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> typedTuple.getScore().longValue();</span><br><span class="line">        <span class="keyword">if</span> (time == minTime)&#123;</span><br><span class="line">            os++;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            minTime = time;</span><br><span class="line">            os = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.æ ¹æ®idæŸ¥è¯¢blog</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    List&lt;Blog&gt; blogs = query().in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD(id, &quot;</span> + idStr + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span> (Blog blog : blogs) &#123;</span><br><span class="line">        <span class="comment">// 4.1æŸ¥è¯¢æœ‰å…³çš„ç”¨æˆ·</span></span><br><span class="line">        queryBlogUser(blog);</span><br><span class="line">        <span class="comment">// 4.2æŸ¥è¯¢æ˜¯å¦è¢«ç‚¹èµ</span></span><br><span class="line">        isBlogLiked(blog);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.å°è£…è¿”å›</span></span><br><span class="line">    <span class="type">ScrollResult</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScrollResult</span>();</span><br><span class="line">    r.setList(blogs);</span><br><span class="line">    r.setOffset(os);</span><br><span class="line">    r.setMinTime(minTime);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-é™„è¿‘çš„å•†æˆ·"><a href="#6-é™„è¿‘çš„å•†æˆ·" class="headerlink" title="6.é™„è¿‘çš„å•†æˆ·"></a>6.é™„è¿‘çš„å•†æˆ·</h2><h3 id="ğŸ‘ŒGEOæ•°æ®ç±»å‹å­¦ä¹ "><a href="#ğŸ‘ŒGEOæ•°æ®ç±»å‹å­¦ä¹ " class="headerlink" title="ğŸ‘ŒGEOæ•°æ®ç±»å‹å­¦ä¹ "></a>ğŸ‘Œ<strong>GEOæ•°æ®ç±»å‹</strong>å­¦ä¹ </h3><p>GEOå°±æ˜¯Geolocationçš„ç®€å†™å½¢å¼ï¼Œä»£è¡¨åœ°ç†åæ ‡ã€‚<code>Redis</code>åœ¨3.2ç‰ˆæœ¬ä¸­åŠ å…¥äº†å¯¹GE0çš„æ”¯æŒï¼Œå…è®¸å­˜å‚¨åœ°ç†åæ ‡ä¿¡æ¯ï¼Œå¸®<br>åŠ©æˆ‘ä»¬æ ¹æ®ç»çº¬åº¦æ¥æ£€ç´¢æ•°æ®ã€‚å¸¸è§çš„å‘½ä»¤æœ‰ï¼š</p>
<blockquote>
<p>GEOADD:æ·»åŠ ä¸€ä¸ªåœ°ç†ç©ºé—´ä¿¡æ¯ï¼ŒåŒ…å«ï¼šç»åº¦(longitude)ã€çº¬åº¦(latitude)ã€å€¼ï¼ˆmember)</p>
<p>GEODIST:è®¡ç®—æŒ‡å®šçš„ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»å¹¶è¿”å›</p>
<p>GEOHASH:å°†æŒ‡å®šmemberçš„åæ ‡è½¬ä¸ºhashå­—ç¬¦ä¸²å½¢å¼å¹¶è¿”å›</p>
<p>GEOPOS:è¿”å›æŒ‡å®šmemberçš„åæ ‡</p>
<p>GEORADIUS:æŒ‡å®šåœ†å¿ƒã€åŠå¾„ï¼Œæ‰¾åˆ°è¯¥åœ†å†…åŒ…å«çš„æ‰€æœ‰member,å¹¶æŒ‰ç…§ä¸åœ†å¿ƒä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚6.2ä»¥åå·²åºŸå¼ƒ</p>
<p>GEOSEARCH:åœ¨æŒ‡å®šèŒƒå›´å†…æœç´¢member,å¹¶æŒ‰ç…§ä¸æŒ‡å®šç‚¹ä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚èŒƒå›´å¯ä»¥æ˜¯åœ†å½¢æˆ–çŸ©å½¢ã€‚6.2.æ–°åŠŸèƒ½</p>
<p>GEOSEARCHSTORE:ä¸GEOSEARCHåŠŸèƒ½ä¸€è‡´ï¼Œä¸è¿‡å¯ä»¥æŠŠç»“æœå­˜å‚¨åˆ°ä¸€ä¸ªæŒ‡å®šçš„keyã€‚6.2.æ–°åŠŸèƒ½</p>
</blockquote>
<hr>
<p><strong>æ¡ˆä¾‹ ç»ƒä¹ <code>Redis</code>çš„GEOåŠŸèƒ½</strong><br>éœ€æ±‚ï¼š</p>
<ol>
<li>æ·»åŠ ä¸‹é¢å‡ æ¡æ•°æ®ï¼š<br>-åŒ—äº¬å—ç«™(116.378248 39.865275)<br>-åŒ—äº¬ç«™ï¼ˆ116.42803 39.903738)<br>-åŒ—äº¬è¥¿ç«™ï¼ˆ116.322287 39.893729)</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GEOADD g1 116.378248 39.865275 bjn 116.42803 39.903738 bjz 116.322287 39.893729 bjx</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>è®¡ç®—åŒ—äº¬è¥¿ç«™åˆ°åŒ—äº¬ç«™çš„è·ç¦»</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GEODIST g1 bjn bjz km</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>æœç´¢å¤©å®‰é—¨ï¼ˆ116.39790439.909005)é™„è¿‘10kmå†…çš„æ‰€æœ‰ç«è½¦ç«™ï¼Œå¹¶æŒ‰ç…§è·ç¦»å‡åºæ’åº</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GEOSEARCH g1 FROMLONLAT <span class="number">116.397904</span> <span class="number">39.909005</span> BYRADIUS <span class="number">10</span> km WITHDIST</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="ğŸ‘Œé™„è¿‘å•†æˆ·æœç´¢"><a href="#ğŸ‘Œé™„è¿‘å•†æˆ·æœç´¢" class="headerlink" title="ğŸ‘Œé™„è¿‘å•†æˆ·æœç´¢"></a><strong>ğŸ‘Œé™„è¿‘å•†æˆ·æœç´¢</strong></h3><p>åœ¨é¦–é¡µä¸­ç‚¹å‡»æŸä¸ªé¢‘é“ï¼Œå³å¯çœ‹åˆ°é¢‘é“ä¸‹çš„å•†æˆ·ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopByType</span><span class="params">(Integer typeId, Integer current, Double x, Double y)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.åˆ¤æ–­æ˜¯å¦éœ€è¦æ ¹æ®åæ ‡æŸ¥è¯¢</span></span><br><span class="line">    <span class="keyword">if</span> (x == <span class="literal">null</span> || y == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">// æ ¹æ®ç±»å‹åˆ†é¡µæŸ¥è¯¢</span></span><br><span class="line">        Page&lt;Shop&gt; page = query()</span><br><span class="line">                .eq(<span class="string">&quot;type_id&quot;</span>, typeId)</span><br><span class="line">                .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));</span><br><span class="line">        <span class="keyword">return</span> Result.ok(page.getRecords());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2.è®¡ç®—åˆ†é¡µå‚æ•° Metrics.NEUTRAL</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">from</span> <span class="operator">=</span> (current - <span class="number">1</span>) * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line">    <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> current * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line">    <span class="comment">// 3.æŸ¥è¯¢Redis,æŒ‰ç…§è·ç¦»æ’åºï¼Œåˆ†é¡µï¼Œç»“æœï¼šshopIdã€distance</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SHOP_GEO_KEY + typeId;</span><br><span class="line">    GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo()</span><br><span class="line">            .radius(key</span><br><span class="line">                    , <span class="keyword">new</span> <span class="title class_">Circle</span>(<span class="keyword">new</span> <span class="title class_">Point</span>(x, y), <span class="keyword">new</span> <span class="title class_">Distance</span>(<span class="number">5000</span>))</span><br><span class="line">                    , RedisGeoCommands.GeoRadiusCommandArgs.newGeoRadiusArgs().limit(end).includeCoordinates().includeDistance());</span><br><span class="line">    <span class="comment">// 4.è§£æå‡ºid</span></span><br><span class="line">    <span class="keyword">if</span> (results == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; content = results.getContent();</span><br><span class="line">    <span class="keyword">if</span> (content.size() &lt;= from)&#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰ä¸‹ä¸€é¡µ</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.1æˆªå–ä»fromåˆ°endçš„éƒ¨åˆ†</span></span><br><span class="line">    List&lt;Long&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(content.size());</span><br><span class="line">    Map&lt;String, Distance&gt; distanceMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(content.size());</span><br><span class="line">    content.stream().skip(from).forEach(result -&gt; &#123;</span><br><span class="line">        <span class="comment">// 4.2è·å–åº—é“ºid</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">shopIdStr</span> <span class="operator">=</span> result.getContent().getName();</span><br><span class="line">        ids.add(Long.valueOf(shopIdStr));</span><br><span class="line">        <span class="comment">// 4.3è·å–è·ç¦»</span></span><br><span class="line">        <span class="type">Distance</span> <span class="variable">distance</span> <span class="operator">=</span> result.getDistance();</span><br><span class="line">        distanceMap.put(shopIdStr,distance);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 5.æ ¹æ®idæŸ¥è¯¢Shop</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    List&lt;Shop&gt; shops = query().in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD(id, &quot;</span> + idStr + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span> (Shop shop : shops) &#123;</span><br><span class="line">        shop.setDistance(distanceMap.get(shop.getId().toString()).getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å›æ•°æ®</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shops);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-ç”¨æˆ·ç­¾åˆ°"><a href="#7-ç”¨æˆ·ç­¾åˆ°" class="headerlink" title="7.ç”¨æˆ·ç­¾åˆ°"></a>7.ç”¨æˆ·ç­¾åˆ°</h2><h3 id="ğŸ‘ŒBitMap-ç”¨æ³•"><a href="#ğŸ‘ŒBitMap-ç”¨æ³•" class="headerlink" title="ğŸ‘ŒBitMap ç”¨æ³•"></a>ğŸ‘ŒBitMap ç”¨æ³•</h3><p><code>Redis</code>ä¸­æ˜¯åˆ©ç”¨string:ç±»å‹æ•°æ®ç»“æ„å®ç°<code>BitMap</code>,å› æ­¤æœ€å¤§ä¸Šé™æ˜¯512M,è½¬æ¢ä¸ºbitåˆ™æ˜¯2^32ä¸ªbitä½ã€‚<br><code>BitMap</code>çš„æ“ä½œå‘½ä»¤æœ‰ï¼š</p>
<blockquote>
<p>SETBIT:å‘æŒ‡å®šä½ç½®ï¼ˆoffset)å­˜å…¥ä¸€ä¸ª0æˆ–1</p>
<p>GETBITï¼šè·å–æŒ‡å®šä½ç½®(offset)çš„bitå€¼</p>
<p>BITCOUNT:ç»Ÿè®¡<code>BitMap</code>ä¸­å€¼ä¸º1çš„bitä½çš„æ•°é‡</p>
<p>BITFIELD:æ“ä½œï¼ˆæŸ¥è¯¢ã€ä¿®æ”¹ã€è‡ªå¢)<code>BitMap</code>ä¸­bitæ•°ç»„ä¸­çš„æŒ‡å®šä½ç½®(offset)çš„å€¼</p>
<p>BITFIELD RO:è·å–<code>BitMap</code>ä¸­bitæ•°ç»„ï¼Œå¹¶ä»¥åè¿›åˆ¶å½¢å¼è¿”å›</p>
<p>BITOP:å°†å¤šä¸ª<code>BitMap</code>çš„ç»“æœåšä½è¿ç®—ï¼ˆä¸ã€æˆ–ã€å¼‚æˆ–ï¼‰</p>
<p>BITPOS:æŸ¥æ‰¾<code>bit</code>æ•°ç»„ä¸­æŒ‡å®šèŒƒå›´å†…ç¬¬ä¸€ä¸ª0æˆ–1å‡ºç°çš„ä½ç½®</p>
</blockquote>
<h3 id="ğŸ‘Œç­¾åˆ°åŠŸèƒ½"><a href="#ğŸ‘Œç­¾åˆ°åŠŸèƒ½" class="headerlink" title="ğŸ‘Œç­¾åˆ°åŠŸèƒ½"></a>ğŸ‘Œç­¾åˆ°åŠŸèƒ½</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.è·å–æ—¥æœŸ</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">// 3.æ‹¼æ¥key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">keySuffix</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">// 4.è·å–day</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dayOfMonth</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">    <span class="comment">// 5.å†™å…¥Redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ğŸ‘Œç­¾åˆ°ç»Ÿè®¡"><a href="#ğŸ‘Œç­¾åˆ°ç»Ÿè®¡" class="headerlink" title="ğŸ‘Œç­¾åˆ°ç»Ÿè®¡"></a>ğŸ‘Œç­¾åˆ°ç»Ÿè®¡</h3><p><strong>é—®é¢˜1ï¼šä»€ä¹ˆå«åšè¿ç»­ç­¾åˆ°å¤©æ•°ï¼Ÿ</strong><br>ä»æœ€åä¸€æ¬¡ç­¾åˆ°å¼€å§‹<strong>å‘å‰</strong>ç»Ÿè®¡ï¼Œç›´åˆ°é‡åˆ°<strong>ç¬¬ä¸€æ¬¡</strong>æœªç­¾åˆ°ä¸ºæ­¢ï¼Œè®¡ç®—æ€»çš„ç­¾åˆ°æ¬¡æ•°ï¼Œå°±æ˜¯è¿ç»­ç­¾åˆ°å¤©æ•°ã€‚</p>
<p><strong>é—®é¢˜2ï¼šå¦‚ä½•å¾—åˆ°æœ¬æœˆåˆ°ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰ç­¾åˆ°æ•°æ®ï¼Ÿ</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BITFIELD key GET u[dayOfMonth ]0</span><br></pre></td></tr></table></figure>

<p><strong>é—®é¢˜3ï¼šå¦‚ä½•ä»åå‘å‰éå†æ¯ä¸ªbitä½ï¼Ÿ</strong><br>ä¸1åšä¸è¿ç®—ï¼Œå°±èƒ½å¾—åˆ°æœ€åä¸€ä¸ªbitä½ã€‚<br>éšåå³ç§»1ä½ï¼Œä¸‹ä¸€ä¸ªbitä½å°±æˆä¸ºäº†æœ€åä¸€ä¸ªbitä½ã€‚</p>
<hr>
<p><strong>æ¡ˆä¾‹ å®ç°ç­¾åˆ°ç»Ÿè®¡åŠŸèƒ½</strong><br>éœ€æ±‚ï¼šå®ç°ä¸‹é¢æ¥å£ï¼Œç»Ÿè®¡å½“å‰ç”¨æˆ·æˆªæ­¢å½“å‰æ—¶é—´åœ¨æœ¬æœˆçš„è¿ç»­ç­¾åˆ°å¤©æ•°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">signCount</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.è·å–æ—¥æœŸ</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">// 3.æ‹¼æ¥key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">keySuffix</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">// 4.è·å–day</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dayOfMonth</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">    <span class="comment">// 5.è·å–æˆªæ­¢åˆ°ä»Šå¤©çš„æ‰€æœ‰ç­¾åˆ°è®°å½•ï¼Œè¿”å›åè¿›åˆ¶æ•°å­—</span></span><br><span class="line">    List&lt;Long&gt; result = stringRedisTemplate.opsForValue().bitField(key,</span><br><span class="line">            BitFieldSubCommands.create()</span><br><span class="line">                    .get(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth))</span><br><span class="line">                    .valueAt(<span class="number">0</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span> || result.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">num</span> <span class="operator">=</span> result.get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (num == <span class="literal">null</span> || num == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6.å¾ªç¯éå†</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="comment">// 6.1 ä¸1ä½œä¸è¿ç®—ï¼Œå¾—åˆ°æœ€åä¸€ä¸ªbitä½</span></span><br><span class="line">        <span class="comment">// 6.2 åˆ¤æ–­è¿™ä¸ªbitä½æ˜¯å¦ä¸º0</span></span><br><span class="line">        <span class="keyword">if</span> ((num &amp; <span class="number">1</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">// 6.3 å¦‚æœä¸º0ï¼Œè¯´æ˜æœªç­¾åˆ°ï¼Œç»“æŸ</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 6.4 ä¸ä¸º0ï¼Œè¯´æ˜å·²ç­¾åˆ°ï¼Œè®¡æ•°å™¨+1</span></span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æŠŠæ•°å­—å³ç§»ä¸€ä½ï¼ŒæŠ›å¼ƒæœ€åä¸€ä¸ªbitä½ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªbitä½</span></span><br><span class="line">        num &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-UVç»Ÿè®¡"><a href="#8-UVç»Ÿè®¡" class="headerlink" title="8.UVç»Ÿè®¡"></a>8.UVç»Ÿè®¡</h2><h3 id="HyperLogLogç”¨æ³•"><a href="#HyperLogLogç”¨æ³•" class="headerlink" title="HyperLogLogç”¨æ³•"></a><code>HyperLogLog</code>ç”¨æ³•</h3><p>é¦–å…ˆæˆ‘ä»¬ææ‡‚ä¸¤ä¸ªæ¦‚å¿µï¼š</p>
<ul>
<li><strong>UV</strong>ï¼šå…¨ç§°<code>Unique Visitor</code>,ä¹Ÿå«ç‹¬ç«‹è®¿å®¢é‡ï¼Œæ˜¯æŒ‡é€šè¿‡äº’è”ç½‘è®¿é—®ã€æµè§ˆè¿™ä¸ªç½‘é¡µçš„è‡ªç„¶äººã€‚Iå¤©å†…åŒä¸€ä¸ªç”¨æˆ·å¤šæ¬¡è®¿<br>é—®è¯¥ç½‘ç«™ï¼Œåªè®°å½•1æ¬¡ã€‚</li>
<li><strong>PV</strong>ï¼šå…¨ç§°<code>Page View</code>,ä¹Ÿå«é¡µé¢è®¿é—®é‡æˆ–ç‚¹å‡»é‡ï¼Œç”¨æˆ·æ¯è®¿é—®ç½‘ç«™çš„ä¸€ä¸ªé¡µé¢ï¼Œè®°å½•1æ¬¡PV,ç”¨æˆ·å¤šæ¬¡æ‰“å¼€é¡µé¢ï¼Œåˆ™<br>è®°å½•å¤šæ¬¡PVã€‚å¾€å¾€ç”¨æ¥è¡¡é‡ç½‘ç«™çš„æµé‡ã€‚</li>
</ul>
<hr>
<p><code>Hyperloglog</code>(HLL)æ˜¯ä»Loglogç®—æ³•æ´¾ç”Ÿçš„æ¦‚ç‡ç®—æ³•ï¼Œç”¨äºç¡®å®šéå¸¸å¤§çš„é›†åˆçš„åŸºæ•°ï¼Œè€Œä¸éœ€è¦å­˜å‚¨å…¶æ‰€æœ‰å€¼ã€‚ç›¸å…³ç®—æ³•<br>åŸç†å¤§å®¶å¯ä»¥å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903785744056333#heading-0">HyperLogLog ç®—æ³•çš„åŸç†è®²è§£ä»¥åŠ Redis æ˜¯å¦‚ä½•åº”ç”¨å®ƒçš„ - æ˜é‡‘ (juejin.cn)</a></p>
<p><code>Redis</code>ä¸­çš„HLLæ˜¯åŸºäºstringç»“æ„å®ç°çš„ï¼Œå•ä¸ªHLLçš„å†…å­˜æ°¸è¿œå°äº16kb,å†…å­˜å ç”¨ä½çš„ä»¤äººå‘æŒ‡ï¼ä½œä¸ºä»£ä»·ï¼Œå…¶æµ‹é‡ç»“æœ<br>æ˜¯æ¦‚ç‡æ€§çš„ï¼Œæœ‰å°äº0.81%çš„è¯¯å·®ã€‚ä¸è¿‡å¯¹äºUVç»Ÿè®¡æ¥è¯´ï¼Œè¿™å®Œå…¨å¯ä»¥å¿½ç•¥ã€‚</p>
<p><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/image-20230517223852581.png" alt="image-20230517223852581"></p>
<hr>
<h3 id="å®ç°UVç»Ÿè®¡"><a href="#å®ç°UVç»Ÿè®¡" class="headerlink" title="å®ç°UVç»Ÿè®¡"></a>å®ç°UVç»Ÿè®¡</h3><p>æˆ‘ä»¬ç›´æ¥åˆ©ç”¨å•å…ƒæµ‹è¯•ï¼Œå‘HyperL0gL0gä¸­æ·»åŠ 100ä¸‡æ¡æ•°æ®ï¼Œçœ‹çœ‹å†…å­˜å ç”¨å’Œç»Ÿè®¡æ•ˆæœå¦‚ä½•ï¼š</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://fash.flyone.space">Flyone</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://fash.flyone.space/%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84/">https://fash.flyone.space/%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://fash.flyone.space" target="_blank">Fly one</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Redis/">Redis</a></div><div class="post_share"><div class="social-share" data-image="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/wallhaven-yxgyyx_3840x2880.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E03/"><img class="prev-cover" src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/wallhaven-yxgyyx_3840x2880.png" onerror="onerror=null;src='https://bed.flyone.space/%E7%AC%94%E8%AE%B0/wallhaven-yxgyyx_3840x2880.png'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">åˆ†å¸ƒå¼æœç´¢å¼•æ“-03</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/QQ%E5%9B%BE%E7%89%8720210716180135.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Flyone</div><div class="author-info__description">è¿™é‡Œæ˜¯Flyoneçš„ä¸ªäººåšå®¢</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">8</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">2</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>GitHub</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/flyono" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://blog.flyone.space/404.html" target="_blank" title="1508948470@qq.com"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/416610378?spm_id_from=333.1007.0.0" target="_blank" title="bilibili"><i class="fa-brands fa-bilibili"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">2022å¹´11æœˆ27æ—¥ æ›´æ–°äº†æˆ‘çš„æ¯æ—¥è®¡åˆ’</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84"><span class="toc-number">1.</span> <span class="toc-text">é»‘é©¬ç‚¹è¯„</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%9F%AD%E4%BF%A1%E7%99%BB%E5%BD%95"><span class="toc-number">1.1.</span> <span class="toc-text">1.çŸ­ä¿¡ç™»å½•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9E%84%E5%BB%BA"><span class="toc-number">1.1.1.</span> <span class="toc-text">ğŸ‘Œæ•°æ®åº“æ„å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.2.</span> <span class="toc-text">ğŸ‘Œæ•´ä½“æ¶æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E5%AF%BC%E5%85%A5%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.1.3.</span> <span class="toc-text">ğŸ‘Œå¯¼å…¥åç«¯é¡¹ç›®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E5%AF%BC%E5%85%A5%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.1.4.</span> <span class="toc-text">ğŸ‘Œå¯¼å…¥å‰ç«¯é¡¹ç›®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E5%9F%BA%E4%BA%8ESession%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95"><span class="toc-number">1.1.5.</span> <span class="toc-text">ğŸ‘ŒåŸºäºSessionå®ç°ç™»å½•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E9%AA%8C%E8%AF%81%E7%A0%81%E5%8A%9F%E8%83%BD"><span class="toc-number">1.1.5.1.</span> <span class="toc-text">å‘é€éªŒè¯ç åŠŸèƒ½</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%A0%81%E7%99%BB%E5%BD%95%E5%92%8C%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD"><span class="toc-number">1.1.5.2.</span> <span class="toc-text">çŸ­ä¿¡éªŒè¯ç ç™»å½•å’Œæ³¨å†ŒåŠŸèƒ½</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81-x2F-%E9%9A%90%E8%97%8F%E7%94%A8%E6%88%B7%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF"><span class="toc-number">1.1.5.3.</span> <span class="toc-text">ç™»å½•éªŒè¯ &#x2F; éšè—ç”¨æˆ·æ•æ„Ÿä¿¡æ¯</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%B0%E5%BE%97%E7%BB%99%E9%85%8D%E7%BD%AE%E7%B1%BB%E5%8A%A0%E4%B8%8A%E6%B3%A8%E8%A7%A3"><span class="toc-number">2.</span> <span class="toc-text">è®°å¾—ç»™é…ç½®ç±»åŠ ä¸Šæ³¨è§£</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E7%9A%84session%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98"><span class="toc-number">2.0.0.1.</span> <span class="toc-text">é›†ç¾¤çš„sessionå…±äº«é—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E5%9F%BA%E4%BA%8ERedis%E5%AE%9E%E7%8E%B0%E5%85%B1%E4%BA%ABsession%E7%99%BB%E5%BD%95"><span class="toc-number">2.0.1.</span> <span class="toc-text">ğŸ‘ŒåŸºäºRediså®ç°å…±äº«sessionç™»å½•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">2.0.1.1.</span> <span class="toc-text">å‘é€éªŒè¯ç </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%A0%81%E7%99%BB%E5%BD%95%E5%92%8C%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD-1"><span class="toc-number">2.0.1.2.</span> <span class="toc-text">çŸ­ä¿¡éªŒè¯ç ç™»å½•å’Œæ³¨å†ŒåŠŸèƒ½</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81"><span class="toc-number">2.0.1.3.</span> <span class="toc-text">ç™»å½•éªŒè¯</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Result%E7%B1%BB%E4%B8%AD%E4%B8%8D%E8%A6%81%E5%9C%A8%E6%B7%BB%E5%8A%A0%E8%BF%94%E5%9B%9EMsg%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-number">2.1.</span> <span class="toc-text">Resultç±»ä¸­ä¸è¦åœ¨æ·»åŠ è¿”å›Msgæ„é€ æ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA%E5%99%A8%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-number">2.1.0.1.</span> <span class="toc-text">ç™»å½•æ‹¦æˆªå™¨çš„ä¼˜åŒ–</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%95%86%E6%88%B7%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98"><span class="toc-number">2.2.</span> <span class="toc-text">2.å•†æˆ·æŸ¥è¯¢ç¼“å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%92%A5%E4%BB%80%E4%B9%88%E6%98%AF%E7%BC%93%E5%AD%98"><span class="toc-number">2.2.1.</span> <span class="toc-text">ğŸ’¥ä»€ä¹ˆæ˜¯ç¼“å­˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E6%B7%BB%E5%8A%A0Redis%E7%BC%93%E5%AD%98"><span class="toc-number">2.2.2.</span> <span class="toc-text">ğŸ‘Œæ·»åŠ Redisç¼“å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-%E7%BB%99%E5%BA%97%E9%93%BA%E7%B1%BB%E5%9E%8B%E6%9F%A5%E8%AF%A2%E4%B8%9A%E5%8A%A1%E6%B7%BB%E5%8A%A0%E7%BC%93%E5%AD%98"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">ç»ƒä¹ :ç»™åº—é“ºç±»å‹æŸ¥è¯¢ä¸šåŠ¡æ·»åŠ ç¼“å­˜</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%92%A5%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5"><span class="toc-number">2.2.3.</span> <span class="toc-text">ğŸ’¥ç¼“å­˜æ›´æ–°ç­–ç•¥</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">æ€»ç»“</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%97%86%E8%AF%BB%E6%93%8D%E4%BD%9C%EF%BC%9A"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">â—†è¯»æ“ä½œï¼š</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%91%BD%E4%B8%AD%E5%88%99%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E"><span class="toc-number">2.2.3.2.1.</span> <span class="toc-text">ç¼“å­˜å‘½ä¸­åˆ™ç›´æ¥è¿”å›</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%9C%AA%E5%91%BD%E4%B8%AD%E5%88%99%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%B9%B6%E5%86%99%E5%85%A5%E7%BC%93%E5%AD%98%EF%BC%8C%E8%AE%BE%E5%AE%9A%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4"><span class="toc-number">2.2.3.2.2.</span> <span class="toc-text">ç¼“å­˜æœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶å†™å…¥ç¼“å­˜ï¼Œè®¾å®šè¶…æ—¶æ—¶é—´</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%97%86%E5%86%99%E6%93%8D%E4%BD%9C%EF%BC%9A"><span class="toc-number">2.2.3.3.</span> <span class="toc-text">â—†å†™æ“ä½œï¼š</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E7%84%B6%E5%90%8E%E5%86%8D%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98"><span class="toc-number">2.2.3.3.1.</span> <span class="toc-text">å…ˆå†™æ•°æ®åº“ï¼Œç„¶åå†åˆ é™¤ç¼“å­˜</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A6%81%E7%A1%AE%E4%BF%9D%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8E%E7%BC%93%E5%AD%98%E6%93%8D%E4%BD%9C%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7"><span class="toc-number">2.2.3.3.2.</span> <span class="toc-text">è¦ç¡®ä¿æ•°æ®åº“ä¸ç¼“å­˜æ“ä½œçš„åŸå­æ€§</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">2.2.3.4.</span> <span class="toc-text">æ¡ˆä¾‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-number">2.2.4.</span> <span class="toc-text">ğŸ‘Œç¼“å­˜ç©¿é€</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-number">2.2.4.1.</span> <span class="toc-text">æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="toc-number">2.2.5.</span> <span class="toc-text">ğŸ‘Œç¼“å­˜é›ªå´©</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="toc-number">2.2.6.</span> <span class="toc-text">ğŸ‘Œç¼“å­˜å‡»ç©¿</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B-1"><span class="toc-number">2.2.6.1.</span> <span class="toc-text">æ¡ˆä¾‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E7%BC%93%E5%AD%98%E5%B7%A5%E5%85%B7%E5%B0%81%E8%A3%85"><span class="toc-number">2.2.7.</span> <span class="toc-text">ğŸ‘Œç¼“å­˜å·¥å…·å°è£…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80"><span class="toc-number">2.3.</span> <span class="toc-text">3.ä¼˜æƒ åˆ¸ç§’æ€</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80ID"><span class="toc-number">2.3.1.</span> <span class="toc-text">ğŸ‘Œå…¨å±€å”¯ä¸€ID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E5%AE%9E%E7%8E%B0%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80%E4%B8%8B%E5%8D%95"><span class="toc-number">2.3.2.</span> <span class="toc-text">ğŸ‘Œå®ç°ä¼˜æƒ åˆ¸ç§’æ€ä¸‹å•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E8%B6%85%E5%8D%96%E9%97%AE%E9%A2%98"><span class="toc-number">2.3.3.</span> <span class="toc-text">ğŸ‘Œè¶…å–é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95"><span class="toc-number">2.3.4.</span> <span class="toc-text">ğŸ‘Œä¸€äººä¸€å•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">2.3.5.</span> <span class="toc-text">ğŸ‘Œåˆ†å¸ƒå¼é”</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Redisson"><span class="toc-number">2.3.5.1.</span> <span class="toc-text">Redisson</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8CRedis%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96"><span class="toc-number">2.3.6.</span> <span class="toc-text">ğŸ‘ŒRedisç§’æ€ä¼˜åŒ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8CRedisi%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E7%A7%92%E6%9D%80"><span class="toc-number">2.3.7.</span> <span class="toc-text">ğŸ‘ŒRedisiæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ç§’æ€</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%BE%BE%E4%BA%BA%E6%8E%A2%E5%BA%97"><span class="toc-number">2.4.</span> <span class="toc-text">4.è¾¾äººæ¢åº—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E5%8F%91%E5%B8%83%E6%8E%A2%E5%BA%97%E7%85%A7%E7%89%87"><span class="toc-number">2.4.1.</span> <span class="toc-text">ğŸ‘Œå‘å¸ƒæ¢åº—ç…§ç‰‡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E7%82%B9%E8%B5%9E"><span class="toc-number">2.4.2.</span> <span class="toc-text">ğŸ‘Œç‚¹èµ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E7%82%B9%E8%B5%9E%E6%8E%92%E8%A1%8C%E6%A6%9C"><span class="toc-number">2.4.3.</span> <span class="toc-text">ğŸ‘Œç‚¹èµæ’è¡Œæ¦œ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8"><span class="toc-number">2.5.</span> <span class="toc-text">5.å¥½å‹å…³æ³¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E5%85%B3%E6%B3%A8%E4%B8%8E%E5%8F%96%E5%85%B3"><span class="toc-number">2.5.1.</span> <span class="toc-text">ğŸ‘Œå…³æ³¨ä¸å–å…³</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E5%85%B1%E5%90%8C%E5%85%B3%E6%B3%A8"><span class="toc-number">2.5.2.</span> <span class="toc-text">ğŸ‘Œå…±åŒå…³æ³¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E5%85%B3%E6%B3%A8%E6%8E%A8%E9%80%81"><span class="toc-number">2.5.3.</span> <span class="toc-text">ğŸ‘Œå…³æ³¨æ¨é€</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E9%99%84%E8%BF%91%E7%9A%84%E5%95%86%E6%88%B7"><span class="toc-number">2.6.</span> <span class="toc-text">6.é™„è¿‘çš„å•†æˆ·</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8CGEO%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%AD%A6%E4%B9%A0"><span class="toc-number">2.6.1.</span> <span class="toc-text">ğŸ‘ŒGEOæ•°æ®ç±»å‹å­¦ä¹ </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7%E6%90%9C%E7%B4%A2"><span class="toc-number">2.6.2.</span> <span class="toc-text">ğŸ‘Œé™„è¿‘å•†æˆ·æœç´¢</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E7%94%A8%E6%88%B7%E7%AD%BE%E5%88%B0"><span class="toc-number">2.7.</span> <span class="toc-text">7.ç”¨æˆ·ç­¾åˆ°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8CBitMap-%E7%94%A8%E6%B3%95"><span class="toc-number">2.7.1.</span> <span class="toc-text">ğŸ‘ŒBitMap ç”¨æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E7%AD%BE%E5%88%B0%E5%8A%9F%E8%83%BD"><span class="toc-number">2.7.2.</span> <span class="toc-text">ğŸ‘Œç­¾åˆ°åŠŸèƒ½</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%91%8C%E7%AD%BE%E5%88%B0%E7%BB%9F%E8%AE%A1"><span class="toc-number">2.7.3.</span> <span class="toc-text">ğŸ‘Œç­¾åˆ°ç»Ÿè®¡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-UV%E7%BB%9F%E8%AE%A1"><span class="toc-number">2.8.</span> <span class="toc-text">8.UVç»Ÿè®¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HyperLogLog%E7%94%A8%E6%B3%95"><span class="toc-number">2.8.1.</span> <span class="toc-text">HyperLogLogç”¨æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0UV%E7%BB%9F%E8%AE%A1"><span class="toc-number">2.8.2.</span> <span class="toc-text">å®ç°UVç»Ÿè®¡</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E02/" title="åˆ†å¸ƒå¼æœç´¢å¼•æ“-02"><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/wallhaven-yxgyyx_3840x2880.png" onerror="this.onerror=null;this.src='https://bed.flyone.space/%E7%AC%94%E8%AE%B0/wallhaven-yxgyyx_3840x2880.png'" alt="åˆ†å¸ƒå¼æœç´¢å¼•æ“-02"/></a><div class="content"><a class="title" href="/%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E02/" title="åˆ†å¸ƒå¼æœç´¢å¼•æ“-02">åˆ†å¸ƒå¼æœç´¢å¼•æ“-02</a><time datetime="2023-05-27T10:29:35.000Z" title="å‘è¡¨äº 2023-05-27 18:29:35">2023-05-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/%E5%AE%89%E8%A3%85elasticsearch/" title="å®‰è£…elasticsearchæ•™ç¨‹"><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/wallhaven-yxgyyx_3840x2880.png" onerror="this.onerror=null;this.src='https://bed.flyone.space/%E7%AC%94%E8%AE%B0/wallhaven-yxgyyx_3840x2880.png'" alt="å®‰è£…elasticsearchæ•™ç¨‹"/></a><div class="content"><a class="title" href="/%E5%AE%89%E8%A3%85elasticsearch/" title="å®‰è£…elasticsearchæ•™ç¨‹">å®‰è£…elasticsearchæ•™ç¨‹</a><time datetime="2023-05-27T10:27:16.000Z" title="å‘è¡¨äº 2023-05-27 18:27:16">2023-05-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/SpringCloud%E5%AE%9E%E7%94%A8%E7%AF%8702/" title="SpringCloud-02"><img src="https://cdn.jsdelivr.net/gh/flyono/Chart-bed@main/img/2560_1600.png" onerror="this.onerror=null;this.src='https://bed.flyone.space/%E7%AC%94%E8%AE%B0/wallhaven-yxgyyx_3840x2880.png'" alt="SpringCloud-02"/></a><div class="content"><a class="title" href="/SpringCloud%E5%AE%9E%E7%94%A8%E7%AF%8702/" title="SpringCloud-02">SpringCloud-02</a><time datetime="2023-05-27T10:20:12.000Z" title="å‘è¡¨äº 2023-05-27 18:20:12">2023-05-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/SpringCloud01/" title="SpringCloud-01"><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/wallhaven-yxgyyx_3840x2880.png" onerror="this.onerror=null;this.src='https://bed.flyone.space/%E7%AC%94%E8%AE%B0/wallhaven-yxgyyx_3840x2880.png'" alt="SpringCloud-01"/></a><div class="content"><a class="title" href="/SpringCloud01/" title="SpringCloud-01">SpringCloud-01</a><time datetime="2023-05-27T10:16:41.000Z" title="å‘è¡¨äº 2023-05-27 18:16:41">2023-05-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E01/" title="elasticsearchåŸºç¡€æ•™ç¨‹-01"><img src="https://bed.flyone.space/%E7%AC%94%E8%AE%B0/wallhaven-yxgyyx_3840x2880.png" onerror="this.onerror=null;this.src='https://bed.flyone.space/%E7%AC%94%E8%AE%B0/wallhaven-yxgyyx_3840x2880.png'" alt="elasticsearchåŸºç¡€æ•™ç¨‹-01"/></a><div class="content"><a class="title" href="/%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E01/" title="elasticsearchåŸºç¡€æ•™ç¨‹-01">elasticsearchåŸºç¡€æ•™ç¨‹-01</a><time datetime="2023-05-26T16:00:00.000Z" title="å‘è¡¨äº 2023-05-27 00:00:00">2023-05-27</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://bed.flyone.space/%E7%AC%94%E8%AE%B0/wallhaven-10qjqn_2560x1080.png')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2024 By Flyone</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="http://beian.miit.gov.cn"><span>å¤‡æ¡ˆå·ï¼šæ¸ICPå¤‡2022010213å·</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><div class="aplayer no-destroy" data-id="7422861869" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true" data-lrcType="-1"> </div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="Flyone,æ¬¢è¿,æ‚¨" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>